<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">
  <title>ç§»åŠ¨ç«¯äº§å“ç›®å½•</title>
  <!-- CloudBase Web SDK -->
  <script src="https://static.cloudbase.net/cloudbase-js-sdk/2.17.3/cloudbase.full.js"></script>
  <!-- CloudBase é…ç½® -->
  <script src="./cloudbase.config.js"></script>
  <style>
    :root{--bg:#f7f7f8;--card:#fff;--accent:#ff6b6b;--muted:#888;--modal-close-size:56px;--modal-close-bg:var(--accent);--modal-close-color:#fff;--modal-close-bottom:24px}
    html,body{height:100%;margin:0;font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial; background:var(--bg); color:#222}
    .app{display:flex;flex-direction:row;height:100vh;max-height:100vh;overflow:hidden}
    .sidebar{width:24%;min-width:104px;max-width:200px;background:linear-gradient(#fff,#fafafa);border-right:1px solid #eee;overflow:auto;position:sticky;top:0;height:100vh}
    .sidebar .search{position: sticky; top: 0; z-index: 2; padding:10px; background: linear-gradient(#fff,#fafafa); border-bottom: 1px solid #eee;}
    .category-list{list-style:none;padding:0;margin:0}
    .category-item{padding:12px 10px;border-bottom:1px solid #f0f0f0;cursor:pointer;display:flex;align-items:center}
    .category-item.active{background:linear-gradient(90deg, rgba(255,107,107,0.06), transparent);font-weight:600;color:var(--accent)}
    .category-item .label{flex:1 1 auto;min-width:0;white-space:normal;word-break:break-word}
    .category-item .badge{margin-left:auto;background:#eee;padding:4px 8px;border-radius:12px;font-size:12px;color:var(--muted)}
    .content{flex:1;overflow:auto;padding:8px}
    .topbar{position: sticky; top: 0; z-index: 20; display:flex;align-items:center;gap:8px;padding:8px; background: linear-gradient(#fff,#fafafa); border-bottom: 1px solid #eee}
    .topbar.scrolled{ box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:8px;padding:8px}
    .card{background:var(--card);border-radius:12px;padding:8px;box-shadow:0 4px 12px rgba(0,0,0,0.08);display:flex;flex-direction:column;transition: transform .2s cubic-bezier(.2,.8,.2,1), box-shadow .25s ease}
    .card:hover, .card:active{ box-shadow: 0 8px 24px rgba(0,0,0,0.12); transform: translateY(-1px) scale(1.01); }
    .card .img{height:110px;border-radius:8px;background:linear-gradient(180deg,#eee,#ddd);display:flex;align-items:center;justify-content:center;font-size:12px;color:#999}
    .card .name{margin-top:8px;font-size:14px;line-height:1.2;height:2.6em;overflow:hidden}
    .card .desc{font-size:12px;color:var(--muted);height:1.6em;overflow:hidden;margin-top:6px}
    .card .price-row{display:flex;align-items:center;justify-content:space-between;margin-top:8px}
    .price{font-weight:700;color:var(--accent)}
    .add-btn{background:var(--accent);color:#fff;border:none;padding:6px 10px;border-radius:8px;font-weight:600}
    @media(max-width:720px){.sidebar{width:30%;min-width:90px}.grid{grid-template-columns:repeat(2,1fr)}}
    @media(max-width:540px){.grid{grid-template-columns:1fr}}
    @media(max-width:420px){.app{flex-direction:row}.sidebar{order:1;width:36%;min-width:100px;max-width:160px;border-right:1px solid #eee;border-top:none}.content{order:2}.grid{grid-template-columns:1fr}.category-item{padding:10px 10px}.category-item .label{font-size:13px;line-height:1.25;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}.category-item .badge{font-size:11px;padding:2px 6px}}
    .empty{padding:30px;text-align:center;color:var(--muted)}
      /* åˆ†ç±» Banner æ ·å¼ */
      .category-banner { position: relative; width: 100%; aspect-ratio: 4 / 1; min-height: 90px; border-radius: 12px; overflow: hidden; background: linear-gradient(135deg, #6ea2ff 0%, #46d9a6 100%); margin: 12px 0 16px; }
      .category-banner .title-overlay { position: absolute; left: 16px; top: 12px; color: #fff; font-size: 18px; font-weight: 700; text-shadow: 0 2px 6px rgba(0,0,0,0.35); }
      @media(min-width: 768px){ .category-banner { min-height: 130px; } .category-banner .title-overlay { font-size: 22px; } }
      @media(max-width: 420px){ .category-banner .title-overlay { font-size: 16px; } }
      /* éšè—æ—§çš„çº¯æ–‡æœ¬æ ‡é¢˜ï¼Œæ”¹ç”¨è¦†ç›–åœ¨ Banner ä¸Šçš„æ ‡é¢˜ */
      #categoryTitle { display: none; }
    
      /* è¯¦æƒ…æŒ‰é’®å……æ»¡æ•´å¡ç‰‡å®½åº¦ */
      .price-row { display: flex; flex-direction: column; gap: 8px; align-items: stretch; }
      .add-btn { display: block; width: 100%; box-sizing: border-box; }

      /* å¹³æ»‘æ»šåŠ¨åé¦ˆ */
      .sidebar, .content { scroll-behavior: smooth; }
      /* ä¾§æ è¿”å›é¡¶éƒ¨åŒºåŸŸä¸æŒ‰é’® */
      .sidebar-actions { position: sticky; bottom: 8px; padding: 8px; background: linear-gradient(#fff,#fafafa); border-top: 1px solid #eee; }
      .sidebar-actions .backtop-btn { width: 100%; padding: 10px 12px; border-radius: 999px; border: none; background: var(--accent); color: #fff; font-weight: 700; box-shadow: 0 3px 10px rgba(0,0,0,0.12); cursor: pointer; }
  </style>
</head>
<body>
  <div class="app">
    <aside class="sidebar">
      <div class="search">
        <input id="categorySearch" placeholder="æœç´¢åˆ†ç±»" style="width:100%;padding:8px;border-radius:8px;border:1px solid #eee;box-sizing:border-box">
      </div>
      <ul class="category-list" id="categoryList"></ul>
      <!-- è¿”å›é¡¶éƒ¨å®¹å™¨ï¼ˆJS ä¼šå¡«å……æŒ‰é’®ï¼‰ -->
      <div id="sidebarActions" class="sidebar-actions" style="display:none"></div>
    </aside>

    <main class="content">
      <div class="topbar">
        <div class="title" id="categoryTitle">å…¨éƒ¨å•†å“</div>
        <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
          <input id="productSearch" placeholder="æœç´¢å•†å“" style="padding:6px 8px;border-radius:8px;border:1px solid #eee">
        </div>
      </div>
      <div id="productGrid" class="grid"></div>
      <div id="emptyState" class="empty" style="display:none">æ²¡æœ‰æ‰¾åˆ°å•†å“ã€‚</div>
    </main>
  </div>

  <script>
    // ä»…ä½¿ç”¨å¤–éƒ¨ JSON æ•°æ®
    // å¯åˆ‡æ¢ä¸º CloudBase æ•°æ®åº“åŠ è½½
    // æœ¬åœ°å…œåº•
    const FETCH_URL = './data/products.json'; // æœ¬åœ°å…œåº•
    const BRAND_DICTIONARY_URL = './data/brand_dictionary.json';
    const CATEGORY_DICTIONARY_URL = './data/category_dictionary.json';
    
    // å¾®ä¿¡äº‘æ‰˜ç®¡é™æ€èµ„æºå­˜å‚¨é…ç½®
    const STATIC_STORAGE_BASE_URL = 'https://jiemingda-0g8ddwgk28c2ff66.ap-shanghai.wxcloudrun.com';
    // CloudBase ç¯å¢ƒé…ç½®
    const config = window.CLOUDBASE_CONFIG || {};
    const CLOUDBASE_ENV = window.CLOUDBASE_ENV || localStorage.getItem('CLOUDBASE_ENV') || config.envId || '';
    const USE_CLOUDBASE = !!CLOUDBASE_ENV;
     const CONFIG_URL = './data/category_config.json';
     let CATEGORY_BANNER_SLUGS = {};
     let CATEGORY_SHORT_NAMES = {};
     let CATEGORY_CONFIG = [];
     let BRAND_DICTIONARY = {};
     let CATEGORY_DICTIONARY = {};

    let DATA = {categories: []}; let activeCategoryIndex = 0;

    // è¯¦æƒ…å¼¹å±‚
    const modal = document.createElement('div');
    Object.assign(modal.style, {position:'fixed',inset:'0',background:'rgba(0,0,0,0.35)',display:'none',alignItems:'center',justifyContent:'center',zIndex:'9999'});
    modal.innerHTML = `<div id="detailCard" style="background:#fff;border-radius:12px;max-width:520px;width:92%;padding:16px;box-shadow:0 6px 24px rgba(0,0,0,0.12)">
      <div style="display:flex;align-items:center;justify-content:center">
      <div style="font-weight:700">å•†å“è¯¦æƒ…</div>
      </div>
      <div id="detailBody" style="margin-top:12px;font-size:14px;color:#333"></div>
    </div>`;
    document.body.appendChild(modal);
    // åº•éƒ¨å±…ä¸­åœ†å½¢å…³é—­æŒ‰é’®ï¼ˆå¯é€šè¿‡ CSS å˜é‡è°ƒæ•´å°ºå¯¸ä¸é¢œè‰²ï¼‰
    const closeBtn = document.createElement('button');
    closeBtn.id = 'modalCloseRound';
    closeBtn.setAttribute('aria-label','å…³é—­è¯¦æƒ…');
    closeBtn.textContent = 'Ã—';
    Object.assign(closeBtn.style, {
      position:'absolute', left:'50%', bottom:'var(--modal-close-bottom)', transform:'translateX(-50%)',
      width:'var(--modal-close-size)', height:'var(--modal-close-size)', borderRadius:'50%',
      background:'var(--modal-close-bg)', color:'var(--modal-close-color)', border:'none',
      display:'flex', alignItems:'center', justifyContent:'center',
      fontSize:'28px', lineHeight:'1', boxShadow:'0 6px 18px rgba(0,0,0,0.18)', cursor:'pointer'
    });
    closeBtn.addEventListener('click', ()=>{ modal.style.display='none'; });
    modal.appendChild(closeBtn);

    modal.addEventListener('click', (e)=>{ if(e.target===modal) modal.style.display='none'; });
    document.getElementById('modalClose')?.addEventListener('click', ()=> modal.style.display='none');

    function showDetail(item){
      const body = modal.querySelector('#detailBody');
      const specLine = item.spec || extractSpec(item.description);
      const unitLine = item.unit || extractUnit(item.description);
      
      // è·å–å“ç‰Œå’Œå“ç±»åç§°
      const brandName = getBrandName(item.brandCode || '099');
      const categoryName = getCategoryName(item.categoryCode || '099');
      
      body.innerHTML = `
        <div style="font-size:16px;font-weight:700">${item.name||''}</div>
        <div style="margin-top:8px;color:#666">å•†å“ç¼–å·ï¼š${item.productCode||item.id||''}</div>
        <div style="margin-top:6px;color:#666">å“ç‰Œ/å‚å•†ï¼š${brandName}</div>
        <div style="margin-top:6px;color:#666">å•†å“åˆ†ç±»ï¼š${categoryName}</div>
        <div id="detailImageContainer" style="margin-top:10px;height:160px;border-radius:10px;background:linear-gradient(135deg, #f0f2f5, #e4e6ea);display:flex;align-items:center;justify-content:center;font-size:48px;color:#65676b;">ğŸ“¦</div>
        <div style="margin-top:6px;white-space:pre-line">è§„æ ¼ï¼š${specLine||''}</div>
        <div style="margin-top:4px">å•ä½ï¼š${unitLine||''}</div>
        ${item.price? `<div style="margin-top:6px;color:#d64">ä»·æ ¼ï¼šÂ¥${item.price}</div>`: ''}
        ${item.description? `<div style="margin-top:10px;color:#888">å¤‡æ³¨ï¼š${item.description}</div>`: ''}
      `;
      
      // ä¸ºè¯¦æƒ…å¼¹çª—åŠ è½½å›¾ç‰‡
      const detailImageContainer = document.getElementById('detailImageContainer');
      loadProductImage(detailImageContainer, item.id);
      modal.style.display='flex';
    }

    // æ™ºèƒ½å›¾ç‰‡åŠ è½½å‡½æ•°ï¼šä¼˜å…ˆä½¿ç”¨äº‘æ‰˜ç®¡å­˜å‚¨ï¼Œå¤±è´¥åˆ™æ˜¾ç¤ºemoji
    function loadProductImage(container, productId) {
      // æ¸…ç©ºå®¹å™¨
      container.innerHTML = '';
      container.style.background = 'linear-gradient(135deg, #f0f2f5, #e4e6ea)';
      container.style.display = 'flex';
      container.style.alignItems = 'center';
      container.style.justifyContent = 'center';
      container.style.fontSize = '24px';
      container.style.color = '#65676b';
      
      // å°è¯•åŠ è½½äº‘æ‰˜ç®¡å­˜å‚¨çš„å›¾ç‰‡
      if (STATIC_STORAGE_BASE_URL && productId) {
        const imgUrl = `${STATIC_STORAGE_BASE_URL}/photos/prd${productId}.png`;
        const img = new Image();
        
        img.onload = function() {
          // å›¾ç‰‡åŠ è½½æˆåŠŸï¼Œæ˜¾ç¤ºçœŸå®å›¾ç‰‡
          container.style.background = `url('${imgUrl}') center/cover no-repeat`;
          container.style.backgroundSize = 'cover';
          container.innerHTML = '';
        };
        
        img.onerror = function() {
          // å›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œæ˜¾ç¤ºemojiå ä½ç¬¦
          container.innerHTML = 'ğŸ“¦';
        };
        
        img.src = imgUrl;
      } else {
        // æ²¡æœ‰é…ç½®å­˜å‚¨åœ°å€ï¼Œç›´æ¥æ˜¾ç¤ºemoji
        container.innerHTML = 'ğŸ“¦';
      }
    }

    // ä»æ—§çš„ description æå–è§„æ ¼/å•ä½çš„å…¼å®¹æ–¹æ³•
    function extractSpec(desc){
      if(!desc) return '';
      const m = desc.match(/è§„æ ¼:([^/]+)/);
      return m? m[1].trim(): '';
    }
    function extractUnit(desc){
      if(!desc) return '';
      const m = desc.match(/å•ä½:([^/]+)/);
      return m? m[1].trim(): '';
    }

    // è·å–å“ç‰Œåç§°
    function getBrandName(brandCode) {
      if (!brandCode || !BRAND_DICTIONARY.brandDictionary) return 'æœªçŸ¥å“ç‰Œ';
      const brand = BRAND_DICTIONARY.brandDictionary.brands.find(b => b.code === brandCode);
      return brand ? brand.shortName || brand.name : 'æœªçŸ¥å“ç‰Œ';
    }

    // è·å–å“ç±»åç§°
    function getCategoryName(categoryCode) {
      if (!categoryCode || !CATEGORY_DICTIONARY.categoryDictionary) return 'æœªçŸ¥åˆ†ç±»';
      const category = CATEGORY_DICTIONARY.categoryDictionary.categories.find(c => c.code === categoryCode);
      return category ? category.shortName || category.name : 'æœªçŸ¥åˆ†ç±»';
    }

    function renderCategories(categories){
      const ul = document.getElementById('categoryList'); ul.innerHTML='';
      // é¡¶éƒ¨æ’å…¥â€œå…¨éƒ¨äº§å“â€å…¥å£
      const totalCount = categories.reduce((sum,c)=> sum + (Array.isArray(c.items)? c.items.length : 0), 0);
      const liAll = document.createElement('li'); liAll.className='category-item'; liAll.id='li-all';
      liAll.innerHTML = `<div class="label">å…¨éƒ¨äº§å“</div><div class="badge">${totalCount}</div>`;
      liAll.addEventListener('click', ()=> setActiveAll());
      if(activeCategoryIndex===-1) liAll.classList.add('active');
      ul.appendChild(liAll);
      // å…¶ä½™åˆ†ç±»
      categories.forEach((c, idx)=>{
        const li = document.createElement('li'); li.className='category-item';
        const displayName = (CATEGORY_SHORT_NAMES && CATEGORY_SHORT_NAMES[c.name]) ? CATEGORY_SHORT_NAMES[c.name] : c.name;
        li.innerHTML = `<div class="label">${displayName}</div><div class="badge">${c.items.length}</div>`;
        li.addEventListener('click', ()=>{ setActiveCategory(idx) });
        if(idx===activeCategoryIndex) li.classList.add('active');
        ul.appendChild(li);
      });
    }

    function setActiveCategory(idx){
      activeCategoryIndex = idx;
      const lis = document.querySelectorAll('.category-item'); lis.forEach((li,i)=> li.classList.toggle('active', i===idx));
      renderProducts(DATA.categories[idx]);
    }
    function setActiveAll(){
      activeCategoryIndex = -1;
      const lis = document.querySelectorAll('.category-item'); lis.forEach(li=> li.classList.remove('active'));
      document.getElementById('li-all')?.classList.add('active');
      renderProducts(null);
    }

    // ä¸­æ–‡åˆ†ç±»å -> è‹±æ–‡æ–‡ä»¶åï¼ˆslugï¼‰ï¼Œç”¨äºåŠ è½½ PNG Banner
    // å·²è¿ç§»åˆ°å¤–éƒ¨ JSONï¼ˆCONFIG_URLï¼‰ï¼Œè¿è¡Œæ—¶é€šè¿‡å¼‚æ­¥åŠ è½½å¡«å…… CATEGORY_BANNER_SLUGS
    // ä¾§æ å±•ç¤ºç”¨çŸ­åç§°ï¼Œä¸å½±å“ Banner ä¸å†…éƒ¨é€»è¾‘
    // å·²è¿ç§»åˆ°å¤–éƒ¨ JSONï¼ˆCONFIG_URLï¼‰ï¼Œè¿è¡Œæ—¶é€šè¿‡å¼‚æ­¥åŠ è½½å¡«å…… CATEGORY_SHORT_NAMES
// å·²è¿ç§»åˆ°å¤–éƒ¨ JSONï¼ˆCONFIG_URLï¼‰ï¼Œæ­¤å¤„ç§»é™¤
// å·²è¿ç§»åˆ°å¤–éƒ¨ JSONï¼ˆCONFIG_URLï¼‰ï¼Œæ­¤å¤„ç§»é™¤

    // åªåŠ è½½ .pngï¼šä½¿ç”¨è‹±æ–‡æ–‡ä»¶åï¼Œæœªå‘½ä¸­æˆ–åŠ è½½å¤±è´¥åˆ™ä¿æŒæ¸å˜èƒŒæ™¯
    function loadBannerBackground(bannerEl, name){
      bannerEl.style.background = 'linear-gradient(135deg, #6ea2ff 0%, #46d9a6 100%)';
      const slug = CATEGORY_BANNER_SLUGS[name] || 'others';
      const pngUrl = `./data/banners/${slug}.png`;
      const img = new Image();
      img.onload = ()=>{
        bannerEl.style.background = `linear-gradient(180deg, rgba(0,0,0,0.25), rgba(0,0,0,0.15)), url('${pngUrl}') center/cover no-repeat`;
      };
      img.onerror = ()=>{/* è‹¥ä¸å­˜åœ¨ PNGï¼Œä¿æŒæ¸å˜ä½œä¸ºå…œåº• */};
      img.src = pngUrl;
    }

    // åœ¨äº§å“æ¸²æŸ“æ—¶æ’å…¥ Bannerï¼Œæ ‡é¢˜è¦†ç›–åœ¨ Banner ä¸Šï¼ˆè°ƒç”¨ loadBannerBackgroundï¼‰
    function renderProducts(category){
      const grid = document.getElementById('productGrid'); grid.innerHTML='';
      const titleEl = document.getElementById('categoryTitle'); if(titleEl) titleEl.textContent='';
      const nameForBanner = category ? category.name : 'å…¨éƒ¨å•†å“';
      const oldBanner = document.getElementById('categoryBanner'); if(oldBanner) oldBanner.remove();
      const banner = document.createElement('div'); banner.id='categoryBanner'; banner.className='category-banner';
      const overlay = document.createElement('div'); overlay.className='title-overlay'; overlay.textContent = nameForBanner;
      banner.appendChild(overlay);
      // åŠ¨æ€è®¾ç½® Banner çš„å¸é¡¶åç§»ï¼Œé¿å…ä¸æœç´¢æ¡†é‡å 
      const topbarEl = document.querySelector('.topbar');
      const topbarHeight = topbarEl ? Math.ceil(topbarEl.getBoundingClientRect().height) : 0;
      banner.style.position = 'sticky';
      banner.style.top = ((topbarHeight || 52)) + 'px';
      banner.style.zIndex = '9';
      grid.parentNode.insertBefore(banner, grid);
      // åŠ è½½è‹±æ–‡æ–‡ä»¶åçš„ PNG Banner
      loadBannerBackground(banner, nameForBanner);

      const title = document.getElementById('categoryTitle'); title.textContent = nameForBanner;
      const items = category ? category.items : DATA.categories.flatMap(c=>c.items);
      if(items.length===0){ document.getElementById('emptyState').style.display='block'; return; }
      document.getElementById('emptyState').style.display='none';
      items.forEach(it=>{
        const card = document.createElement('div'); card.className='card';
        const img = document.createElement('div'); img.className='img';
        
        // ä½¿ç”¨æ™ºèƒ½å›¾ç‰‡åŠ è½½å‡½æ•°
        loadProductImage(img, it.id);
        
        const name = document.createElement('div'); name.className='name'; name.textContent=it.name||'Unnamed';
        const productCode = document.createElement('div'); productCode.className='desc'; productCode.textContent = `ç¼–å·ï¼š${it.productCode||it.id||''}`;
        const brand = document.createElement('div'); brand.className='desc'; 
        const brandName = getBrandName(it.brandCode || '099');
        brand.textContent = brandName ? `å“ç‰Œï¼š${brandName}` : '';
        const specLine = it.spec || extractSpec(it.description);
        const unitLine = it.unit || extractUnit(it.description);
        const spec = document.createElement('div'); spec.className='desc'; spec.textContent = specLine? `è§„æ ¼ï¼š${specLine}`: '';
        const unit = document.createElement('div'); unit.className='desc'; unit.textContent = unitLine? `å•ä½ï¼š${unitLine}`: '';
        const priceRow = document.createElement('div'); priceRow.className='price-row';
        const price = document.createElement('div'); price.className='price'; price.textContent = it.price ? 'Â¥'+it.price : '';
        const detailBtn = document.createElement('button'); detailBtn.className='add-btn'; detailBtn.textContent='æŸ¥çœ‹è¯¦æƒ…';
        detailBtn.addEventListener('click', ()=> showDetail(it));
        priceRow.appendChild(price); priceRow.appendChild(detailBtn);
        card.appendChild(img); card.appendChild(name); card.appendChild(productCode); card.appendChild(brand); card.appendChild(spec); card.appendChild(unit); card.appendChild(priceRow);
        grid.appendChild(card);
      });
    }

    function setActiveCategory(idx){
      activeCategoryIndex = idx;
      const lis = document.querySelectorAll('.category-item'); lis.forEach((li,i)=>{
        const isAll = li.id==='li-all';
        li.classList.toggle('active', !isAll && (i-1===idx));
      });
      renderProducts(DATA.categories[idx]);
    }

    function applySearch(){
      const q = document.getElementById('productSearch').value.trim().toLowerCase();
      const catQ = document.getElementById('categorySearch').value.trim().toLowerCase();
      // åˆ†ç±»æœç´¢åŸºäºå½“å‰ DATAï¼ˆæ”¯æŒçŸ­åç§°åŒ¹é…ï¼‰
      const filteredCats = DATA.categories.filter(c=> {
        const name = (c.name||'').toLowerCase();
        const shortName = ((CATEGORY_SHORT_NAMES&&CATEGORY_SHORT_NAMES[c.name])||'').toLowerCase();
        return name.includes(catQ) || shortName.includes(catQ);
      });
      if(catQ){
        if(filteredCats.length>0){ DATA={categories:filteredCats}; renderCategories(filteredCats); setActiveCategory(0); }
        else { document.getElementById('categoryList').innerHTML=''; document.getElementById('productGrid').innerHTML=''; document.getElementById('emptyState').style.display='block'; }
        return;
      }
      // å•†å“æœç´¢åŸºäºæ‰€æœ‰åˆ†ç±»åˆå¹¶
      const all = DATA.categories.flatMap(c=> c.items.map(it=> ({...it, _cat:c.name})));
      const matched = q? all.filter(it=> (it.name||'').toLowerCase().includes(q) || (it.description||'').toLowerCase().includes(q) || (it.brand||'').toLowerCase().includes(q) || (it.spec||'').toLowerCase().includes(q) || (it.unit||'').toLowerCase().includes(q)) : all;
      const grid = document.getElementById('productGrid'); grid.innerHTML='';
      if(matched.length===0){ document.getElementById('emptyState').style.display='block'; return; }
      document.getElementById('emptyState').style.display='none';
      matched.forEach(it=>{
        const card = document.createElement('div'); card.className='card';
        const img = document.createElement('div'); img.className='img';
        
        // ä½¿ç”¨æ™ºèƒ½å›¾ç‰‡åŠ è½½å‡½æ•°
        loadProductImage(img, it.id);
        
        const name = document.createElement('div'); name.className='name'; name.textContent=it.name||'Unnamed';
        const productCode = document.createElement('div'); productCode.className='desc'; productCode.textContent = `ç¼–å·ï¼š${it.productCode||it.id||''}`;
        const brand = document.createElement('div'); brand.className='desc'; 
        const brandName = getBrandName(it.brandCode || '099');
        brand.textContent = brandName ? `å“ç‰Œï¼š${brandName}` : '';
        const spec = document.createElement('div'); spec.className='desc'; const specLine = it.spec || extractSpec(it.description); spec.textContent = specLine? `è§„æ ¼ï¼š${specLine}`: '';
        const unit = document.createElement('div'); unit.className='desc'; const unitLine = it.unit || extractUnit(it.description); unit.textContent = unitLine? `å•ä½ï¼š${unitLine}`: '';
        const priceRow = document.createElement('div'); priceRow.className='price-row';
        const price = document.createElement('div'); price.className='price'; price.textContent = it.price ? 'Â¥'+it.price : '';
        const detailBtn = document.createElement('button'); detailBtn.className='add-btn'; detailBtn.textContent='æŸ¥çœ‹è¯¦æƒ…';
        detailBtn.addEventListener('click', ()=> showDetail(it));
        priceRow.appendChild(price); priceRow.appendChild(detailBtn);
        card.appendChild(img); card.appendChild(name); card.appendChild(productCode); card.appendChild(brand); card.appendChild(spec); card.appendChild(unit); card.appendChild(priceRow);
        grid.appendChild(card);
      });
    }

    document.addEventListener('input', (e)=>{
      if(e.target && e.target.id==='productSearch'){ applySearch(); }
      if(e.target && e.target.id==='categorySearch'){ applySearch(); }
    });

    // ä¾§æ â€œè¿”å›é¡¶éƒ¨â€æŒ‰é’®ä¸æ»šåŠ¨åé¦ˆ
    function setupBackToTop(){
      const sidebar = document.querySelector('.sidebar');
      const content = document.querySelector('.content');
      const topbar = document.querySelector('.topbar');
      const actions = document.getElementById('sidebarActions');
      if(!sidebar || !content || !actions) return;
      // å¡«å……æŒ‰é’®
      const btn = document.createElement('button');
      btn.className = 'backtop-btn';
      btn.type = 'button';
      btn.textContent = 'â†‘ è¿”å›é¡¶éƒ¨';
      actions.appendChild(btn);
      btn.addEventListener('click', ()=>{
        content.scrollTo({top:0, behavior:'smooth'});
        sidebar.scrollTo({top:0, behavior:'smooth'});
      });
      // æ ¹æ®æ»šåŠ¨æ˜¾ç¤º/éšè—ï¼Œå¹¶ä¸ºé¡¶éƒ¨æ æ·»åŠ é˜´å½±åé¦ˆ
      function updateVisibility(){
        const scrolledContent = content.scrollTop||0;
        const scrolledSidebar = sidebar.scrollTop||0;
        actions.style.display = (scrolledContent + scrolledSidebar) > 60 ? 'block' : 'none';
        if(topbar) topbar.classList.toggle('scrolled', scrolledContent > 0);
      }
      content.addEventListener('scroll', updateVisibility, {passive:true});
      sidebar.addEventListener('scroll', updateVisibility, {passive:true});
      updateVisibility();
    }
    setupBackToTop();

    // ä» CloudBase æ•°æ®åº“ä¼˜å…ˆåŠ è½½ï¼Œå¤±è´¥åˆ™å›é€€æœ¬åœ° JSON
    (async ()=>{
      try{
        // åŠ è½½é…ç½®æ•°æ® - æ”¯æŒäº‘ç«¯å’Œæœ¬åœ°
        const loadConfigData = async () => {
          if (USE_CLOUDBASE) {
            try {
              const config = window.CLOUDBASE_CONFIG || {};
              const app = cloudbase.init({ env: CLOUDBASE_ENV });
              const auth = app.auth();
              await auth.signInAnonymously();
              
              // å°è¯•ä»äº‘ç«¯è·å–é…ç½®
              const db = app.database();
              const configCollection = config.database?.configCollection || 'config';
              const configDocId = config.database?.configDocId || 'category-config';
              const configDoc = await db.collection(configCollection).doc(configDocId).get();
              
              if (configDoc && configDoc.data) {
                console.log('ä»äº‘ç«¯è·å–é…ç½®æ•°æ®æˆåŠŸ');
                return configDoc.data;
              }
            } catch (error) {
              console.warn('äº‘ç«¯é…ç½®è·å–å¤±è´¥ï¼Œå›é€€åˆ°æœ¬åœ°é…ç½®:', error);
            }
          }
          
          // å›é€€åˆ°æœ¬åœ°é…ç½®
          if (CONFIG_URL) {
            try {
              const response = await fetch(CONFIG_URL);
              return await response.json();
            } catch (error) {
              console.warn('æœ¬åœ°é…ç½®è·å–å¤±è´¥:', error);
            }
          }
          
          return null;
        };
        
        // åŠ è½½äº§å“æ•°æ® - æ”¯æŒäº‘ç«¯å’Œæœ¬åœ°
        const loadProductData = async () => {
          if (USE_CLOUDBASE) {
            try {
              const config = window.CLOUDBASE_CONFIG || {};
              const app = cloudbase.init({ env: CLOUDBASE_ENV });
              const auth = app.auth();
              await auth.signInAnonymously();
                
              // å°è¯•ä½¿ç”¨æ•°æ®æ¨¡å‹æ–¹å¼è·å–æ•°æ®
              try {
                const models = app.models;
                const modelName = config.models?.products || 'products';
                const docId = config.database?.catalogDocId || 'catalog-data';
                
                const result = await models[modelName].get({
                  filter: {
                    where: {
                      _id: { $eq: docId }
                    }
                  }
                });
                if (result && result.records && result.records.length > 0) {
                  console.log('é€šè¿‡æ•°æ®æ¨¡å‹è·å–äº§å“æ•°æ®æˆåŠŸ');
                  return result.records[0];
                }
              } catch (modelError) {
                console.warn('æ•°æ®æ¨¡å‹æ–¹å¼è·å–å¤±è´¥ï¼Œå°è¯•é›†åˆæ–¹å¼:', modelError);
              }
              
              // å›é€€åˆ°é›†åˆæ“ä½œæ–¹å¼
              const db = app.database();
              const collectionName = config.database?.productsCollection || 'products';
              const docId = config.database?.catalogDocId || 'catalog-data';
              const doc = await db.collection(collectionName).doc(docId).get();
              const docData = (doc && doc.data) || null;
              console.log('é€šè¿‡é›†åˆæ“ä½œè·å–äº§å“æ•°æ®:', docData ? 'æˆåŠŸ' : 'å¤±è´¥');
              return docData;
            } catch (e) { 
              console.warn('CloudBase äº§å“æ•°æ®è·å–å¤±è´¥ï¼Œå›é€€æœ¬åœ° JSON', e); 
            }
          }
          
          // å›é€€åˆ°æœ¬åœ°æ•°æ®
          try {
            const response = await fetch(FETCH_URL);
            return await response.json();
          } catch (error) {
            console.warn('æœ¬åœ°äº§å“æ•°æ®è·å–å¤±è´¥:', error);
            return null;
          }
        };
        
        // åŠ è½½å­—å…¸æ•°æ®
        const loadDictionaryData = async (url) => {
          try {
            const response = await fetch(url);
            return await response.json();
          } catch (error) {
            console.warn('å­—å…¸æ•°æ®è·å–å¤±è´¥:', error);
            return null;
          }
        };
        
        // å¹¶è¡ŒåŠ è½½é…ç½®ã€äº§å“æ•°æ®å’Œå­—å…¸æ•°æ®
        const [configData, productData, brandDict, categoryDict] = await Promise.all([
          loadConfigData(),
          loadProductData(),
          loadDictionaryData(BRAND_DICTIONARY_URL),
          loadDictionaryData(CATEGORY_DICTIONARY_URL)
        ]);
        
        // å¤„ç†å­—å…¸æ•°æ®
        if (brandDict) {
          BRAND_DICTIONARY = brandDict;
        }
        if (categoryDict) {
          CATEGORY_DICTIONARY = categoryDict;
        }
        
        // å¤„ç†é…ç½®æ•°æ®
        if (configData) {
          // æ”¯æŒæ–°çš„categoriesæ•°ç»„ç»“æ„
          if (configData.categories && Array.isArray(configData.categories)) {
            CATEGORY_CONFIG = configData.categories;
            // è½¬æ¢ä¸ºæ—§æ ¼å¼ä»¥ä¿æŒå…¼å®¹æ€§
            CATEGORY_BANNER_SLUGS = {};
            CATEGORY_SHORT_NAMES = {};
            configData.categories.forEach(cat => {
              CATEGORY_BANNER_SLUGS[cat.name] = cat.slug;
              CATEGORY_SHORT_NAMES[cat.name] = cat.shortName;
            });
          } else {
            // å…¼å®¹æ—§æ ¼å¼
            CATEGORY_BANNER_SLUGS = (configData && configData.banner_slugs) || {};
            CATEGORY_SHORT_NAMES = (configData && configData.short_names) || {};
          }
        }
        if(productData && Array.isArray(productData.categories)){
          DATA = productData;
          renderCategories(DATA.categories);
          setActiveAll();
        }else{
          document.getElementById('emptyState').style.display='block';
        }
      }catch(err){
        document.getElementById('emptyState').style.display='block';
        console.error('åŠ è½½æ•°æ®å¤±è´¥', err);
      }
    })();
  </script>
</body>
</html>
