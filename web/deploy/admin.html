<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ·æ˜è¾¾ç”µå•†äº§å“ç®¡ç†åå°</title>
    <!-- ä¼˜å…ˆä½¿ç”¨æœ¬åœ° CloudBase SDKï¼Œé¿å… CDN è¿æ¥é—®é¢˜ -->
    <script src="./cloudbase.full.js"></script>
    <!-- æœ¬åœ° Vue3 å›é€€ï¼ˆä¼˜å…ˆåŠ è½½ï¼‰ -->
    <script src="./assets/vue.global.prod.js"></script>
    <!-- Vue3 å¤šCDNå›é€€ï¼šunpkg â†’ jsDelivr â†’ Cloudflareï¼ˆç½‘ç»œå¯ç”¨æ—¶ä½œä¸ºå¤‡ç”¨ï¼‰ -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.prod.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/3.4.31/vue.global.prod.min.js" defer></script>
    <!-- æ›´æ–°å¥¶æ²¹è‰²ç³»æ ·å¼ -->
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #faf5ef; /* å¥¶æ²¹åº•è‰² */
            color: #4a3f35; /* æ·±æ£•æ–‡å­— */
        }
        
        .admin-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: linear-gradient(135deg, #fff5e6 0%, #f8ecd1 100%);
            color: #5a4e3c;
            padding: 14px 16px; /* ç´§å‡‘å¤´éƒ¨ */
            border-radius: 10px;
            margin-bottom: 16px; /* å‡å°‘å ç”¨ç©ºé—´ */
            text-align: center;
        }
        .header h1 {
            font-size: 1.8em;
            margin-bottom: 4px;
        }
        .header p {
            font-size: 0.95em;
            opacity: 0.85;
        }
        
        /* æ—§é¡¶éƒ¨æ ‡ç­¾å¯¼èˆªåˆ é™¤ï¼Œæ”¹ç”¨å·¦ä¾§ä¾§æ  */
        /* å¸ƒå±€ï¼šå·¦ä¾§ä¾§æ  + å³ä¾§å†…å®¹ */
        .layout {
            display: grid;
            grid-template-columns: 220px 1fr;
            gap: 16px;
            align-items: start;
            margin-bottom: 20px;
        }
        .sidebar {
            background: #fffaf0;
            border-radius: 10px;
            padding: 12px;
            box-shadow: 0 2px 10px rgba(90,78,60,0.08);
        }
        .side-nav { display: flex; flex-direction: column; gap: 8px; }
        .side-item {
            padding: 10px 12px;
            cursor: pointer;
            border-radius: 8px;
            transition: all .2s ease;
            font-weight: 500;
        }
        .side-item.active { background: #f1e6d0; color: #6b5f43; }
        .side-item:hover:not(.active) { background: #f7efe0; }
        @media (max-width: 992px) {
            .layout { grid-template-columns: 1fr; }
            .sidebar { order: -1; }
            .side-nav { flex-direction: row; flex-wrap: wrap; }
        }
        
        .content-panel {
            background: #fffaf4;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(90,78,60,0.08);
            min-height: 600px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #fbead7 0%, #f4e4c8 100%);
            color: #5a4e3c;
            padding: 25px;
            border-radius: 10px;
            text-align: center;
        }
        
        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .stat-label {
            font-size: 1.1em;
            opacity: 0.9;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .data-table th,
        .data-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        .data-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #555;
        }
        
        .data-table tr:hover {
            background: #f8f9fa;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            margin: 5px;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5a6fd8;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background: #218838;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #c9a96a;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* æ›´å¤§çš„è¾“å…¥æ¡†æ ·å¼ï¼ˆå¤ç”¨ search-box ç±»ä»¥ä¿æŒä¸€è‡´ï¼‰ */
        .search-box {
            width: 72%;
            height: 44px; /* é»˜è®¤æ›´é«˜ */
            padding: 10px 12px;
            font-size: 16px; /* å­—ä½“æ›´å¤§ä¸€äº› */
            border: 1px solid #ddd;
            border-radius: 10px; /* æ›´åœ†æ¶¦ */
            outline: none;
            background-color: #fff;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.03);
        }
        .search-box:focus {
            border-color: #e6b36c; /* ä¸ä¸»é¢˜è‰²ä¸€è‡´ */
            box-shadow: 0 0 0 3px rgba(230, 179, 108, 0.20);
        }
        
        /* select æ›´ç»Ÿä¸€é«˜åº¦ */
        select.search-box { height: 44px; }
        
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 20px;
            gap: 10px;
        }
        
        .page-btn {
            padding: 8px 12px;
            border: 1px solid #ddd;
            background: white;
            cursor: pointer;
            border-radius: 4px;
        }
        
        .page-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        
        .page-btn:hover:not(.active) {
            background: #f0f2f5;
        }

        /* å·¥å…·æ¡ä¸åˆ†åŒºé¢æ¿ */
        .toolbar { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
        .bulk-bar { display: flex; align-items: center; gap: 10px; flex-wrap: nowrap; overflow-x: auto; white-space: nowrap; }
        .query-bar { display: flex; align-items: center; gap: 10px; flex-wrap: nowrap; }
        .panel-sections { display: grid; grid-template-columns: 1fr; gap: 12px; margin: 8px 0 12px; }
        .panel { background: #fff; border: 1px solid #eee; border-radius: 10px; padding: 12px; }
        .panel-title { font-size: 14px; color: #6b5f43; margin-bottom: 8px; opacity: 0.85; }

        /* å¤é€‰æ¡†æ›´å¤§å°ºå¯¸ï¼ˆç»Ÿä¸€ç³»ç»Ÿå°ºå¯¸ï¼‰ */
        .row-select {
            width: 20px;
            height: 20px;
        }
        /* å…¨å±€å¤é€‰æ¡†å°ºå¯¸ç»Ÿä¸€ä¸ºä¸ .row-select ä¸€è‡´ */
        input[type="checkbox"] {
            width: 20px;
            height: 20px;
        }
        
        /* æ–°å¢ï¼šæ¨¡æ€ç™»å½•æ ·å¼ */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.45);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            animation: fadeIn 0.2s ease-out;
        }
        .modal {
            width: 420px;
            max-width: 92vw;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 12px 30px rgba(0,0,0,0.18);
            overflow: hidden;
            animation: slideUp 0.24s ease-out;
        }
        .modal-header {
            background: linear-gradient(135deg, #fff5e6 0%, #f8ecd1 100%); 
            color: #5a4e3c; 
            color: #fff;
            padding: 16px 18px;
        }
        
        .modal-header h3 { font-weight: 600; }
        .modal-body { padding: 18px; }
        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            padding: 0 18px 16px;
        }
        @keyframes fadeIn {
            from { opacity: 0; } to { opacity: 1; }
        }
        @keyframes slideUp {
            from { transform: translateY(8px); } to { transform: translateY(0); }
        }
        
        /* æŠ½å±‰æ ·å¼ */
        .drawer-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.35);
            backdrop-filter: blur(2px);
            z-index: 998;
        }
        .drawer {
            position: fixed;
            top: 0; right: 0;
            width: min(720px, 92vw);
            height: 100vh;
            background: #fff;
            box-shadow: -2px 0 16px rgba(0,0,0,0.12);
            z-index: 999;
            display: flex;
            flex-direction: column;
            border-top-left-radius: 12px;
            border-bottom-left-radius: 12px;
            animation: drawer-slide-in 220ms ease-out;
        }
        @keyframes drawer-slide-in {
            from { transform: translateX(16px); opacity: 0; }
            to   { transform: translateX(0);    opacity: 1; }
        }
        .drawer-header {
            padding: 18px 20px;
            border-bottom: 1px solid #eee;
        }
        .drawer-header h3 {
            margin: 0; font-size: 20px; color: #5a4e3c;
        }
        .drawer-body { padding: 18px 20px; overflow-y: auto; }
        .drawer-actions {
            padding: 16px 20px;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }
        /* å¼€å…³æŒ‰é’®æ ·å¼ */
        .switch { display: inline-flex; align-items: center; gap: 10px; }
        .switch-input { display: none; }
        .switch-label { position: relative; width: 48px; height: 28px; background: #ddd; border-radius: 18px; cursor: pointer; transition: background .2s ease; }
        .switch-button { position: absolute; top: 2px; left: 2px; width: 24px; height: 24px; background: #fff; border-radius: 50%; box-shadow: 0 1px 3px rgba(0,0,0,.2); transition: left .2s ease; }
        .switch-input:checked + .switch-label { background: #e6b36c; }
        .switch-input:checked + .switch-label .switch-button { left: 22px; }
        .switch-text { color:#5a4e3c; font-size: 14px; }
        .drawer label { font-size: 14px; }
        .drawer input[type="checkbox"] { width: 20px; height: 20px; }

        /* â€”â€” ç­›é€‰åŒºåŸŸä¼˜åŒ– â€”â€” */
        .filters-toolbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 12px;
            margin-top: 8px;
            margin-bottom: 8px;
        }
        .filters-grid {
            display: grid;
            grid-template-columns: repeat(3, minmax(180px, 220px));
            gap: 12px;
            align-items: center;
        }
        @media (max-width: 992px) {
            .filters-grid { grid-template-columns: repeat(2, minmax(160px, 1fr)); }
        }
        @media (max-width: 560px) {
            .filters-grid { grid-template-columns: 1fr; }
        }
        .filter-control { width: 220px; }
        .filter-status { width: 160px; }
        .filters-actions { display: flex; gap: 10px; margin-left: auto; }
        .select-box {
            height: 44px;
            padding: 10px 12px;
            font-size: 16px;
            border: 1px solid #ddd;
            border-radius: 10px;
            outline: none;
            background-color: #fff;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.03);
        }
        .select-box:focus {
            border-color: #e6b36c;
            box-shadow: 0 0 0 3px rgba(230, 179, 108, 0.20);
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="admin-container">
            <div class="header">
                <h1>æ·æ˜è¾¾ç”µå•†äº§å“ç®¡ç†åå°</h1>
                <p>äº§å“ã€å“ç‰Œã€åˆ†ç±»æ•°æ®ç®¡ç†ç³»ç»Ÿ</p>
                <div v-if="isAuthenticated" style="margin-top:10px; opacity:0.9; font-size:0.95em;">
                    å·²ç™»å½•ï¼š{{ user?.username || user?.email || user?.phone_number || user?.uid }}
                    <button class="btn btn-danger" style="margin-left:10px;" @click="logout">é€€å‡ºç™»å½•</button>
                </div>
            </div>
            
            <!-- å·²æ”¹ä¸ºæ¨¡æ€ç™»å½•å¼¹çª—ï¼Œéšè—åŸæœªç™»å½•å†…åµŒé¢æ¿ -->
            <div v-if="!isAuthenticated" class="content-panel" style="margin-bottom:20px; display:none;"></div>

            <!-- ç™»å½•æ¨¡æ€æ¡†ï¼šæœªç™»å½•æ—¶æ˜¾ç¤º -->
            <div class="modal-overlay" v-if="showLoginModal">
                <div class="modal">
                    <div class="modal-header">
                        <h3>å®‰å…¨ç™»å½•</h3>
                    </div>
                    <div class="modal-body">
                        <p style="margin-bottom:12px; color:#555;">è¯·è¾“å…¥ç®¡ç†å‘˜è´¦å·ä¸å¯†ç ä»¥ç™»å½•åå°ç®¡ç†</p>
                        <div style="margin-bottom:12px;">
                            <label style="display:block; margin-bottom:6px; color:#666;">ç”¨æˆ·å</label>
                            <input v-model="loginUsername" type="text" placeholder="ç”¨æˆ·å / é‚®ç®± / æ‰‹æœºå·" class="search-box" />
                        </div>
                        <div style="margin-bottom:6px;">
                            <label style="display:block; margin-bottom:6px; color:#666;">å¯†ç </label>
                            <input v-model="loginPassword" type="password" placeholder="å¯†ç " class="search-box" />
                        </div>
                        <div v-if="loginError" style="color:#dc3545; margin-top:8px;">{{ loginError }}</div>
                    </div>
                    <div class="modal-actions">
                        <button class="btn btn-primary" @click="login">ç™»å½•</button>
                    </div>
                </div>
            </div>
            
            <div v-if="isAuthenticated" class="layout">
              <aside class="sidebar">
                <div class="side-nav">
                  <div class="side-item" :class="{ active: activeTab === 'dashboard' }" @click="activeTab = 'dashboard'">ğŸ“Š æ•°æ®æ¦‚è§ˆ</div>
                  <div class="side-item" :class="{ active: activeTab === 'products' }" @click="activeTab = 'products'">ğŸ›ï¸ äº§å“ç®¡ç†</div>
                  <div class="side-item" :class="{ active: activeTab === 'brands' }" @click="activeTab = 'brands'">ğŸ·ï¸ å“ç‰Œç®¡ç†</div>
                  <div class="side-item" :class="{ active: activeTab === 'categories' }" @click="activeTab = 'categories'">ğŸ“‚ åˆ†ç±»ç®¡ç†</div>
                </div>
              </aside>
              <div class="content-panel">
                <!-- æ•°æ®æ¦‚è§ˆ -->
                <div v-if="activeTab === 'dashboard'">
                    <h2>ğŸ“Š æ•°æ®ç»Ÿè®¡</h2>
                    <div v-if="loading" class="loading">
                        <div class="spinner"></div>
                        <p>æ­£åœ¨åŠ è½½æ•°æ®...</p>
                    </div>
                    <div v-else>
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-number">{{ stats.totalProducts }}</div>
                                <div class="stat-label">æ€»äº§å“æ•°</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number">{{ stats.totalBrands }}</div>
                                <div class="stat-label">å“ç‰Œæ•°é‡</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number">{{ stats.totalCategories }}</div>
                                <div class="stat-label">åˆ†ç±»æ•°é‡</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number">{{ stats.onShelfProducts }}</div>
                                <div class="stat-label">ä¸Šæ¶äº§å“</div>
                            </div>
                        </div>
                        
                        <h3>ğŸ† çƒ­é—¨å“ç‰Œ</h3>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>å“ç‰Œåç§°</th>
                                    <th>ç®€ç§°</th>
                                    <th>äº§å“æ•°é‡</th>
                                    <th>çŠ¶æ€</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="brand in topBrands" :key="brand.id">
                                    <td>{{ brand.name }}</td>
                                    <td>{{ brand.shortName || '-' }}</td>
                                    <td>{{ brand.productCount }}</td>
                                    <td>
                                        <span style="color: green;">âœ… æ´»è·ƒ</span>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- äº§å“ç®¡ç† -->
                <div v-if="activeTab === 'products'">
                    <h2>ğŸ›ï¸ äº§å“ç®¡ç†</h2>
                    <!-- åˆ†åŒºé¢æ¿å®¹å™¨ -->
                    <div class="panel-sections">
                      <!-- æœç´¢ä¸æ“ä½œ -->
                      <div class="panel">
                        <div class="panel-title" @click="togglePanel('searchOps')" style="cursor:pointer; display:flex; align-items:center; justify-content:space-between;">
                          <span>æŸ¥è¯¢æ¡ä»¶</span>
                          <div style="display:flex; align-items:center; gap:8px;">
                            <button class="btn btn-primary" @click.stop="loadProducts">åˆ·æ–°æ•°æ®</button>
                            <button class="btn btn-success" @click.stop="openAddProductModal">æ·»åŠ äº§å“</button>
                            <span>{{ panelCollapsed.searchOps ? 'â–¶' : 'â–¼' }}</span>
                          </div>
                        </div>
                        <div v-show="!panelCollapsed.searchOps" class="query-bar">
                          <input v-model="productSearch" class="search-box" placeholder="æœç´¢äº§å“åç§°ã€ç¼–ç æˆ–è§„æ ¼..." style="flex:1; min-width:260px;">
                          <select v-model="filterBrandId" class="select-box filter-control" style="width:160px;">
                            <option :value="null">å…¨éƒ¨å“ç‰Œ</option>
                            <option v-for="b in brandOptions" :key="b.id" :value="b.id">{{ b.name }}</option>
                          </select>
                          <select v-model="filterCategoryId" class="select-box filter-control" style="width:160px;">
                            <option :value="null">å…¨éƒ¨åˆ†ç±»</option>
                            <option v-for="c in categoryOptions" :key="c.id" :value="c.id">{{ c.name }}</option>
                          </select>
                          <select v-model="filterOnShelf" class="select-box filter-status" style="width:140px;">
                            <option value="all">å…¨éƒ¨çŠ¶æ€</option>
                            <option value="on">ä¸Šæ¶</option>
                            <option value="off">ä¸‹æ¶</option>
                          </select>
                          <button class="btn btn-secondary" @click="clearFilters">æ¸…ç©ºç­›é€‰</button>
                        </div>
                      </div>

                      <!-- æ‰¹é‡æ“ä½œ -->
                      <div class="panel" v-if="filteredProducts.length">
                        <div class="panel-title" @click="togglePanel('bulk')" style="cursor:pointer; display:flex; align-items:center; justify-content:space-between;">
                          <span>æ‰¹é‡æ“ä½œ</span>
                          <span>{{ panelCollapsed.bulk ? 'â–¶' : 'â–¼' }}</span>
                        </div>
                        <div class="bulk-bar" v-show="!panelCollapsed.bulk">
                          <label style="display:flex; align-items:center; gap:8px;">
                             <input type="checkbox" :checked="isAllSelected" @change="toggleSelectAll($event)" />
                             <span>å…¨é€‰æœ¬é¡µ</span>
                          </label>
                          <div style="display:flex; align-items:center; gap:10px; flex-wrap: nowrap; white-space: nowrap;">
                            <select v-model="bulkField" class="search-box" style="width:200px;">
                              <option value="isOnShelf">ä¸Šæ¶çŠ¶æ€</option>
                              <option value="price">ä»·æ ¼</option>
                              <option value="unit">å•ä½</option>
                              <option value="spec">è§„æ ¼</option>
                              <option value="brandId">å“ç‰Œ</option>
                              <option value="categoryId">åˆ†ç±»</option>
                              <option value="remark">å¤‡æ³¨</option>
                            </select>
                            <!-- åŠ¨æ€å€¼è¾“å…¥ -->
                            <template v-if="bulkField === 'isOnShelf'">
                              <div class="switch">
                                <input type="checkbox" id="bulkOnShelf" class="switch-input" v-model="bulkValueBool">
                                <label for="bulkOnShelf" class="switch-label"><span class="switch-button"></span></label>
                                <span class="switch-text">{{ bulkValueBool ? 'å¼€' : 'å…³' }}</span>
                              </div>
                            </template>
                            <template v-else-if="bulkField === 'price'">
                              <input type="number" step="0.01" v-model.number="bulkValueNumber" class="search-box" style="width:200px;" placeholder="è®¾ç½®ä»·æ ¼">
                            </template>
                            <template v-else-if="bulkField === 'brandId'">
                              <select v-model="bulkValueId" class="search-box" style="width:220px;">
                                <option :value="null">æœªé€‰æ‹©</option>
                                <option v-for="b in brandOptions" :key="b.id" :value="b.id">{{ b.name }}</option>
                              </select>
                            </template>
                            <template v-else-if="bulkField === 'categoryId'">
                              <select v-model="bulkValueId" class="search-box" style="width:220px;">
                                <option :value="null">æœªé€‰æ‹©</option>
                                <option v-for="c in categoryOptions" :key="c.id" :value="c.id">{{ c.name }}</option>
                              </select>
                            </template>
                            <template v-else>
                              <input type="text" v-model="bulkValueText" class="search-box" style="width:280px;" :placeholder="'è®¾ç½® ' + bulkField">
                            </template>
                            <button class="btn btn-primary" @click="applyBulkUpdate" :disabled="!selectedProductIds.length">åº”ç”¨åˆ°å·²é€‰</button>
                          </div>
                        </div>
                      </div>
                      
                    </div>
                    
                    <div v-if="loading" class="loading">
                        <div class="spinner"></div>
                        <p>æ­£åœ¨åŠ è½½äº§å“æ•°æ®...</p>
                    </div>
                    
                    <div v-else>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th style="width:50px;">
                                      <input type="checkbox" :checked="isAllSelected" @change="toggleSelectAll($event)" title="å…¨é€‰å½“å‰" />
                                    </th>
                                    <th @click="toggleSort('name')" style="cursor:pointer;">äº§å“åç§° <span v-if="sortBy==='name'">{{ sortOrder==='asc' ? 'â–²' : 'â–¼' }}</span></th>
                                    <th @click="toggleSort('brandName')" style="cursor:pointer;">å“ç‰Œ <span v-if="sortBy==='brandName'">{{ sortOrder==='asc' ? 'â–²' : 'â–¼' }}</span></th>
                                    <th @click="toggleSort('categoryName')" style="cursor:pointer;">åˆ†ç±» <span v-if="sortBy==='categoryName'">{{ sortOrder==='asc' ? 'â–²' : 'â–¼' }}</span></th>
                                    <th @click="toggleSort('spec')" style="cursor:pointer;">è§„æ ¼ <span v-if="sortBy==='spec'">{{ sortOrder==='asc' ? 'â–²' : 'â–¼' }}</span></th>
                                    <th @click="toggleSort('unit')" style="cursor:pointer;">å•ä½ <span v-if="sortBy==='unit'">{{ sortOrder==='asc' ? 'â–²' : 'â–¼' }}</span></th>
                                    <th @click="toggleSort('isOnShelf')" style="cursor:pointer;">çŠ¶æ€ <span v-if="sortBy==='isOnShelf'">{{ sortOrder==='asc' ? 'â–²' : 'â–¼' }}</span></th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="product in displayedProducts" :key="product.id" @click="toggleRowSelect(product.id)" style="cursor:pointer;">
                                    <td>
                                      <input type="checkbox" class="row-select" :value="product.id" v-model="selectedProductIds" @click.stop />
                                    </td>
                                    <td>{{ product.name }}</td>
                                    <td>{{ product.brandName || '-' }}</td>
                                    <td>{{ product.categoryName || '-' }}</td>
                                    <td>{{ product.spec || '-' }}</td>
                                    <td>{{ product.unit || '-' }}</td>
                                    <td>
                                        <span v-if="product.isOnShelf" style="color: green;">âœ… ä¸Šæ¶</span>
                                        <span v-else style="color: orange;">â¸ï¸ ä¸‹æ¶</span>
                                    </td>
                                    <td>
                              <button class="btn btn-primary" @click.stop="openEditProductModal(product)">ç¼–è¾‘</button>
                              <button class="btn btn-danger" @click.stop="deleteProduct(product)">åˆ é™¤</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                        <!-- åˆ†é¡µç»„ä»¶ -->
                        <div class="pagination">
                            <div style="display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
                              <button class="page-btn" @click="prevPage" :disabled="currentPage === 1">ä¸Šä¸€é¡µ</button>
                              <span>ç¬¬ {{ currentPage }} / {{ totalPages }} é¡µ</span>
                              <button class="page-btn" @click="nextPage" :disabled="currentPage === totalPages">ä¸‹ä¸€é¡µ</button>
                              <span style="color:#666; margin-left:12px;">æ¯é¡µ</span>
                              <select v-model.number="pageSize" class="select-box" style="width:80px;" @change="setPageSize(pageSize)">
                                <option :value="20">20</option>
                                <option :value="50">50</option>
                                <option :value="100">100</option>
                              </select>
                              <span style="color:#666;">æ¡ï¼ˆå…± {{ filteredProducts.length }} æ¡ï¼‰</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- å“ç‰Œç®¡ç† -->
                <div v-if="activeTab === 'brands'">
                    <h2>ğŸ·ï¸ å“ç‰Œç®¡ç†</h2>
                    <div class="toolbar">
                        <button class="btn btn-primary" @click="loadBrands">ğŸ”„ åˆ·æ–°æ•°æ®</button>
                        <button class="btn btn-success">â• æ·»åŠ å“ç‰Œ</button>
                    </div>
                    
                    <div v-if="loading" class="loading">
                        <div class="spinner"></div>
                        <p>æ­£åœ¨åŠ è½½å“ç‰Œæ•°æ®...</p>
                    </div>
                    
                    <div v-else>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>å“ç‰Œåç§°</th>
                                    <th>ç®€ç§°</th>
                                    <th>ä»£ç </th>
                                    <th>äº§å“æ•°é‡</th>
                                    <th>çŠ¶æ€</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="brand in brands" :key="brand.id">
                                    <td>{{ brand.name }}</td>
                                    <td>{{ brand.shortName || '-' }}</td>
                                    <td>{{ brand.code }}</td>
                                    <td>{{ brand.productCount || 0 }}</td>
                                    <td>
                                        <span style="color: green;">âœ… æ´»è·ƒ</span>
                                    </td>
                                    <td>
                              <button class="btn btn-primary">ç¼–è¾‘</button>
                              <button class="btn btn-danger">åˆ é™¤</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- åˆ†ç±»ç®¡ç† -->
                <div v-if="activeTab === 'categories'">
                    <h2>ğŸ“‚ åˆ†ç±»ç®¡ç†</h2>
                    <div class="toolbar">
                        <button class="btn btn-primary" @click="loadCategories">ğŸ”„ åˆ·æ–°æ•°æ®</button>
                        <button class="btn btn-success">â• æ·»åŠ åˆ†ç±»</button>
                    </div>
                    
                    <div v-if="loading" class="loading">
                        <div class="spinner"></div>
                        <p>æ­£åœ¨åŠ è½½åˆ†ç±»æ•°æ®...</p>
                    </div>
                    
                    <div v-else>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>åˆ†ç±»åç§°</th>
                                    <th>ç®€ç§°</th>
                                    <th>ä»£ç </th>
                                    <th>äº§å“æ•°é‡</th>
                                    <th>çŠ¶æ€</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="category in categories" :key="category.id">
                                    <td>{{ category.name }}</td>
                                    <td>{{ category.shortName || '-' }}</td>
                                    <td>{{ category.code }}</td>
                                    <td>{{ category.productCount || 0 }}</td>
                                    <td>
                                        <span style="color: green;">âœ… æ´»è·ƒ</span>
                                    </td>
                                    <td>
                              <button class="btn btn-primary">ç¼–è¾‘</button>
                              <button class="btn btn-danger">åˆ é™¤</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
              </div>
            </div>
        </div>

    <!-- äº§å“æ–°å¢/ç¼–è¾‘æŠ½å±‰ -->
    <div class="drawer-overlay" v-if="showProductModal"></div>
    <div class="drawer" v-if="showProductModal">
      <div class="drawer-header">
        <h3>{{ isEditMode ? 'ç¼–è¾‘äº§å“' : 'æ–°å¢äº§å“' }}</h3>
      </div>
      <div class="drawer-body">
          <div style="display:grid; grid-template-columns: repeat(2, 1fr); gap: 16px;">
            <div>
              <label style="display:block; margin-bottom:6px; color:#666;">äº§å“åç§°</label>
              <input v-model="productForm.name" type="text" placeholder="è¯·è¾“å…¥äº§å“åç§°" class="search-box" />
            </div>
          <div>
            <label style="display:block; margin-bottom:6px; color:#666;">äº§å“ç¼–ç </label>
            <input v-model="productForm.productCode" type="text" placeholder="å¯é€‰ï¼Œæœªå¡«è‡ªåŠ¨ç”Ÿæˆ" class="search-box" />
          </div>
          <div>
            <label style="display:block; margin-bottom:6px; color:#666;">å“ç‰Œ</label>
            <select v-model="productForm.brandId" class="search-box">
              <option :value="null">æœªé€‰æ‹©</option>
              <option v-for="b in brandOptions" :key="b.id" :value="b.id">{{ b.name }}</option>
            </select>
          </div>
          <div>
            <label style="display:block; margin-bottom:6px; color:#666;">åˆ†ç±»</label>
            <select v-model="productForm.categoryId" class="search-box">
              <option :value="null">æœªé€‰æ‹©</option>
              <option v-for="c in categoryOptions" :key="c.id" :value="c.id">{{ c.name }}</option>
            </select>
          </div>
          <div>
            <label style="display:block; margin-bottom:6px; color:#666;">è´§å·</label>
            <input v-model="productForm.itemNo" type="text" placeholder="å¯é€‰" class="search-box" />
          </div>
          <div>
            <label style="display:block; margin-bottom:6px; color:#666;">è§„æ ¼</label>
            <input v-model="productForm.spec" type="text" placeholder="å¦‚ 10mm/20mm" class="search-box" />
          </div>
          <div>
            <label style="display:block; margin-bottom:6px; color:#666;">å•ä½</label>
            <input v-model="productForm.unit" type="text" placeholder="å¦‚ ä»¶/å¥—/ç±³" class="search-box" />
          </div>
          <div>
            <label style="display:block; margin-bottom:6px; color:#666;">ä»·æ ¼</label>
            <input v-model.number="productForm.price" type="number" step="0.01" placeholder="å¯é€‰" class="search-box" />
          </div>
          <div>
            <label style="display:block; margin-bottom:6px; color:#666;">å›¾ç‰‡åœ°å€</label>
            <input v-model="productForm.imageUrl" type="text" placeholder="å¯é€‰" class="search-box" />
          </div>
          <div>
            <label style="display:block; margin-bottom:6px; color:#666;">å¤‡æ³¨</label>
            <input v-model="productForm.remark" type="text" placeholder="å¯é€‰" class="search-box" />
          </div>
          <div style="margin-top:4px; grid-column: span 2;">
            <label style="display:block; margin-bottom:6px; color:#666;">ä¸Šæ¶</label>
            <div class="switch">
              <input type="checkbox" id="onShelfSwitch" class="switch-input" v-model="productForm.isOnShelf">
              <label for="onShelfSwitch" class="switch-label">
                <span class="switch-button"></span>
              </label>
              <span class="switch-text">{{ productForm.isOnShelf ? 'å¼€' : 'å…³' }}</span>
            </div>
          </div>
          </div>
        </div>
      <div class="drawer-actions">
        <button class="btn" @click="closeProductModal" style="background:#eee; color:#5a4e3c;">å–æ¶ˆ</button>
        <button class="btn btn-primary" @click="saveProduct">{{ isEditMode ? 'ä¿å­˜ä¿®æ”¹' : 'åˆ›å»ºäº§å“' }}</button>
      </div>
    </div>

    <script>
        const { createApp } = Vue;
        
        createApp({
            data() {
                return {
                    activeTab: 'dashboard',
                    loading: false,
                    productSearch: '',
                    app: null,
                    auth: null,
                    isAuthenticated: false,
                    user: null,
                    showLoginModal: false,
                    loginUsername: '',
                    loginPassword: '',
                    loginError: '',
                    config: {
                        envId: 'cloud1-0gc8cbzg3efd6a99',
                        clientId: undefined, // å¯é€‰ï¼šå¦‚ CloudBase æ§åˆ¶å°æä¾› ClientIdï¼Œå¯é…ç½®æ­¤å¤„
                        redirectUrl: 'https://cloud1-0gc8cbzg3efd6a99-1251221636.tcloudbaseapp.com/',
                        mysql: {
                            databaseUrl: 'mysql://skaiy_diao:Skaiy.290823@sh-cynosdbmysql-grp-94slsv2s.sql.tencentcdb.com:21976/cloud1-0gc8cbzg3efd6a99',
                            queryFunction: 'mysqlQuery'
                        }
                    },
            stats: {
                totalProducts: 0,
                totalBrands: 0,
                totalCategories: 0,
                onShelfProducts: 0
            },
            products: [],
            brands: [],
            categories: [],
            topBrands: [],
            // æ‰¹é‡é€‰æ‹©ä¸æ›´æ–°
            selectedProductIds: [],
            bulkField: 'isOnShelf',
            bulkValueBool: true,
            bulkValueNumber: null,
            bulkValueText: '',
            bulkValueId: null,
            // åˆ†é¡µç›¸å…³
            pageSize: 50,
            currentPage: 1,
            // æ’åºç›¸å…³
            sortBy: null,
            sortOrder: 'asc',
            // äº§å“CRUDç›¸å…³çŠ¶æ€
            showProductModal: false,
            isEditMode: false,
            productForm: {
              id: null,
                      name: '',
                      productCode: '',
                      brandId: null,
                      categoryId: null,
                      itemNo: '',
                      spec: '',
                      unit: '',
                      price: null,
                      imageUrl: '',
                      remark: '',
                      isOnShelf: true
                    },
                    brandOptions: [],
                    categoryOptions: [],
                    // åˆ—è¡¨ç­›é€‰çŠ¶æ€
                    filterBrandId: null,
                    filterCategoryId: null,
                    filterOnShelf: 'all',
                    // é¢æ¿æŠ˜å çŠ¶æ€
                    panelCollapsed: {
                        searchOps: false,
                        filters: false,
                        bulk: false,
                        paging: false
                    },
                }
            },
            computed: {
                filteredProducts() {
                    let list = Array.isArray(this.products) ? this.products.slice() : [];

                    const search = (this.productSearch || '').trim().toLowerCase();
                    if (search) {
                        list = list.filter(product => 
                            (product.name && product.name.toLowerCase().includes(search)) ||
                            (product.productCode && product.productCode.toLowerCase().includes(search)) ||
                            (product.spec && product.spec.toLowerCase().includes(search))
                        );
                    }

                    if (this.filterBrandId != null) {
                        const fb = this.filterBrandId;
                        list = list.filter(p => p.brandId == fb);
                    }
                    if (this.filterCategoryId != null) {
                        const fc = this.filterCategoryId;
                        list = list.filter(p => p.categoryId == fc);
                    }
                    if (this.filterOnShelf === 'on') {
                        list = list.filter(p => !!p.isOnShelf);
                    } else if (this.filterOnShelf === 'off') {
                        list = list.filter(p => !p.isOnShelf);
                    }

                    return list;
                },
                totalPages() {
                    const total = this.sortedFilteredProducts.length;
                    return total === 0 ? 1 : Math.ceil(total / this.pageSize);
                },
                sortedFilteredProducts() {
                    const list = this.filteredProducts.slice();
                    if (!this.sortBy) return list;
                    const key = this.sortBy;
                    const order = this.sortOrder === 'desc' ? -1 : 1;
                    return list.sort((a,b) => {
                        let va = a[key];
                        let vb = b[key];
                        // ç»Ÿä¸€å¤„ç†ç©ºå€¼
                        if (va == null && vb == null) return 0;
                        if (va == null) return -1 * order;
                        if (vb == null) return 1 * order;
                        // å¸ƒå°”è½¬æ•°å­—
                        if (typeof va === 'boolean') va = va ? 1 : 0;
                        if (typeof vb === 'boolean') vb = vb ? 1 : 0;
                        // å­—ç¬¦ä¸²ç»Ÿä¸€å°å†™æ¯”è¾ƒ
                        if (typeof va === 'string') va = va.toLowerCase();
                        if (typeof vb === 'string') vb = vb.toLowerCase();
                        if (va < vb) return -1 * order;
                        if (va > vb) return 1 * order;
                        return 0;
                    });
                },
                displayedProducts() {
                    const start = (this.currentPage - 1) * this.pageSize;
                    return this.sortedFilteredProducts.slice(start, start + this.pageSize);
                },
                isAllSelected() {
                    if (!this.displayedProducts.length) return false;
                    return this.selectedProductIds.length === this.displayedProducts.map(p => p.id).length;
                }
            },
            async mounted() {
                // å…¼å®¹å¤–éƒ¨é…ç½®
                if (window.CLOUDBASE_CONFIG) {
                    this.config.envId = window.CLOUDBASE_CONFIG.envId || this.config.envId;
                    if (window.CLOUDBASE_CONFIG?.auth?.clientId) {
                        this.config.clientId = window.CLOUDBASE_CONFIG.auth.clientId;
                    }
                    // æ–°å¢ï¼šæœ¬åœ°å¼€å‘æ—¶å…è®¸é€šè¿‡å¤–éƒ¨é…ç½®æ³¨å…¥ databaseUrl
                    if (window.CLOUDBASE_CONFIG?.mysql?.databaseUrl) {
                        this.config.mysql.databaseUrl = window.CLOUDBASE_CONFIG.mysql.databaseUrl;
                    }
                }
            
                // åˆå§‹åŒ– SDK ä¸è®¤è¯
                const initOptions = { env: this.config.envId };
                if (this.config.clientId) initOptions.clientId = this.config.clientId;
                this.app = cloudbase.init(initOptions);
                window.app = this.app; // æŒ‚è½½åˆ° window ä»¥ä¾¿å¤–éƒ¨è°ƒç”¨å®˜æ–¹ç™»å½•é¡µ
                this.auth = this.app.auth({ persistence: 'local' });

                // ç›‘å¬ç™»å½•çŠ¶æ€å˜åŒ–
                this.auth.onLoginStateChanged((state) => {
                    this.isAuthenticated = !!state && !!state.user;
                    this.user = state?.user || null;
                    this.showLoginModal = !this.isAuthenticated; // ç™»å½•æˆåŠŸåå…³é—­æ¨¡æ€
                    if (this.isAuthenticated && this.activeTab === 'dashboard') {
                        this.loadDashboardData();
                    }
                });

                // åˆå§‹çŠ¶æ€æ£€æŸ¥
                const state = await this.auth.getLoginState();
                this.isAuthenticated = !!state && !!state.user;
                this.user = state?.user || null;
                this.showLoginModal = !this.isAuthenticated; // é¦–æ¬¡è¿›å…¥æŒ‰çŠ¶æ€æ˜¾ç¤ºæ¨¡æ€
                if (this.isAuthenticated) {
                    await this.loadDashboardData();
                }
            },
            methods: {
                clearFilters() {
                    this.productSearch = '';
                    this.filterBrandId = null;
                    this.filterCategoryId = null;
                    this.filterOnShelf = 'all';
                    this.selectedProductIds = [];
                },
                toggleSort(field) {
                    if (this.sortBy === field) {
                        this.sortOrder = this.sortOrder === 'asc' ? 'desc' : 'asc';
                    } else {
                        this.sortBy = field;
                        this.sortOrder = 'asc';
                    }
                    this.currentPage = 1;
                },
                toggleSelectAll(e) {
                    const checked = !!e.target.checked;
                    if (checked) {
                        this.selectedProductIds = this.displayedProducts.map(p => p.id);
                    } else {
                        this.selectedProductIds = [];
                    }
                },
                toggleRowSelect(id) {
                    const idx = this.selectedProductIds.indexOf(id);
                    if (idx === -1) this.selectedProductIds.push(id);
                    else this.selectedProductIds.splice(idx, 1);
                },
                // åˆ†é¡µæ§åˆ¶
                prevPage() {
                    if (this.currentPage > 1) {
                        this.currentPage--;
                        this.selectedProductIds = [];
                    }
                },
                nextPage() {
                    if (this.currentPage < this.totalPages) {
                        this.currentPage++;
                        this.selectedProductIds = [];
                    }
                },
                setPageSize(size) {
                    this.pageSize = Number(size) || 50;
                    this.currentPage = 1;
                    this.selectedProductIds = [];
                },
                togglePanel(key) {
                    if (!this.panelCollapsed || !(key in this.panelCollapsed)) return;
                    this.panelCollapsed[key] = !this.panelCollapsed[key];
                },
                async applyBulkUpdate() {
                    try {
                        await this.ensureAuthenticated();
                        if (!this.selectedProductIds.length) {
                            alert('è¯·å…ˆé€‰æ‹©éœ€è¦æ‰¹é‡æ›´æ–°çš„äº§å“');
                            return;
                        }
                        // è§£æå€¼
                        let value;
                        if (this.bulkField === 'isOnShelf') value = !!this.bulkValueBool;
                        else if (this.bulkField === 'price') value = (this.bulkValueNumber != null ? Number(this.bulkValueNumber) : null);
                        else if (this.bulkField === 'brandId' || this.bulkField === 'categoryId') value = (this.bulkValueId ?? null);
                        else value = this.bulkValueText || '';

                        // é€æ¡æ›´æ–°ï¼ˆä¸ºé¿å…æ‰¹é‡å¤±è´¥ï¼Œè¿™é‡Œä¸²è¡Œæ‰§è¡Œï¼‰
                        for (const id of this.selectedProductIds) {
                            const payload = { id };
                            payload[this.bulkField] = value;
                            const res = await this.callFunction('mysqlQuery', { action: 'product.update', payload });
                            if (!res || !res.ok) {
                                throw new Error(res?.error || res?.message || `æ›´æ–°å¤±è´¥ï¼ˆID: ${id}ï¼‰`);
                            }
                            // æœ¬åœ°è¡Œçº§æ›´æ–°ï¼Œé¿å…æ•´è¡¨åˆ·æ–°
                            const extra = {};
                            if (this.bulkField === 'brandId') {
                                const b = this.brandOptions.find(x => x.id === value);
                                extra.brandName = b ? b.name : null;
                            }
                            if (this.bulkField === 'categoryId') {
                                const c = this.categoryOptions.find(x => x.id === value);
                                extra.categoryName = c ? c.name : null;
                            }
                            this.updateLocalProduct(id, { [this.bulkField]: value, ...extra });
                        }
                        alert('æ‰¹é‡æ›´æ–°å®Œæˆ');
                        this.selectedProductIds = [];
                    } catch (error) {
                        console.error('æ‰¹é‡æ›´æ–°å¤±è´¥:', error);
                        alert(error?.message || 'æ‰¹é‡æ›´æ–°å¤±è´¥');
                    }
                },
                async ensureAuthenticated() {
                    const state = await this.auth.getLoginState();
                    if (!state || !state.user) {
                        throw new Error('è¯·å…ˆç™»å½•å†æ‰§è¡Œæ“ä½œ');
                    }
                    return state.user;
                },

                async login() {
                    try {
                        this.loginError = '';
                        await this.auth.signIn({ username: this.loginUsername, password: this.loginPassword });
                        // ç™»å½•æˆåŠŸåï¼ŒçŠ¶æ€ç›‘å¬å™¨ä¼šè§¦å‘å¹¶åŠ è½½æ•°æ®
                    } catch (error) {
                        console.error('ç™»å½•å¤±è´¥:', error);
                        this.loginError = (error && error.message) ? error.message : 'ç™»å½•å¤±è´¥ï¼Œè¯·æ£€æŸ¥è´¦å·æˆ–å¯†ç ';
                    }
                },

                async logout() {
                    try {
                        await this.auth.signOut();
                        this.isAuthenticated = false;
                        this.user = null;
                        this.products = [];
                        this.brands = [];
                        this.categories = [];
                    } catch (error) {
                        console.error('é€€å‡ºç™»å½•å¤±è´¥:', error);
                    }
                },
                
                async callFunction(functionName, data = {}) {
                    try {
                        await this.ensureAuthenticated();
                        const shouldPassDbUrl = ['localhost', '127.0.0.1'].includes(window.location.hostname);
                        const result = await this.app.callFunction({
                            name: functionName,
                            data: {
                                ...data,
                                ...(shouldPassDbUrl && this.config.mysql?.databaseUrl ? { databaseUrl: this.config.mysql.databaseUrl } : {})
                            }
                        });
                        return result.result;
                    } catch (error) {
                        console.error(`è°ƒç”¨äº‘å‡½æ•° ${functionName} å¤±è´¥:`, error);
                        return null;
                    }
                },
                
                async loadDashboardData() {
                    this.loading = true;
                    try {
                        // éªŒè¯æ•°æ®åº“å¹¶è·å–ç»Ÿè®¡ä¿¡æ¯
                        const validateResult = await this.callFunction('validateDatabase', { action: 'validate' });
                        if (validateResult && validateResult.ok) {
                            const data = validateResult.data;
                            this.stats = {
                                totalProducts: data.summary?.totalProducts || 0,
                                totalBrands: data.summary?.totalBrands || 0,
                                totalCategories: data.summary?.totalCategories || 0,
                                onShelfProducts: data.summary?.onShelfProducts || 0
                            };
                        }
                        
                        // åŠ è½½å“ç‰Œæ•°æ®
                        const brandsResult = await this.callFunction('mysqlQuery', { action: 'brands' });
                        if (brandsResult && brandsResult.ok) {
                            this.topBrands = brandsResult.data.brandDictionary?.brands?.slice(0, 10) || [];
                        }
                    } catch (error) {
                        console.error('åŠ è½½ä»ªè¡¨æ¿æ•°æ®å¤±è´¥:', error);
                    } finally {
                        this.loading = false;
                    }
                },
                
                async loadProducts() {
                    this.loading = true;
                    try {
                        const result = await this.callFunction('mysqlQuery', { action: 'products' });
                        if (result && result.ok) {
                            this.products = [];
                            if (result.data.categories) {
                                result.data.categories.forEach(category => {
                                    if (category.items) {
                                        category.items.forEach(product => {
                                            this.products.push({
                                                ...product,
                                                categoryName: category.name
                                            });
                                        });
                                    }
                                });
                            }
                        }
                        // åŠ è½½ä¸‹æ‹‰é€‰é¡¹ï¼ˆå“ç‰Œä¸åˆ†ç±»ï¼‰
                        const brandsAll = await this.callFunction('mysqlQuery', { action: 'brands.all' });
                        this.brandOptions = brandsAll && brandsAll.ok ? (brandsAll.data || []) : (this.brands || []);
                        const categoriesAll = await this.callFunction('mysqlQuery', { action: 'categories.all' });
                        this.categoryOptions = categoriesAll && categoriesAll.ok ? (categoriesAll.data || []) : (this.categories || []);
                        this.currentPage = 1; // æ•°æ®åˆ·æ–°åå›åˆ°ç¬¬ä¸€é¡µ
                        this.selectedProductIds = [];
                    } catch (error) {
                        console.error('åŠ è½½äº§å“æ•°æ®å¤±è´¥:', error);
                    } finally {
                        this.loading = false;
                    }
                },
                
                async loadBrands() {
                    this.loading = true;
                    try {
                        const result = await this.callFunction('mysqlQuery', { action: 'brands' });
                        if (result && result.ok) {
                            this.brands = result.data.brandDictionary?.brands || [];
                        }
                    } catch (error) {
                        console.error('åŠ è½½å“ç‰Œæ•°æ®å¤±è´¥:', error);
                    } finally {
                        this.loading = false;
                    }
                },
                
                async loadCategories() {
                    this.loading = true;
                    try {
                        const result = await this.callFunction('mysqlQuery', { action: 'categories' });
                        if (result && result.ok) {
                            this.categories = result.data.categoryDictionary?.categories || [];
                        }
                    } catch (error) {
                        console.error('åŠ è½½åˆ†ç±»æ•°æ®å¤±è´¥:', error);
                    } finally {
                        this.loading = false;
                    }
                },
                // æ–°å¢ï¼šæ‰“å¼€æŠ½å±‰å‰ç¡®ä¿åŠ è½½ä¸‹æ‹‰é€‰é¡¹
                async loadDropdownOptions(force = false) {
                    try {
                        await this.ensureAuthenticated();
                        if (force || !this.brandOptions.length) {
                            const brandsAll = await this.callFunction('mysqlQuery', { action: 'brands.all' });
                            const brandsData = (brandsAll && brandsAll.ok) ? (brandsAll.data || brandsAll.data?.brandDictionary?.brands || []) : [];
                            this.brandOptions = Array.isArray(brandsData) ? brandsData : [];
                        }
                        if (force || !this.categoryOptions.length) {
                            const categoriesAll = await this.callFunction('mysqlQuery', { action: 'categories.all' });
                            const categoriesData = (categoriesAll && categoriesAll.ok) ? (categoriesAll.data || categoriesAll.data?.categoryDictionary?.categories || []) : [];
                            this.categoryOptions = Array.isArray(categoriesData) ? categoriesData : [];
                        }
                    } catch (error) {
                        console.error('åŠ è½½ä¸‹æ‹‰é€‰é¡¹å¤±è´¥:', error);
                    }
                },

                
                async openAddProductModal() {
                    this.isEditMode = false;
                    this.productForm = {
                        id: null,
                        name: '',
                        productCode: '',
                        brandId: null,
                        categoryId: null,
                        itemNo: '',
                        spec: '',
                        unit: '',
                        price: null,
                        imageUrl: '',
                        remark: '',
                        isOnShelf: true
                    };
                    await this.loadDropdownOptions();
                    this.showProductModal = true;
                },
                async openEditProductModal(product) {
                    this.isEditMode = true;
                    this.productForm = {
                        id: product.id,
                        name: product.name || '',
                        productCode: product.productCode || '',
                        brandId: product.brandId ?? null,
                        categoryId: product.categoryId ?? null,
                        itemNo: product.itemNo || '',
                        spec: product.spec || '',
                        unit: product.unit || '',
                        price: product.price != null ? Number(product.price) : null,
                        imageUrl: product.image || product.imageUrl || '',
                        remark: product.description || product.remark || '',
                        isOnShelf: product.isOnShelf !== undefined ? !!product.isOnShelf : true
                    };
                    await this.loadDropdownOptions();
                    this.showProductModal = true;
                },
                closeProductModal() {
                    this.showProductModal = false;
                },
                async saveProduct() {
                    try {
                        await this.ensureAuthenticated();
                        const payload = { ...this.productForm };
                        const action = this.isEditMode ? 'product.update' : 'product.create';
                        const res = await this.callFunction('mysqlQuery', { action, payload });
                        if (res && res.ok) {
                            this.showProductModal = false;
                            if (this.isEditMode) {
                                const b = this.brandOptions.find(x => x.id === this.productForm.brandId);
                                const c = this.categoryOptions.find(x => x.id === this.productForm.categoryId);
                                this.updateLocalProduct(this.productForm.id, {
                                    ...this.productForm,
                                    brandName: b ? b.name : (this.productForm.brandName || null),
                                    categoryName: c ? c.name : (this.productForm.categoryName || null)
                                });
                            } else {
                                const createdId = res.data?.id || res.id || null;
                                const b = this.brandOptions.find(x => x.id === this.productForm.brandId);
                                const c = this.categoryOptions.find(x => x.id === this.productForm.categoryId);
                                const newItem = {
                                    ...(res.data?.product || this.productForm),
                                    id: createdId || this.productForm.id,
                                    brandName: b ? b.name : null,
                                    categoryName: c ? c.name : null
                                };
                                // æ·»åŠ åˆ°åˆ—è¡¨é¡¶éƒ¨
                                this.products.unshift(newItem);
                            }
                        } else {
                            alert((res && res.error) ? res.error : 'ä¿å­˜å¤±è´¥');
                        }
                    } catch (e) {
                        console.error('ä¿å­˜äº§å“å¤±è´¥:', e);
                        alert(e?.message || 'ä¿å­˜äº§å“å¤±è´¥');
                    }
                },
                updateLocalProduct(id, changes) {
                    const idx = this.products.findIndex(p => p.id === id);
                    if (idx !== -1) {
                        this.products[idx] = { ...this.products[idx], ...changes };
                    }
                },
                async deleteProduct(product) {
                    if (!product || !product.id) return alert('ç¼ºå°‘äº§å“ id');
                    if (!confirm(`ç¡®è®¤åˆ é™¤äº§å“ï¼š${product.name}ï¼Ÿ`)) return;
                    try {
                        await this.ensureAuthenticated();
                        const res = await this.callFunction('mysqlQuery', { action: 'product.delete', payload: { id: product.id } });
                        if (res && res.ok) {
                            // æœ¬åœ°åˆ é™¤ï¼Œé¿å…æ•´è¡¨åˆ·æ–°
                            this.products = this.products.filter(p => p.id !== product.id);
                        } else {
                            alert((res && res.error) ? res.error : 'åˆ é™¤å¤±è´¥');
                        }
                    } catch (e) {
                        console.error('åˆ é™¤äº§å“å¤±è´¥:', e);
                        alert(e?.message || 'åˆ é™¤äº§å“å¤±è´¥');
                    }
                }
            },
            watch: {
                activeTab(newTab) {
                    if (!this.isAuthenticated) return;
                    if (newTab === 'products' && this.products.length === 0) {
                        this.loadProducts();
                    } else if (newTab === 'brands' && this.brands.length === 0) {
                        this.loadBrands();
                    } else if (newTab === 'categories' && this.categories.length === 0) {
                        this.loadCategories();
                    }
                },
                // ç­›é€‰ä¸æœç´¢å˜åŒ–æ—¶é‡ç½®åˆ†é¡µä¸é€‰æ‹©
                productSearch() { this.currentPage = 1; this.selectedProductIds = []; },
                filterBrandId() { this.currentPage = 1; this.selectedProductIds = []; },
                filterCategoryId() { this.currentPage = 1; this.selectedProductIds = []; },
                filterOnShelf() { this.currentPage = 1; this.selectedProductIds = []; }
            }
        }).mount('#app');
    </script>

</body>
</html>
