<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">
  <title>捷明达在线服务</title>
  <!-- CloudBase Web SDK -->
  <script src="https://static.cloudbase.net/cloudbase-js-sdk/2.17.3/cloudbase.full.js"></script>
  <!-- CloudBase 配置 -->
  <script src="./cloudbase.config.js"></script>
  <style>
    :root{--bg:#f7f7f8;--card:#fff;--accent:#ff6b6b;--muted:#888;--modal-close-size:56px;--modal-close-bg:var(--accent);--modal-close-color:#fff;--modal-close-bottom:24px}
    html,body{height:100%;margin:0;font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial; background:var(--bg); color:#222}
    .app{display:flex;flex-direction:column;height:100vh;max-height:100vh;overflow:hidden}
    
    /* 顶部搜索栏 */
    .top-search-bar{position:sticky;top:0;z-index:100;background:#fff;border-bottom:1px solid #eee;padding:8px 12px;box-shadow:0 2px 8px rgba(0,0,0,0.06)}
    .search-input{width:100%;padding:10px 12px;border-radius:12px;border:1px solid #ddd;font-size:16px;box-sizing:border-box}
    .search-input:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px rgba(255,107,107,0.1)}
    
    /* 品牌筛选区域 */
    .brand-filter-section{position:sticky;top:57px;z-index:99;background:#fff;border-bottom:1px solid #eee;padding:8px 0}
    .brand-filter-container{display:flex;align-items:center;gap:8px;padding:0 12px}
    .brand-scroll{flex:1;overflow-x:auto;scrollbar-width:none;-ms-overflow-style:none}
    .brand-scroll::-webkit-scrollbar{display:none}
    .brand-tabs{display:flex;gap:8px;padding:4px 0;min-width:max-content}
    .brand-tab{display:flex;align-items:center;gap:6px;padding:8px 12px;border-radius:20px;background:#f5f5f5;color:#666;font-size:14px;white-space:nowrap;cursor:pointer;transition:all 0.2s ease;border:1px solid transparent}
    .brand-tab.active{background:var(--accent);color:#fff;font-weight:600}
    .brand-tab:hover:not(.active){background:#e8e8e8;border-color:#ddd}
    .brand-logo{width:20px;height:20px;border-radius:50%;background:linear-gradient(45deg,#ddd,#bbb);display:flex;align-items:center;justify-content:center;font-size:10px;color:#fff;font-weight:bold}
    .expand-btn{padding:8px;border-radius:50%;background:#f5f5f5;border:1px solid #ddd;cursor:pointer;transition:all 0.3s ease;min-width:36px;height:36px;display:flex;align-items:center;justify-content:center;font-size:16px;font-weight:bold}
    .expand-btn:hover{background:#e8e8e8;transform:scale(1.05);box-shadow:0 2px 8px rgba(0,0,0,0.1)}
    .expand-btn.active{background:var(--accent);color:#fff;border-color:var(--accent);transform:scale(1.1);box-shadow:0 4px 12px rgba(255,107,107,0.3)}
    
    /* 主内容区域 */
    .main-content{flex:1;display:flex;overflow:hidden}
    .sidebar{width:24%;min-width:104px;max-width:200px;background:linear-gradient(#fff,#fafafa);border-right:1px solid #eee;overflow:auto;position:sticky;top:0;height:100%}
    .sidebar .search{position: sticky; top: 0; z-index: 2; padding:10px; background: linear-gradient(#fff,#fafafa); border-bottom: 1px solid #eee;}
    .category-list{list-style:none;padding:0;margin:0}
    .category-item{padding:12px 10px;border-bottom:1px solid #f0f0f0;cursor:pointer;display:flex;align-items:center}
    .category-item.active{background:linear-gradient(90deg, rgba(255,107,107,0.06), transparent);font-weight:600;color:var(--accent)}
    .category-item .label{flex:1 1 auto;min-width:0;white-space:normal;word-break:break-word}
    .category-item .badge{margin-left:auto;background:#eee;padding:4px 8px;border-radius:12px;font-size:12px;color:var(--muted)}
    .content{flex:1;overflow:auto;padding:8px}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:8px;padding:8px}
    .card{background:var(--card);border-radius:12px;padding:8px;box-shadow:0 4px 12px rgba(0,0,0,0.08);display:flex;flex-direction:column;transition: transform .2s cubic-bezier(.2,.8,.2,1), box-shadow .25s ease}
    .card:hover, .card:active{ box-shadow: 0 8px 24px rgba(0,0,0,0.12); transform: translateY(-1px) scale(1.01); }
    .card .img{height:110px;border-radius:8px;background:linear-gradient(180deg,#eee,#ddd);display:flex;align-items:center;justify-content:center;font-size:12px;color:#999}
    .card .name{margin-top:8px;font-size:14px;line-height:1.2;height:2.6em;overflow:hidden}
    .card .desc{font-size:12px;color:var(--muted);height:1.6em;overflow:hidden;margin-top:6px}
    .card .price-row{display:flex;flex-direction:column;gap:8px;align-items:stretch;margin-top:8px}
    .price{font-weight:700;color:var(--accent)}
    .add-btn{background:var(--accent);color:#fff;border:none;padding:6px 10px;border-radius:8px;font-weight:600;display:block;width:100%;box-sizing:border-box}
    @media(max-width:720px){.sidebar{width:30%;min-width:90px}.grid{grid-template-columns:repeat(2,1fr)}}
    @media(max-width:540px){.grid{grid-template-columns:1fr}}
    @media(max-width:420px){.main-content{flex-direction:row}.sidebar{order:1;width:36%;min-width:100px;max-width:160px;border-right:1px solid #eee;border-top:none}.content{order:2}.grid{grid-template-columns:1fr}.category-item{padding:10px 10px}.category-item .label{font-size:13px;line-height:1.25;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}.category-item .badge{font-size:11px;padding:2px 6px}}
    .empty{padding:30px;text-align:center;color:var(--muted)}
      /* 分类 Banner 样式 - 变窄并置顶 */
      .category-banner { position: sticky; top: 0; z-index: 10; width: 100%; height: 50px; border-radius: 0; overflow: hidden; background: linear-gradient(135deg, #6ea2ff 0%, #46d9a6 100%); margin: 0; }
      .category-banner .title-overlay { position: absolute; left: 16px; top: 50%; transform: translateY(-50%); color: #fff; font-size: 16px; font-weight: 700; text-shadow: 0 2px 6px rgba(0,0,0,0.35); }
      @media(min-width: 768px){ .category-banner { height: 60px; } .category-banner .title-overlay { font-size: 18px; } }
      @media(max-width: 420px){ .category-banner { height: 45px; } .category-banner .title-overlay { font-size: 14px; } }
      #categoryTitle { display: none; }
      .sidebar, .content { scroll-behavior: smooth; }
      .sidebar-actions { position: sticky; bottom: 8px; padding: 8px; background: linear-gradient(#fff,#fafafa); border-top: 1px solid #eee; }
      .sidebar-actions .backtop-btn { width: 100%; padding: 10px 12px; border-radius: 999px; border: none; background: var(--accent); color: #fff; font-weight: 700; box-shadow: 0 3px 10px rgba(0,0,0,0.12); cursor: pointer; }
  </style>
</head>
<body>
  <div class="app">
    <!-- 顶部搜索栏 -->
    <div class="top-search-bar">
      <input id="globalSearch" class="search-input" placeholder="搜索产品名称、品牌、规格..." />
    </div>
    
    <!-- 品牌筛选区域 -->
    <div class="brand-filter-section">
      <div class="brand-filter-container">
        <div class="brand-scroll">
          <div class="brand-tabs" id="brandTabs">
            <div class="brand-tab active" data-brand="all">
              <span>全部</span>
            </div>
          </div>
        </div>
        <button class="expand-btn" id="expandBrands" title="展开全部品牌">
          <span>⋯</span>
        </button>
      </div>
    </div>
    
    <!-- 主内容区域 -->
    <div class="main-content">
      <aside class="sidebar">
        <div class="search">
          <input id="categorySearch" placeholder="搜索分类" style="width:100%;padding:8px;border-radius:8px;border:1px solid #eee;box-sizing:border-box">
        </div>
        <ul class="category-list" id="categoryList"></ul>
        <div id="sidebarActions" class="sidebar-actions" style="display:none"></div>
      </aside>

      <main class="content">
        <div id="productGrid" class="grid"></div>
        <div id="emptyState" class="empty" style="display:none">没有找到商品。</div>
      </main>
    </div>
  </div>

  <script>
    const FETCH_URL = './data/products.json';
    const BRAND_DICTIONARY_URL = './data/brand_dictionary.json';
    const CATEGORY_DICTIONARY_URL = './data/category_dictionary.json';
    const DEFAULT_PRODUCT_IMAGE = './assets/default-product.jpg';
    const config = window.CLOUDBASE_CONFIG || {};
    const CLOUDBASE_ENV = window.CLOUDBASE_ENV || localStorage.getItem('CLOUDBASE_ENV') || config.envId || '';
    const USE_CLOUDBASE = !!CLOUDBASE_ENV;
    const USE_MYSQL = config.dataSource === 'mysql';
    const CONFIG_URL = './data/category_config.json';
    let CATEGORY_BANNER_SLUGS = {};
    let CATEGORY_SHORT_NAMES = {};
    let CATEGORY_CONFIG = [];
    let BRAND_DICTIONARY = {};
    let CATEGORY_DICTIONARY = {};

    let DATA = {categories: []}; 
    let activeCategoryIndex = -1; // 默认全部产品
    let activeBrandCode = 'all';
    let allBrands = [];
    let isExpandedBrands = false;
    let currentActiveCategoryName = null;

    function extractSpec(desc){ if(!desc) return ''; const m = desc.match(/规格:([^/]+)/); return m? m[1].trim(): ''; }
    function extractUnit(desc){ if(!desc) return ''; const m = desc.match(/单位:([^/]+)/); return m? m[1].trim(): ''; }

    function sortCategoriesByProductCountDescending(categories){
      const sorted = [...categories].sort((a,b)=> (Array.isArray(b.items)? b.items.length:0) - (Array.isArray(a.items)? a.items.length:0));
      // 将“其他”分类固定置于最后
      const idx = sorted.findIndex(c => c && (c.name === '其他' || c.name === '其它'));
      if (idx >= 0) { const other = sorted.splice(idx, 1)[0]; sorted.push(other); }
      return sorted;
    }

    function getBrandName(brandCode) {
      if (!brandCode) return '未知品牌';
      const dict = BRAND_DICTIONARY.brandDictionary || BRAND_DICTIONARY || {};
      const list = Array.isArray(dict.brands) ? dict.brands : [];
      const brand = list.find(b => b.code === brandCode);
      return brand ? (brand.shortName || brand.name || brandCode) : '未知品牌';
    }
    function getCategoryName(categoryCode) {
      if (!categoryCode) return '未知分类';
      const dict = CATEGORY_DICTIONARY.categoryDictionary || CATEGORY_DICTIONARY || {};
      const list = Array.isArray(dict.categories) ? dict.categories : [];
      const category = list.find(c => c.code === categoryCode);
      return category ? (category.shortName || category.name || categoryCode) : '未知分类';
    }

    // 当按 code 未找到时，尝试用中文名/短名回退匹配
    function getCategoryNameFallbackByText(categoryText) {
      const dict = CATEGORY_DICTIONARY.categoryDictionary || CATEGORY_DICTIONARY || {};
      const list = Array.isArray(dict.categories) ? dict.categories : [];
      const text = (categoryText || '').trim();
      if (!text) return '未知分类';
      // 先尝试精确匹配 name/shortName
      const exact = list.find(c => c.name === text || c.shortName === text);
      if (exact) return exact.shortName || exact.name;
      // 再尝试包含/模糊匹配
      const lower = text.toLowerCase();
      const fuzzy = list.find(c => (c.name || '').toLowerCase().includes(lower) || (c.shortName || '').toLowerCase().includes(lower));
      if (fuzzy) return fuzzy.shortName || fuzzy.name;
      return '未知分类';
    }

    // 综合解析商品分类显示名称：优先字典code，其次按文本名回退
    function resolveCategoryName(item){
      const byCode = getCategoryName(item.categoryCode || '');
      if (byCode && byCode !== '未知分类') return byCode;
      return getCategoryNameFallbackByText(item.categoryName || '');
    }

    // 分类数据健康检测：避免全部聚合到“099/其他”等异常情况
    function isCategoryDataHealthy(categories){
      try {
        const arr = Array.isArray(categories) ? categories : [];
        const nonEmpty = arr.filter(c => Array.isArray(c.items) && c.items.length > 0);
        const total = nonEmpty.reduce((s,c)=> s + c.items.length, 0);
        if (nonEmpty.length === 0) return false;
        // 仅 1-2 个分类通常表示云端产品缺失分类字段
        if (nonEmpty.length <= 2) return false;
        // 若“099/其他/其它”类占比过高，视为不健康
        const badNames = new Set(['099','其他','其它']);
        const badCount = nonEmpty
          .filter(c => badNames.has((c.name||'').trim()))
          .reduce((s,c)=> s + c.items.length, 0);
        const badRatio = total > 0 ? badCount / total : 1;
        if (badRatio >= 0.7) return false;
        return true;
      } catch (_) {
        return false;
      }
    }

    function loadBannerBackground(bannerEl, name){
      bannerEl.style.background = 'linear-gradient(135deg, #6ea2ff 0%, #46d9a6 100%)';
      const slug = CATEGORY_BANNER_SLUGS[name] || 'others';
      const pngUrl = `./data/banners/${slug}.png`;
      const img = new Image();
      img.onload = ()=>{ bannerEl.style.background = `linear-gradient(180deg, rgba(0,0,0,0.25), rgba(0,0,0,0.15)), url('${pngUrl}') center/cover no-repeat`; };
      img.onerror = ()=>{};
      img.src = pngUrl;
    }

    function extractBrands() {
      const brandCodes = new Set();
      DATA.categories.forEach(category => {
        (category.items || []).forEach(item => { if (item.brandCode) brandCodes.add(item.brandCode); });
      });
      const dict = BRAND_DICTIONARY.brandDictionary || BRAND_DICTIONARY || {};
      const list = Array.isArray(dict.brands) ? dict.brands : [];
      allBrands = Array.from(brandCodes).map(code => {
        const brand = list.find(b => b.code === code);
        return { code, name: brand ? (brand.shortName || brand.name || code) : '未知品牌', productCount: 0 };
      });
      allBrands.forEach(brand => {
        brand.productCount = DATA.categories.reduce((count, category) => count + (category.items || []).filter(item => item.brandCode === brand.code).length, 0);
      });
      allBrands.sort((a,b)=> b.productCount - a.productCount);
    }
    function renderBrandTabs(){
      const brandTabs = document.getElementById('brandTabs');
      brandTabs.innerHTML = `<div class="brand-tab ${activeBrandCode==='all'?'active':''}" data-brand="all"><span>全部</span></div>`;
      const visibleBrands = isExpandedBrands ? allBrands : allBrands.slice(0,8);
      visibleBrands.forEach(brand=>{
        const tab = document.createElement('div');
        tab.className = `brand-tab ${activeBrandCode===brand.code?'active':''}`;
        tab.setAttribute('data-brand', brand.code);
        const logoText = brand.name.charAt(0).toUpperCase();
        tab.innerHTML = `<div class="brand-logo">${logoText}</div><span>${brand.name} (${brand.productCount})</span>`;
        brandTabs.appendChild(tab);
      });
      const expandBtn = document.getElementById('expandBrands');
      if(expandBtn){
        expandBtn.classList.toggle('active', isExpandedBrands);
        const span = expandBtn.querySelector('span'); if(span) span.textContent = isExpandedBrands ? '⌃' : '⋯';
        expandBtn.title = isExpandedBrands ? '收起品牌' : '展开全部品牌';
      }
    }
    function setActiveBrand(code){ activeBrandCode = code; renderBrandTabs(); applyFilters(); }

    function renderCategories(categories){
      const ul = document.getElementById('categoryList'); ul.innerHTML='';
      const totalCount = categories.reduce((sum,c)=> sum + (Array.isArray(c.items)? c.items.length : 0), 0);
      const liAll = document.createElement('li'); liAll.className='category-item'; liAll.id='li-all';
      liAll.innerHTML = `<div class="label">全部产品</div><div class="badge">${totalCount}</div>`;
      liAll.addEventListener('click', ()=> setActiveAll());
      if(activeCategoryIndex===-1) liAll.classList.add('active');
      ul.appendChild(liAll);
      const sorted = sortCategoriesByProductCountDescending(categories);
      sorted.forEach((c, idx)=>{
        const li = document.createElement('li'); li.className='category-item';
        const displayName = (CATEGORY_SHORT_NAMES && CATEGORY_SHORT_NAMES[c.name]) ? CATEGORY_SHORT_NAMES[c.name] : c.name;
        li.innerHTML = `<div class="label">${displayName}</div><div class="badge">${Array.isArray(c.items)? c.items.length:0}</div>`;
        li.addEventListener('click', ()=>{ setActiveCategory(idx) });
        if(idx===activeCategoryIndex) li.classList.add('active');
        ul.appendChild(li);
      });
    }
    function setActiveCategory(idx){
      activeCategoryIndex = idx;
      const lis = document.querySelectorAll('.category-item'); lis.forEach((li,i)=>{ const isAll = li.id==='li-all'; li.classList.toggle('active', !isAll && (i-1===idx)); });
      applyFilters();
    }
    function setActiveAll(){
      activeCategoryIndex = -1;
      const lis = document.querySelectorAll('.category-item'); lis.forEach(li=> li.classList.remove('active'));
      document.getElementById('li-all')?.classList.add('active');
      applyFilters();
    }

    function applyFilters(){
      const globalQ = document.getElementById('globalSearch').value.trim().toLowerCase();
      const catQ = document.getElementById('categorySearch').value.trim().toLowerCase();
      let filteredCategories = DATA.categories;
      if(catQ){
        filteredCategories = DATA.categories.filter(c=>{
          const name = (c.name||'').toLowerCase();
          const shortName = ((CATEGORY_SHORT_NAMES&&CATEGORY_SHORT_NAMES[c.name])||'').toLowerCase();
          return name.includes(catQ) || shortName.includes(catQ);
        });
      }
      const sortedFiltered = sortCategoriesByProductCountDescending(filteredCategories);
      let items = [];
      if(activeCategoryIndex===-1){ items = sortedFiltered.flatMap(c=>c.items); currentActiveCategoryName = null; }
      else if(sortedFiltered[activeCategoryIndex]){ items = sortedFiltered[activeCategoryIndex].items; currentActiveCategoryName = sortedFiltered[activeCategoryIndex].name||null; }
      if(activeBrandCode!=='all'){ items = items.filter(it=> it.brandCode===activeBrandCode); }
      if(globalQ){
        items = items.filter(it=>{
          const fields = [it.name||'', it.description||'', it.brand||'', it.spec||'', it.unit||'', getBrandName(it.brandCode||'099')].join(' ').toLowerCase();
          return fields.includes(globalQ);
        });
      }
      renderFilteredProducts(items);
    }
    function renderFilteredProducts(items){
      const grid = document.getElementById('productGrid'); grid.innerHTML='';
      const oldBanner = document.getElementById('categoryBanner'); if(oldBanner) oldBanner.remove();
      let bannerTitle = '全部商品';
      if(activeCategoryIndex!==-1 && currentActiveCategoryName){ bannerTitle = currentActiveCategoryName; }
      if(activeBrandCode!=='all'){ const brand = allBrands.find(b=> b.code===activeBrandCode); bannerTitle += ` - ${brand? brand.name : '未知品牌'}`; }
      const banner = document.createElement('div'); banner.id='categoryBanner'; banner.className='category-banner';
      const overlay = document.createElement('div'); overlay.className='title-overlay'; overlay.textContent = bannerTitle; banner.appendChild(overlay);
      grid.parentNode.insertBefore(banner, grid);
      const categoryName = activeCategoryIndex!==-1 && currentActiveCategoryName ? currentActiveCategoryName : '全部商品';
      loadBannerBackground(banner, categoryName);
      if(items.length===0){ document.getElementById('emptyState').style.display='block'; return; }
      document.getElementById('emptyState').style.display='none';
      items.forEach(item=>{
        const card = document.createElement('div'); card.className='card';
        const img = document.createElement('div'); img.className='img';
        const imgUrl = item.image ? `./data/photos/${item.image}` : DEFAULT_PRODUCT_IMAGE;
        img.style.background = `center/contain no-repeat url('${imgUrl}')`;
        const name = document.createElement('div'); name.className='name'; name.textContent = item.name || 'Unnamed';
        const productCode = document.createElement('div'); productCode.className = 'desc'; productCode.textContent = `编号：${item.productCode || item.id || ''}`;
        const brand = document.createElement('div'); brand.className = 'desc';
        const brandName = getBrandName(item.brandCode || '099');
        brand.textContent = brandName ? `品牌：${brandName}` : '';
        const specLine = item.spec || extractSpec(item.description);
        const unitLine = item.unit || extractUnit(item.description);
        const spec = document.createElement('div'); spec.className='desc'; spec.textContent = specLine ? `规格：${specLine}` : '';
        const unit = document.createElement('div'); unit.className='desc'; unit.textContent = unitLine ? `单位：${unitLine}` : '';
        const priceRow = document.createElement('div'); priceRow.className='price-row';
        const price = document.createElement('div'); price.className='price'; price.textContent = item.price ? '¥' + item.price : '';
        const detailBtn = document.createElement('button'); detailBtn.className='add-btn'; detailBtn.textContent='查看详情'; detailBtn.addEventListener('click', () => showDetail(item));
        priceRow.appendChild(price); priceRow.appendChild(detailBtn);
        card.appendChild(img); card.appendChild(name); card.appendChild(productCode); card.appendChild(brand); card.appendChild(spec); card.appendChild(unit); card.appendChild(priceRow);
        grid.appendChild(card);
      });
    }

    const modal = document.createElement('div');
    Object.assign(modal.style, {position:'fixed',inset:'0',background:'rgba(0,0,0,0.35)',display:'none',alignItems:'center',justifyContent:'center',zIndex:'9999'});
    modal.innerHTML = `<div id="detailCard" style="background:#fff;border-radius:12px;max-width:520px;width:92%;padding:16px;box-shadow:0 6px 24px rgba(0,0,0,0.12)">
      <div style="display:flex;align-items:center;justify-content:center">
      <div style="font-weight:700">商品详情</div>
      </div>
      <div id="detailBody" style="margin-top:12px;font-size:14px;color:#333"></div>
    </div>`;
    document.body.appendChild(modal);
    const closeBtn = document.createElement('button');
    closeBtn.id = 'modalCloseRound';
    closeBtn.setAttribute('aria-label','关闭详情');
    closeBtn.textContent = '×';
    Object.assign(closeBtn.style, {position:'absolute', left:'50%', bottom:'var(--modal-close-bottom)', transform:'translateX(-50%)', width:'var(--modal-close-size)', height:'var(--modal-close-size)', borderRadius:'50%', background:'var(--modal-close-bg)', color:'var(--modal-close-color)', border:'none', display:'flex', alignItems:'center', justifyContent:'center', fontSize:'28px', lineHeight:'1', boxShadow:'0 6px 18px rgba(0,0,0,0.18)', cursor:'pointer'});
    closeBtn.addEventListener('click', ()=>{ modal.style.display='none'; });
    modal.appendChild(closeBtn);
    modal.addEventListener('click', (e)=>{ if(e.target===modal) modal.style.display='none'; });
    document.getElementById('modalClose')?.addEventListener('click', ()=> modal.style.display='none');
    function showDetail(item){
      const body = modal.querySelector('#detailBody');
      const specLine = item.spec || extractSpec(item.description);
      const unitLine = item.unit || extractUnit(item.description);
      const brandName = getBrandName(item.brandCode || '099');
      const categoryName = resolveCategoryName(item);
      body.innerHTML = `
        <div style="font-size:16px;font-weight:700">${item.name||''}</div>
        <div style="margin-top:8px;color:#666">商品编号：${item.productCode||item.id||''}</div>
        <div style="margin-top:6px;color:#666">品牌/厂商：${brandName}</div>
        <div style="margin-top:6px;color:#666">商品分类：${categoryName}</div>
        <div style="margin-top:10px;height:160px;border-radius:10px;background:center/contain no-repeat url('${item.image? `./data/photos/${item.image}` : DEFAULT_PRODUCT_IMAGE}')"></div>
        <div style="margin-top:6px;white-space:pre-line">规格：${specLine||''}</div>
        <div style="margin-top:4px">单位：${unitLine||''}</div>
        ${item.price? `<div style="margin-top:6px;color:#d64">价格：¥${item.price}</div>`: ''}
        ${item.description? `<div style="margin-top:10px;color:#888">备注：${item.description}</div>`: ''}
      `;
      modal.style.display='flex';
    }

    function setupBackToTop(){
      const content = document.querySelector('.content');
      const sidebarActions = document.getElementById('sidebarActions');
      if(!content || !sidebarActions) return;
      const btn = document.createElement('button');
      btn.className = 'backtop-btn';
      btn.textContent = '回到顶部';
      btn.addEventListener('click', ()=> content.scrollTo({top:0, behavior:'smooth'}));
      sidebarActions.appendChild(btn);
      content.addEventListener('scroll', ()=>{ const shouldShow = content.scrollTop > 300; sidebarActions.style.display = shouldShow ? 'block' : 'none'; });
    }

    function setupEventListeners(){
      document.getElementById('globalSearch').addEventListener('input', applyFilters);
      document.getElementById('categorySearch').addEventListener('input', applyFilters);
      document.getElementById('brandTabs').addEventListener('click', (e)=>{ const tab = e.target.closest('.brand-tab'); if(tab){ setActiveBrand(tab.getAttribute('data-brand')); } });
      document.getElementById('expandBrands').addEventListener('click', (e)=>{ e.preventDefault(); e.stopPropagation(); isExpandedBrands = !isExpandedBrands; renderBrandTabs(); });
    }

    async function initApp() {
      try {
        let productsData, configData, brandData, categoryData;

        if (USE_MYSQL) {
          // 使用MySQL数据源
          [productsData, configData, brandData, categoryData] = await Promise.all([
            loadProductsFromMySQL(),
            loadCategoryMetaFromMySQL(),
            loadBrandDictionaryFromMySQL(),
            loadCategoryDictionaryFromMySQL()
          ]);
        } else if (USE_CLOUDBASE) {
          // 使用CloudBase数据源
          [productsData, configData, brandData, categoryData] = await Promise.all([
            loadProductsFromCloudBase(),
            loadCategoryMetaFromCloudBase(),
            loadBrandDictionaryFromCloudBase(),
            loadCategoryDictionaryFromCloudBase()
          ]);
        } else {
          // 使用本地JSON文件
          [productsData, configData, brandData, categoryData] = await Promise.all([
            fetch(FETCH_URL).then(r => r.json()),
            fetch(CONFIG_URL).then(r => r.json()).catch(() => ({banner_slugs: {}, short_names: {}})),
            fetch(BRAND_DICTIONARY_URL).then(r => r.json()).catch(() => ({brandDictionary: {brands: []}})),
            fetch(CATEGORY_DICTIONARY_URL).then(r => r.json()).catch(() => ({categoryDictionary: {categories: []}}))
          ]);
        }

        DATA = productsData;
        CATEGORY_BANNER_SLUGS = (configData.CATEGORY_BANNER_SLUGS || configData.banner_slugs || {});
        CATEGORY_SHORT_NAMES = (configData.CATEGORY_SHORT_NAMES || configData.short_names || {});
        BRAND_DICTIONARY = brandData;
        CATEGORY_DICTIONARY = categoryData;
        extractBrands();
        renderCategories(DATA.categories);
        renderBrandTabs();
        setupEventListeners();
        setupBackToTop();
        applyFilters();
      } catch (error) {
        console.error('初始化失败:', error);
        const empty = document.getElementById('emptyState'); if(empty){ empty.style.display='block'; empty.textContent='加载失败，请刷新页面重试。'; }
      }
    }

    async function loadProductsFromCloudBase() {
      try {
        const app = cloudbase.init({ env: CLOUDBASE_ENV });
        // 修正匿名登录方式以兼容当前 SDK
        await app.auth({ persistence: (config.auth && config.auth.persistence) || 'local' }).signInAnonymously();
        const db = app.database();
        const _ = db.command;
        // 统一读取 CloudBase 中的产品集合与文档ID
        const productsCollection = (window.CLOUDBASE_CONFIG && window.CLOUDBASE_CONFIG.database && window.CLOUDBASE_CONFIG.database.productsCollection) || 'products';
        const catalogDocId = (window.CLOUDBASE_CONFIG && window.CLOUDBASE_CONFIG.database && window.CLOUDBASE_CONFIG.database.catalogDocId) || 'catalog-data';

        // 优先读取集合内的所有产品文档（排除 catalog-data 汇总文档）
        let all = [];
        let skip = 0;
        const batchSize = 100;
        while (true) {
          const res = await db
            .collection(productsCollection)
            .where({ _id: _.neq(catalogDocId) })
            .skip(skip)
            .limit(batchSize)
            .get();
          const list = res.data || [];
          if (!list.length) break;
          all = all.concat(list);
          skip += batchSize;
          if (list.length < batchSize) break;
        }

        if (all.length > 0) {
          // 基于 categoryCode 或 categoryName 分组为 categories（不依赖字典加载先行）
          const map = new Map();
          all.forEach(p => {
            const keyCode = p.categoryCode || '099';
            const keyName = p.categoryName || keyCode || '其他';
            if (!map.has(keyName)) map.set(keyName, []);
            map.get(keyName).push(p);
          });
          const categories = Array.from(map.entries()).map(([name, items]) => ({ name, items }));
          // 健康检查失败则回退到本地 products.json
          if (!isCategoryDataHealthy(categories)) {
            console.warn('检测到云端分类数据异常，回退到本地 JSON 数据源');
            return await fetch(FETCH_URL).then(r => r.json());
          }
          return { categories, updatedAt: Date.now(), count: all.length, version: 'cloud-collection' };
        }

        // 若集合为空，回退读取 catalog-data 文档
        const fallback = await db.collection(productsCollection).doc(catalogDocId).get();
        if (fallback.data && fallback.data.length > 0) {
          const doc = fallback.data[0] || {};
          if (Array.isArray(doc.products)) {
            const map = new Map();
            doc.products.forEach(p => {
              const key = p.categoryName || p.categoryCode || '其他';
              if (!map.has(key)) map.set(key, []);
              map.get(key).push(p);
            });
            const categories = Array.from(map.entries()).map(([name, items]) => ({ name, items }));
            if (!isCategoryDataHealthy(categories)) {
              console.warn('检测到 catalog-data 分类异常，回退到本地 JSON 数据源');
              return await fetch(FETCH_URL).then(r => r.json());
            }
            return { categories, updatedAt: doc.updatedAt, count: doc.count, version: 'cloud-products' };
          }
          if (Array.isArray(doc.categories)) return doc;
          throw new Error('CloudBase 文档缺少 products/categories 字段');
        } else {
          throw new Error('CloudBase 数据为空');
        }
      } catch (error) {
        console.warn('CloudBase 加载失败，回退到本地数据:', error);
        return fetch(FETCH_URL).then(r => r.json());
      }
    }

    async function loadCategoryMetaFromCloudBase() {
      try {
        const app = cloudbase.init({ env: CLOUDBASE_ENV });
        await app.auth({ persistence: (config.auth && config.auth.persistence) || 'local' }).signInAnonymously();
        const db = app.database();
        const configCollection = (window.CLOUDBASE_CONFIG && window.CLOUDBASE_CONFIG.database && window.CLOUDBASE_CONFIG.database.configCollection) || 'config';
        const configDocId = (window.CLOUDBASE_CONFIG && window.CLOUDBASE_CONFIG.database && window.CLOUDBASE_CONFIG.database.configDocId) || 'category-config';
        const res = await db.collection(configCollection).doc(configDocId).get();
        if (res.data && res.data.length) {
          const doc = res.data[0] || {};
          return {
            CATEGORY_BANNER_SLUGS: doc.CATEGORY_BANNER_SLUGS || doc.banner_slugs || {},
            CATEGORY_SHORT_NAMES: doc.CATEGORY_SHORT_NAMES || doc.short_names || {}
          };
        } else {
          throw new Error('CloudBase 配置数据为空');
        }
      } catch (err) {
        console.warn('CloudBase 配置加载失败，回退到本地配置:', err);
        return fetch(CONFIG_URL).then(r => r.json()).catch(() => ({banner_slugs: {}, short_names: {}}));
      }
    }

    async function loadBrandDictionaryFromCloudBase() {
      try {
        const app = cloudbase.init({ env: CLOUDBASE_ENV });
        await app.auth({ persistence: (config.auth && config.auth.persistence) || 'local' }).signInAnonymously();
        const db = app.database();
        const configCollection = (window.CLOUDBASE_CONFIG && window.CLOUDBASE_CONFIG.database && window.CLOUDBASE_CONFIG.database.configCollection) || 'config';
        const res = await db.collection(configCollection).doc('brand-dictionary').get();
        if (res.data && res.data.length) {
          return res.data[0];
        } else {
          throw new Error('CloudBase 品牌字典为空');
        }
      } catch (err) {
        console.warn('CloudBase 品牌字典加载失败，回退到本地:', err);
        return fetch(BRAND_DICTIONARY_URL).then(r => r.json()).catch(() => ({brandDictionary: {brands: []}}));
      }
    }

    async function loadCategoryDictionaryFromCloudBase() {
      try {
        const app = cloudbase.init({ env: CLOUDBASE_ENV });
        await app.auth({ persistence: (config.auth && config.auth.persistence) || 'local' }).signInAnonymously();
        const db = app.database();
        const configCollection = (window.CLOUDBASE_CONFIG && window.CLOUDBASE_CONFIG.database && window.CLOUDBASE_CONFIG.database.configCollection) || 'config';
        const res = await db.collection(configCollection).doc('category-dictionary').get();
        if (res.data && res.data.length) {
          return res.data[0];
        } else {
          throw new Error('CloudBase 分类字典为空');
        }
      } catch (err) {
        console.warn('CloudBase 分类字典加载失败，回退到本地:', err);
        return fetch(CATEGORY_DICTIONARY_URL).then(r => r.json()).catch(() => ({categoryDictionary: {categories: []}}));
      }
    }

    // MySQL数据加载函数
    async function callCloudFunction(functionName, data = {}) {
      try {
        const app = cloudbase.init({ env: CLOUDBASE_ENV });
        await app.auth({ persistence: (config.auth && config.auth.persistence) || 'local' }).signInAnonymously();
        const result = await app.callFunction({
          name: functionName,
          data: {
            ...data,
            databaseUrl: config.mysql?.databaseUrl
          }
        });

        if (result.result && result.result.ok) {
          return result.result.data;
        } else {
          throw new Error(result.result?.error || '云函数调用失败');
        }
      } catch (error) {
        console.error(`调用云函数 ${functionName} 失败:`, error);
        throw error;
      }
    }

    async function loadProductsFromMySQL() {
      try {
        const data = await callCloudFunction(config.mysql?.queryFunction || 'mysqlQuery', { action: 'products' });

        // 健康检查
        if (!data || !Array.isArray(data.categories)) {
          throw new Error('MySQL产品数据格式异常');
        }

        if (!isCategoryDataHealthy(data.categories)) {
          console.warn('检测到MySQL分类数据异常，回退到本地 JSON 数据源');
          return await fetch(FETCH_URL).then(r => r.json());
        }

        return data;
      } catch (error) {
        console.warn('MySQL产品数据加载失败，回退到本地数据:', error);
        return fetch(FETCH_URL).then(r => r.json());
      }
    }

    async function loadCategoryMetaFromMySQL() {
      try {
        const data = await callCloudFunction(config.mysql?.queryFunction || 'mysqlQuery', { action: 'config' });
        return {
          CATEGORY_BANNER_SLUGS: data.banner_slugs || {},
          CATEGORY_SHORT_NAMES: data.short_names || {},
          banner_slugs: data.banner_slugs || {},
          short_names: data.short_names || {}
        };
      } catch (error) {
        console.warn('MySQL分类配置加载失败，回退到本地配置:', error);
        return fetch(CONFIG_URL).then(r => r.json()).catch(() => ({banner_slugs: {}, short_names: {}}));
      }
    }

    async function loadBrandDictionaryFromMySQL() {
      try {
        const data = await callCloudFunction(config.mysql?.queryFunction || 'mysqlQuery', { action: 'brands' });
        return data;
      } catch (error) {
        console.warn('MySQL品牌字典加载失败，回退到本地:', error);
        return fetch(BRAND_DICTIONARY_URL).then(r => r.json()).catch(() => ({brandDictionary: {brands: []}}));
      }
    }

    async function loadCategoryDictionaryFromMySQL() {
      try {
        const data = await callCloudFunction(config.mysql?.queryFunction || 'mysqlQuery', { action: 'categories' });
        return data;
      } catch (error) {
        console.warn('MySQL分类字典加载失败，回退到本地:', error);
        return fetch(CATEGORY_DICTIONARY_URL).then(r => r.json()).catch(() => ({categoryDictionary: {categories: []}}));
      }
    }

    initApp();
  </script>
</body>
</html>