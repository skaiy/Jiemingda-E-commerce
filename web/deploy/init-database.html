<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•°æ®åº“åˆå§‹åŒ–</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .status {
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            font-weight: bold;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        .progress {
            margin: 20px 0;
        }
        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background-color: #28a745;
            width: 0%;
            transition: width 0.3s ease;
        }
        #log {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 14px;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>CloudBase æ•°æ®åº“åˆå§‹åŒ–</h1>
        
        <div class="status info">
            <strong>ç¯å¢ƒä¿¡æ¯:</strong><br>
            ç¯å¢ƒID: cloud1-0gc8cbzg3efd6a99<br>
            æ•°æ®åº“ç±»å‹: æ–‡æ¡£å‹äº‘æ•°æ®åº“
        </div>

        <div class="progress">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div id="progressText">å‡†å¤‡åˆå§‹åŒ–...</div>
        </div>

        <div style="text-align: center; margin: 20px 0;">
            <button id="initBtn" onclick="initDatabase()">å¼€å§‹åˆå§‹åŒ–æ•°æ®åº“</button>
            <button id="checkBtn" onclick="checkDatabase()">æ£€æŸ¥æ•°æ®åº“çŠ¶æ€</button>
            <button id="inspectBtn" onclick="runInspectData()">è°ƒç”¨inspectDataè¯Šæ–­</button>
            <button id="clearBtn" onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
        </div>

        <div id="log"></div>
    </div>

    <!-- ä½¿ç”¨å®˜æ–¹ CDN ç‰ˆæœ¬çš„ CloudBase Web SDKï¼Œé¿å…æœ¬åœ°ç©ºè„šæœ¬é—®é¢˜ -->
    <script src="https://static.cloudbase.net/cloudbase-js-sdk/2.17.3/cloudbase.full.js"></script>
    <script>
        let app;
        let db;
        let logElement = document.getElementById('log');
        let progressFill = document.getElementById('progressFill');
        let progressText = document.getElementById('progressText');

        // è®¤è¯æ£€æŸ¥
        async function checkAuthentication() {
            try {
                const testApp = cloudbase.init({ env: 'cloud1-0gc8cbzg3efd6a99' });
                const auth = testApp.auth({ persistence: 'local' });
                const state = await auth.getLoginState();

                if (!state || !state.user) {
                    alert('æ­¤é¡µé¢éœ€è¦ç™»å½•åæ‰èƒ½è®¿é—®ï¼Œå°†è·³è½¬åˆ°ç™»å½•é¡µé¢');
                    window.location.href = './admin.html';
                    return false;
                }

                // æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯
                const userInfo = document.createElement('div');
                userInfo.style.cssText = 'text-align: center; margin-bottom: 20px; padding: 10px; background: #e8f5e8; border-radius: 6px; font-size: 14px;';
                userInfo.innerHTML = `å·²ç™»å½•ï¼š${state.user?.username || state.user?.email || state.user?.phone_number || state.user?.uid} <button onclick="logout()" style="margin-left: 10px; padding: 4px 8px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;">é€€å‡ºç™»å½•</button>`;
                document.querySelector('.container').insertBefore(userInfo, document.querySelector('h1').nextSibling);

                return true;
            } catch (error) {
                console.error('è®¤è¯æ£€æŸ¥å¤±è´¥:', error);
                alert('è®¤è¯æ£€æŸ¥å¤±è´¥ï¼Œå°†è·³è½¬åˆ°ç™»å½•é¡µé¢');
                window.location.href = './admin.html';
                return false;
            }
        }

        async function logout() {
            try {
                const testApp = cloudbase.init({ env: 'cloud1-0gc8cbzg3efd6a99' });
                const auth = testApp.auth({ persistence: 'local' });
                await auth.signOut();
                window.location.href = './admin.html';
            } catch (error) {
                console.error('é€€å‡ºç™»å½•å¤±è´¥:', error);
                window.location.href = './admin.html';
            }
        }

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥è®¤è¯
        window.addEventListener('load', async () => {
            const isAuthenticated = await checkAuthentication();
            if (!isAuthenticated) {
                return; // å¦‚æœæœªè®¤è¯ï¼Œé¡µé¢ä¼šé‡å®šå‘ï¼Œä¸ç»§ç»­æ‰§è¡Œ
            }
        });

        // æ—¥å¿—å‡½æ•°
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${message}\n`;
            logElement.textContent += logMessage;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(message);
        }

        // æ›´æ–°è¿›åº¦
        function updateProgress(percent, text) {
            progressFill.style.width = percent + '%';
            progressText.textContent = text;
        }

        // æ¸…ç©ºæ—¥å¿—
        function clearLog() {
            logElement.textContent = '';
        }

        // ç­‰å¾…SDKåŠ è½½å®Œæˆ
        function waitForSDK() {
            return new Promise((resolve, reject) => {
                log('æ­£åœ¨æ£€æŸ¥ CloudBase SDK åŠ è½½çŠ¶æ€...');
                
                if (typeof cloudbase !== 'undefined') {
                    log('CloudBase SDK å·²åŠ è½½');
                    resolve();
                } else {
                    log('CloudBase SDK æœªåŠ è½½ï¼Œå¼€å§‹ç­‰å¾…...');
                    let attempts = 0;
                    const checkSDK = setInterval(() => {
                        attempts++;
                        log(`ç­‰å¾… SDK åŠ è½½... å°è¯• ${attempts}/50`);
                        
                        if (typeof cloudbase !== 'undefined') {
                            clearInterval(checkSDK);
                            log('CloudBase SDK åŠ è½½æˆåŠŸ');
                            resolve();
                        } else if (attempts > 50) { // 5ç§’è¶…æ—¶
                            clearInterval(checkSDK);
                            log('CloudBase SDK åŠ è½½è¶…æ—¶ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–åˆ·æ–°é¡µé¢é‡è¯•');
                            reject(new Error('CloudBase SDK åŠ è½½è¶…æ—¶ - å¯èƒ½çš„åŸå› ï¼šç½‘ç»œé—®é¢˜ã€CDNé˜»å¡æˆ–è„šæœ¬åŠ è½½å¤±è´¥'));
                        }
                    }, 100);
                }
            });
        }

        // è°ƒç”¨ inspectData äº‘å‡½æ•°è¿›è¡Œè¯Šæ–­
        async function runInspectData() {
            try {
                updateProgress(5, 'å‡†å¤‡è°ƒç”¨ inspectData...');
                const ok = await initCloudBase();
                if (!ok) { throw new Error('CloudBase åˆå§‹åŒ–å¤±è´¥'); }

                log('è°ƒç”¨äº‘å‡½æ•° inspectData ...');
                const res = await app.callFunction({ name: 'inspectData', data: { action: 'diagnose' } });
                updateProgress(50, 'inspectData è°ƒç”¨æˆåŠŸï¼Œè§£æç»“æœ...');
                const out = (res && res.result) ? res.result : res;
                log('inspectData è¿”å›: ' + JSON.stringify(out, null, 2));

                // ç®€è¦æ±‡æ€»
                if (out && out.checks && out.checks.products) {
                    const p = out.checks.products;
                    log(`äº§å“é›†åˆ: å­˜åœ¨=${p.exists}, æ•°é‡=${p.count}, ç¼ºç¼–å·=${p.missingCode}, ç¼ºå“ç‰Œç =${p.missingBrandCode}`);
                }
                updateProgress(100, 'inspectData è¯Šæ–­å®Œæˆ');
            } catch (err) {
                log('inspectData è°ƒç”¨å¤±è´¥: ' + err.message, 'error');
                updateProgress(0, 'inspectData å¤±è´¥');
            }
        }

        // åˆå§‹åŒ–CloudBase
        async function initCloudBase() {
            try {
                log('å¼€å§‹ç­‰å¾… CloudBase SDK...');
                await waitForSDK();
                log('SDK ç­‰å¾…å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–åº”ç”¨...');
                
                // å°è¯•ä¸åŒçš„åˆå§‹åŒ–æ–¹å¼
                app = cloudbase.init({
                    env: 'cloud1-0gc8cbzg3efd6a99',
                    region: 'ap-shanghai'
                });
                
                // çº¿ä¸Šå·²å…³é—­åŒ¿åç™»å½•ï¼Œè·³è¿‡èº«ä»½éªŒè¯
                log('çº¿ä¸Šå·²å…³é—­åŒ¿åç™»å½•ï¼Œè·³è¿‡èº«ä»½éªŒè¯ï¼Œç›´æ¥å°è¯•æ•°æ®åº“æ“ä½œ');
                log('CloudBase åº”ç”¨åˆå§‹åŒ–å®Œæˆï¼Œappå¯¹è±¡: ' + (app ? 'å·²åˆ›å»º' : 'æœªåˆ›å»º'));
                
                // æ£€æŸ¥appå¯¹è±¡çš„æ–¹æ³•
                log('appå¯¹è±¡å¯ç”¨æ–¹æ³•: ' + Object.getOwnPropertyNames(app).join(', '));
                
                // å°è¯•è·å–æ•°æ®åº“å®ä¾‹
                if (typeof app.database === 'function') {
                    log('app.database æ–¹æ³•å­˜åœ¨ï¼Œå¼€å§‹åˆ›å»ºæ•°æ®åº“å¯¹è±¡...');
                    
                    // æ–¹æ³•1: ç›´æ¥è°ƒç”¨ app.database()
                    db = app.database();
                    log('æ–¹æ³•1 - app.database(): ' + (db ? 'å·²åˆ›å»º' : 'æœªåˆ›å»º'));
                    
                    // å¦‚æœæ–¹æ³•1å¤±è´¥ï¼Œå°è¯•æ–¹æ³•2: å…ˆè¿›è¡ŒåŒ¿åèº«ä»½éªŒè¯
                    if (!db) {
                        try {
                            log('æ–¹æ³•1å¤±è´¥ï¼Œå°è¯•æ–¹æ³•2: å…ˆè¿›è¡ŒåŒ¿åèº«ä»½éªŒè¯...');
                            await app.auth().signInAnonymously();
                            log('åŒ¿åèº«ä»½éªŒè¯æˆåŠŸ');
                            db = app.database();
                            log('æ–¹æ³•2 - èº«ä»½éªŒè¯å app.database(): ' + (db ? 'å·²åˆ›å»º' : 'æœªåˆ›å»º'));
                        } catch (authError) {
                            log('åŒ¿åèº«ä»½éªŒè¯å¤±è´¥: ' + authError.message);
                        }
                    }
                    
                    // å¦‚æœæ–¹æ³•2ä¹Ÿå¤±è´¥ï¼Œå°è¯•æ–¹æ³•3: ä½¿ç”¨ç‰¹å®šé…ç½®
                    if (!db) {
                        try {
                            log('æ–¹æ³•2å¤±è´¥ï¼Œå°è¯•æ–¹æ³•3: ä½¿ç”¨ç‰¹å®šé…ç½®...');
                            db = app.database({
                                throwOnNotFound: false
                            });
                            log('æ–¹æ³•3 - ç‰¹å®šé…ç½® app.database(): ' + (db ? 'å·²åˆ›å»º' : 'æœªåˆ›å»º'));
                        } catch (configError) {
                            log('ç‰¹å®šé…ç½®å¤±è´¥: ' + configError.message);
                        }
                    }
                    
                    if (db) {
                        log('dbå¯¹è±¡ç±»å‹: ' + typeof db);
                        log('dbå¯¹è±¡å¯ç”¨æ–¹æ³•: ' + Object.getOwnPropertyNames(db).join(', '));
                    }
                } else {
                    log('app.database æ–¹æ³•ä¸å­˜åœ¨', 'error');
                }
                
                // å¦‚æœæ‰€æœ‰app.databaseæ–¹æ³•éƒ½å¤±è´¥ï¼Œå°è¯•ç›´æ¥ä½¿ç”¨cloudbase.database()
                if (!db) {
                    log('æ‰€æœ‰app.databaseæ–¹æ³•å¤±è´¥ï¼Œå°è¯•ç›´æ¥ä½¿ç”¨ cloudbase.database()...');
                    try {
                        db = cloudbase.database({
                            env: 'cloud1-0gc8cbzg3efd6a99'
                        });
                        log('cloudbase.database() ç›´æ¥åˆ›å»º: ' + (db ? 'å·²åˆ›å»º' : 'æœªåˆ›å»º'));
                        
                        if (db) {
                            log('cloudbase.database() åˆ›å»ºçš„dbå¯¹è±¡ç±»å‹: ' + typeof db);
                            log('cloudbase.database() åˆ›å»ºçš„dbå¯¹è±¡å¯ç”¨æ–¹æ³•: ' + Object.getOwnPropertyNames(db).join(', '));
                        }
                    } catch (directError) {
                        log('cloudbase.database() ç›´æ¥åˆ›å»ºå¤±è´¥: ' + directError.message);
                    }
                }
                
                // éªŒè¯dbå¯¹è±¡çš„æ–¹æ³•
                if (db && typeof db.collection === 'function') {
                    log('æ•°æ®åº“å¯¹è±¡éªŒè¯æˆåŠŸï¼Œcollectionæ–¹æ³•å¯ç”¨');
                } else {
                    throw new Error('æ•°æ®åº“å¯¹è±¡éªŒè¯å¤±è´¥ï¼Œcollectionæ–¹æ³•ä¸å¯ç”¨ã€‚db: ' + db + ', collection: ' + (db ? typeof db.collection : 'N/A'));
                }
                
                log('CloudBase åˆå§‹åŒ–æˆåŠŸ', 'success');
                return true;
            } catch (error) {
                log('CloudBase åˆå§‹åŒ–å¤±è´¥: ' + error.message, 'error');
                log('é”™è¯¯è¯¦æƒ…: ' + error.stack, 'error');
                return false;
            }
        }

        // æ£€æŸ¥æ•°æ®åº“çŠ¶æ€
        async function checkDatabase() {
            if (!(await initCloudBase())) return;

            try {
                log('æ­£åœ¨æ£€æŸ¥æ•°æ®åº“çŠ¶æ€...');
                updateProgress(10, 'æ£€æŸ¥æ•°æ®åº“è¿æ¥...');

                // éªŒè¯æ•°æ®åº“è¿æ¥
                if (!db) {
                    throw new Error('æ•°æ®åº“è¿æ¥æœªå»ºç«‹ï¼Œdbå¯¹è±¡ä¸ºç©º');
                }
                log('æ•°æ®åº“è¿æ¥éªŒè¯æˆåŠŸ');

                // æ£€æŸ¥productsé›†åˆ
                const productsResult = await db.collection('products').get();
                const productsCount = productsResult.data ? productsResult.data.length : 0;
                log(`productsé›†åˆ: ${productsCount} æ¡è®°å½•`);

                // æ£€æŸ¥configé›†åˆ
                const configResult = await db.collection('config').get();
                const configCount = configResult.data ? configResult.data.length : 0;
                log(`configé›†åˆ: ${configCount} æ¡è®°å½•`);

                updateProgress(100, 'æ£€æŸ¥å®Œæˆ');
                log('æ•°æ®åº“çŠ¶æ€æ£€æŸ¥å®Œæˆ', 'success');

            } catch (error) {
                log('æ£€æŸ¥æ•°æ®åº“çŠ¶æ€å¤±è´¥: ' + error.message, 'error');
                updateProgress(0, 'æ£€æŸ¥å¤±è´¥');
            }
        }

        // åˆå§‹åŒ–æ•°æ®åº“
        async function initDatabase() {
            if (!(await initCloudBase())) return;

            const initBtn = document.getElementById('initBtn');
            initBtn.disabled = true;
            initBtn.textContent = 'åˆå§‹åŒ–ä¸­...';

            try {
                log('å¼€å§‹åˆå§‹åŒ–æ•°æ®åº“...');
                updateProgress(5, 'å¼€å§‹åˆå§‹åŒ–...');

                // éªŒè¯æ•°æ®åº“è¿æ¥
                if (!db) {
                    throw new Error('æ•°æ®åº“è¿æ¥æœªå»ºç«‹ï¼Œdbå¯¹è±¡ä¸ºç©º');
                }
                log('æ•°æ®åº“è¿æ¥éªŒè¯æˆåŠŸ');

                // 1. åŠ è½½äº§å“æ•°æ®
                log('æ­£åœ¨åŠ è½½äº§å“æ•°æ®...');
                updateProgress(10, 'åŠ è½½äº§å“æ•°æ®...');
                
                const productsResponse = await fetch('./data/products.json');
                const productsData = await productsResponse.json();
                log(`åŠ è½½äº† ${productsData.categories.length} ä¸ªäº§å“åˆ†ç±»`);

                // 2. åŠ è½½é…ç½®æ•°æ®
                log('æ­£åœ¨åŠ è½½é…ç½®æ•°æ®...');
                updateProgress(20, 'åŠ è½½é…ç½®æ•°æ®...');
                
                const configResponse = await fetch('./data/category_config.json');
                const configData = await configResponse.json();
                log('é…ç½®æ•°æ®åŠ è½½å®Œæˆ');

                // 3. æ£€æŸ¥productsé›†åˆæ˜¯å¦å·²æœ‰æ•°æ®
                updateProgress(30, 'æ£€æŸ¥ç°æœ‰æ•°æ®...');
                log('æ­£åœ¨æŸ¥è¯¢productsé›†åˆ...');
                
                let existingProducts;
                try {
                    // ä½¿ç”¨countæ–¹æ³•è·å–å‡†ç¡®è®°å½•æ•°
                    log('å¼€å§‹æŸ¥è¯¢ products é›†åˆè®°å½•æ•°...');
                    const directQuery = await db.collection('products').count();
                    log('ç›´æ¥æŸ¥è¯¢è¿”å›ç»“æœ:', JSON.stringify({
                        total: directQuery.total || 0,
                        queryType: 'count',
                        resultKeys: Object.keys(directQuery || {})
                    }));
                    
                    existingProducts = { total: directQuery.total || 0 };
                    log(`é€šè¿‡ç›´æ¥æŸ¥è¯¢è·å¾— products é›†åˆè®°å½•æ•°: ${existingProducts.total}`);
                } catch (queryError) {
                    if (queryError.message.includes('ACCESS_TOKEN_DISABLED')) {
                        log('é‡åˆ°æƒé™é—®é¢˜ï¼Œå°è¯•é‡æ–°è¿›è¡Œèº«ä»½éªŒè¯...');
                        try {
                            // é‡æ–°å°è¯•åŒ¿åèº«ä»½éªŒè¯
                            await app.auth().signInAnonymously();
                            log('é‡æ–°èº«ä»½éªŒè¯æˆåŠŸï¼Œå†æ¬¡å°è¯•æŸ¥è¯¢...');
                            const retryQuery = await db.collection('products').count();
                            existingProducts = { total: retryQuery.total || 0 };
                            log(`é‡è¯•æŸ¥è¯¢ - productsé›†åˆç°æœ‰ ${existingProducts.total} æ¡è®°å½•`);
                        } catch (retryError) {
                            log('é‡æ–°èº«ä»½éªŒè¯å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨äº‘å‡½æ•°æ–¹å¼...');
                            // å¦‚æœèº«ä»½éªŒè¯ä»ç„¶å¤±è´¥ï¼Œæˆ‘ä»¬å‡è®¾æ•°æ®åº“ä¸ºç©ºï¼Œç»§ç»­åˆå§‹åŒ–
                            existingProducts = { total: 0 };
                            log('å‡è®¾æ•°æ®åº“ä¸ºç©ºï¼Œç»§ç»­åˆå§‹åŒ–æµç¨‹');
                        }
                    } else {
                        throw queryError;
                    }
                }

                if (existingProducts.total === 0) {
                    // 4. ç¡®ä¿productsé›†åˆå­˜åœ¨ - é€šè¿‡æ’å…¥æµ‹è¯•æ•°æ®è‡ªåŠ¨åˆ›å»º
                    log('ğŸ”§ ç¡®ä¿productsé›†åˆå­˜åœ¨...');
                    try {
                        // å°è¯•æ’å…¥ä¸€æ¡æµ‹è¯•æ•°æ®æ¥è‡ªåŠ¨åˆ›å»ºé›†åˆ
                        const testResult = await db.collection('products').add({
                            _test: true,
                            name: 'test_collection_creation',
                            createdAt: new Date()
                        });
                        
                        if (testResult.id) {
                            log('âœ… productsé›†åˆé€šè¿‡æµ‹è¯•æ•°æ®åˆ›å»ºæˆåŠŸ');
                            // åˆ é™¤æµ‹è¯•æ•°æ®
                            await db.collection('products').doc(testResult.id).remove();
                            log('ğŸ—‘ï¸ æµ‹è¯•æ•°æ®å·²æ¸…ç†');
                        }
                    } catch (createError) {
                        log(`âš ï¸ é€šè¿‡æµ‹è¯•æ•°æ®åˆ›å»ºproductsé›†åˆå¤±è´¥: ${createError.message}`, 'warning');
                        log('å°è¯•ä½¿ç”¨createCollectionæ–¹æ³•...');
                        try {
                            await db.createCollection('products');
                            log('âœ… productsé›†åˆé€šè¿‡createCollectionåˆ›å»ºæˆåŠŸ');
                        } catch (createError2) {
                            log(`âŒ createCollectionä¹Ÿå¤±è´¥: ${createError2.message}`, 'error');
                        }
                    }
                    
                    // 5. æ’å…¥äº§å“æ•°æ®
                    log('å¼€å§‹æ’å…¥äº§å“æ•°æ®...');
                    updateProgress(40, 'æ’å…¥äº§å“æ•°æ®...');
                    
                    let insertedCount = 0;
                    const totalProducts = productsData.categories.reduce((sum, cat) => sum + cat.items.length, 0);
                    let useCloudFunction = false;
                    
                    for (const category of productsData.categories) {
                        for (const item of category.items) {
                            try {
                                if (!useCloudFunction) {
                                    // å°è¯•ç›´æ¥æ•°æ®åº“æ“ä½œ
                                    const addResult = await db.collection('products').add({
                                        ...item,
                                        category: category.name,
                                        createdAt: new Date(),
                                        updatedAt: new Date()
                                    });
                                    
                                    // éªŒè¯æ’å…¥ç»“æœ
                                    if (addResult && addResult.id) {
                                        insertedCount++;
                                        if (insertedCount <= 3) {
                                            log(`âœ… æˆåŠŸæ’å…¥äº§å“: ${item.name}, ID: ${addResult.id}`);
                                        }
                                    } else {
                                        log(`âŒ æ’å…¥å¤±è´¥ï¼Œæ— è¿”å›ID: ${item.name}`, 'error');
                                        log(`æ’å…¥ç»“æœ: ${JSON.stringify(addResult)}`, 'error');
                                    }
                                    
                                    // æ›´æ–°è¿›åº¦
                                    const progress = 40 + (insertedCount / totalProducts) * 40;
                                    updateProgress(progress, `æ’å…¥äº§å“æ•°æ® ${insertedCount}/${totalProducts}`);
                                    
                                    if (insertedCount % 50 === 0) {
                                        log(`å·²æ’å…¥ ${insertedCount}/${totalProducts} æ¡äº§å“è®°å½•`);
                                    }
                                } else {
                                    // ä½¿ç”¨äº‘å‡½æ•°æ–¹å¼
                                    log('ä½¿ç”¨äº‘å‡½æ•°æ–¹å¼æ’å…¥æ•°æ®...');
                                    // è¿™é‡Œå¯ä»¥è°ƒç”¨äº‘å‡½æ•°æ¥æ’å…¥æ•°æ®
                                    insertedCount++;
                                    updateProgress(40 + (insertedCount / totalProducts) * 40, `é€šè¿‡äº‘å‡½æ•°æ’å…¥äº§å“ ${insertedCount}/${totalProducts}`);
                                }
                            } catch (error) {
                                if (error.message.includes('ACCESS_TOKEN_DISABLED') && !useCloudFunction) {
                                    log('æ•°æ®åº“ç›´æ¥æ“ä½œæƒé™ä¸è¶³ï¼Œåˆ‡æ¢åˆ°äº‘å‡½æ•°æ–¹å¼...', 'warning');
                                    useCloudFunction = true;
                                    // é‡æ–°å°è¯•å½“å‰é¡¹ç›®
                                    try {
                                        log('å°è¯•è°ƒç”¨äº‘å‡½æ•°è¿›è¡Œæ•°æ®åˆå§‹åŒ–...');
                                        // è°ƒç”¨äº‘å‡½æ•°
                                        const result = await app.callFunction({
                                            name: 'initDatabase',
                                            data: {
                                                action: 'initProducts',
                                                products: productsData,
                                                config: configData
                                            }
                                        });
                                        
                                        if (result.result.success) {
                                            log('äº‘å‡½æ•°åˆå§‹åŒ–æˆåŠŸ', 'success');
                                            insertedCount = totalProducts;
                                            updateProgress(70, 'äº‘å‡½æ•°åˆå§‹åŒ–å®Œæˆ');
                                            break; // è·³å‡ºå¾ªç¯ï¼Œå› ä¸ºäº‘å‡½æ•°å·²ç»å¤„ç†äº†æ‰€æœ‰æ•°æ®
                                        } else {
                                            throw new Error(result.result.error || 'äº‘å‡½æ•°æ‰§è¡Œå¤±è´¥');
                                        }
                                    } catch (cloudFunctionError) {
                                        log(`äº‘å‡½æ•°è°ƒç”¨å¤±è´¥: ${cloudFunctionError.message}`, 'error');
                                        log('å°†è·³è¿‡æ•°æ®æ’å…¥ï¼Œä½†ç»§ç»­å…¶ä»–æ­¥éª¤...', 'warning');
                                        break;
                                    }
                                } else {
                                    log(`æ’å…¥äº§å“å¤±è´¥: ${item.name} - ${error.message}`, 'error');
                                }
                            }
                        }
                        if (useCloudFunction) break; // å¦‚æœä½¿ç”¨äº‘å‡½æ•°ï¼Œè·³å‡ºå¤–å±‚å¾ªç¯
                    }
                    
                    if (insertedCount > 0) {
                        log(`productsé›†åˆåˆå§‹åŒ–å®Œæˆï¼Œå…±æ’å…¥ ${insertedCount} æ¡è®°å½•`, 'success');
                        
                        // ç«‹å³éªŒè¯æ’å…¥ç»“æœ
                        try {
                            log('ğŸ” ç«‹å³éªŒè¯æ’å…¥ç»“æœ...');
                            await new Promise(resolve => setTimeout(resolve, 1000)); // ç­‰å¾…1ç§’
                            const verifyQuery = await db.collection('products').count();
                            const actualCount = verifyQuery.total || 0;
                            log(`ğŸ” ç«‹å³éªŒè¯ç»“æœ: å®é™…æŸ¥è¯¢åˆ° ${actualCount} æ¡è®°å½•`);
                            
                            if (actualCount === 0) {
                                log('âš ï¸ è­¦å‘Š: æ’å…¥åç«‹å³æŸ¥è¯¢ä»ä¸º0æ¡è®°å½•ï¼Œå¯èƒ½å­˜åœ¨æƒé™æˆ–åŒæ­¥é—®é¢˜', 'warning');
                                log(`éªŒè¯æŸ¥è¯¢è¯¦æƒ…: ${JSON.stringify({
                                    hasData: !!verifyQuery.data,
                                    dataType: typeof verifyQuery.data,
                                    resultKeys: Object.keys(verifyQuery || {})
                                })}`);
                            } else {
                                log(`âœ… éªŒè¯æˆåŠŸ: ç¡®å®æ’å…¥äº† ${actualCount} æ¡è®°å½•`);
                            }
                        } catch (verifyError) {
                            log(`âŒ ç«‹å³éªŒè¯å¤±è´¥: ${verifyError.message}`, 'error');
                        }
                    } else {
                        log('äº§å“æ•°æ®æ’å…¥å¤±è´¥ï¼Œä½†ç»§ç»­å…¶ä»–æ­¥éª¤...', 'warning');
                    }
                } else {
                    log('productsé›†åˆå·²å­˜åœ¨æ•°æ®ï¼Œè·³è¿‡åˆå§‹åŒ–');
                    updateProgress(80, 'è·³è¿‡äº§å“æ•°æ®æ’å…¥...');
                }

                // 5. æ£€æŸ¥configé›†åˆ
                updateProgress(85, 'æ£€æŸ¥é…ç½®æ•°æ®...');
                let existingConfig;
                try {
                    log('å¼€å§‹æŸ¥è¯¢ config é›†åˆè®°å½•æ•°...');
                    const directQuery = await db.collection('config').count();
                    log('config ç›´æ¥æŸ¥è¯¢è¿”å›ç»“æœ:', JSON.stringify({
                        total: directQuery.total || 0,
                        queryType: 'count',
                        resultKeys: Object.keys(directQuery || {})
                    }));
                    
                    existingConfig = { total: directQuery.total || 0 };
                    log(`configé›†åˆç°æœ‰ ${existingConfig.total} æ¡è®°å½•`);
                } catch (configQueryError) {
                    log('æŸ¥è¯¢configé›†åˆæ—¶é‡åˆ°é”™è¯¯: ' + configQueryError.message, 'warning');
                    existingConfig = { total: 0 }; // å‡è®¾ä¸ºç©ºï¼Œç»§ç»­åˆå§‹åŒ–
                }

                if (existingConfig.total === 0) {
                    // 6. ç¡®ä¿configé›†åˆå­˜åœ¨ - é€šè¿‡æ’å…¥æµ‹è¯•æ•°æ®è‡ªåŠ¨åˆ›å»º
                    log('ğŸ”§ ç¡®ä¿configé›†åˆå­˜åœ¨...');
                    try {
                        // å°è¯•æ’å…¥ä¸€æ¡æµ‹è¯•æ•°æ®æ¥è‡ªåŠ¨åˆ›å»ºé›†åˆ
                        const testResult = await db.collection('config').add({
                            _test: true,
                            type: 'test_collection_creation',
                            createdAt: new Date()
                        });
                        
                        if (testResult.id) {
                            log('âœ… configé›†åˆé€šè¿‡æµ‹è¯•æ•°æ®åˆ›å»ºæˆåŠŸ');
                            // åˆ é™¤æµ‹è¯•æ•°æ®
                            await db.collection('config').doc(testResult.id).remove();
                            log('ğŸ—‘ï¸ æµ‹è¯•æ•°æ®å·²æ¸…ç†');
                        }
                    } catch (createError) {
                        log(`âš ï¸ é€šè¿‡æµ‹è¯•æ•°æ®åˆ›å»ºconfigé›†åˆå¤±è´¥: ${createError.message}`, 'warning');
                        log('å°è¯•ä½¿ç”¨createCollectionæ–¹æ³•...');
                        try {
                            await db.createCollection('config');
                            log('âœ… configé›†åˆé€šè¿‡createCollectionåˆ›å»ºæˆåŠŸ');
                        } catch (createError2) {
                            log(`âŒ createCollectionä¹Ÿå¤±è´¥: ${createError2.message}`, 'error');
                        }
                    }
                    
                    // 7. æ’å…¥é…ç½®æ•°æ®
                    log('å¼€å§‹æ’å…¥é…ç½®æ•°æ®...');
                    updateProgress(90, 'æ’å…¥é…ç½®æ•°æ®...');
                    
                    await db.collection('config').add({
                        type: 'category_config',
                        data: configData,
                        createdAt: new Date(),
                        updatedAt: new Date()
                    });
                    log('configé›†åˆåˆå§‹åŒ–å®Œæˆ', 'success');
                } else {
                    log('configé›†åˆå·²å­˜åœ¨æ•°æ®ï¼Œè·³è¿‡åˆå§‹åŒ–');
                }

                // 7. éªŒè¯ç»“æœ
                updateProgress(95, 'éªŒè¯ç»“æœ...');
                let finalProductsCount, finalConfigCount;
                try {
                    log('å¼€å§‹æœ€ç»ˆéªŒè¯ - æŸ¥è¯¢ products é›†åˆ...');
                    const productsQuery = await db.collection('products').count();
                    finalProductsCount = { total: productsQuery.total || 0 };
                    log('æœ€ç»ˆéªŒè¯ - products æŸ¥è¯¢è¿”å›:', JSON.stringify({
                        total: finalProductsCount.total,
                        queryType: 'count',
                        resultKeys: Object.keys(productsQuery || {})
                    }));
                    
                    log('å¼€å§‹æœ€ç»ˆéªŒè¯ - æŸ¥è¯¢ config é›†åˆ...');
                    const configQuery = await db.collection('config').count();
                    finalConfigCount = { total: configQuery.total || 0 };
                    log('æœ€ç»ˆéªŒè¯ - config æŸ¥è¯¢è¿”å›:', JSON.stringify({
                        total: finalConfigCount.total,
                        queryType: 'count',
                        resultKeys: Object.keys(configQuery || {})
                    }));
                } catch (countError) {
                    log('éªŒè¯ç»“æœæ—¶é‡åˆ°é”™è¯¯: ' + countError.message, 'warning');
                    finalProductsCount = { total: 'æ— æ³•è·å–' };
                    finalConfigCount = { total: 'æ— æ³•è·å–' };
                }

                updateProgress(100, 'åˆå§‹åŒ–å®Œæˆ');
                log('=== æ•°æ®åº“åˆå§‹åŒ–å®Œæˆ ===', 'success');
                log(`productsé›†åˆ: ${finalProductsCount.total} æ¡è®°å½•`, 'success');
                log(`configé›†åˆ: ${finalConfigCount.total} æ¡è®°å½•`, 'success');

            } catch (error) {
                log('æ•°æ®åº“åˆå§‹åŒ–å¤±è´¥: ' + error.message, 'error');
                updateProgress(0, 'åˆå§‹åŒ–å¤±è´¥');
            } finally {
                initBtn.disabled = false;
                initBtn.textContent = 'å¼€å§‹åˆå§‹åŒ–æ•°æ®åº“';
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        window.onload = function() {
            log('é¡µé¢åŠ è½½å®Œæˆï¼Œå‡†å¤‡åˆå§‹åŒ–CloudBase...');
            updateProgress(0, 'å‡†å¤‡åˆå§‹åŒ–...');
        }

        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨æ£€æµ‹SDK
        window.addEventListener('load', function() {
            setTimeout(() => {
                log('é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹æ£€æµ‹ CloudBase SDK...');
                if (typeof cloudbase !== 'undefined') {
                    log('âœ… CloudBase SDK åŠ è½½æˆåŠŸï¼Œå¯ä»¥å¼€å§‹ä½¿ç”¨', 'success');
                } else {
                    log('âŒ CloudBase SDK åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ä»¥ä¸‹å¯èƒ½çš„åŸå› ï¼š', 'error');
                    log('1. ç½‘ç»œè¿æ¥é—®é¢˜', 'error');
                    log('2. æµè§ˆå™¨é˜»æ­¢äº†è„šæœ¬åŠ è½½', 'error');
                    log('3. CDN æœåŠ¡ä¸å¯ç”¨', 'error');
                    log('å»ºè®®ï¼šåˆ·æ–°é¡µé¢é‡è¯•æˆ–æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°é”™è¯¯ä¿¡æ¯', 'error');
                }
            }, 1000);
        });

    </script>
</body>
</html>