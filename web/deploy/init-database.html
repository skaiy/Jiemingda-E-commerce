<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>数据库初始化</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .status {
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            font-weight: bold;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        .progress {
            margin: 20px 0;
        }
        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background-color: #28a745;
            width: 0%;
            transition: width 0.3s ease;
        }
        #log {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 14px;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>CloudBase 数据库初始化</h1>
        
        <div class="status info">
            <strong>环境信息:</strong><br>
            环境ID: cloud1-0gc8cbzg3efd6a99<br>
            数据库类型: 文档型云数据库
        </div>

        <div class="progress">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div id="progressText">准备初始化...</div>
        </div>

        <div style="text-align: center; margin: 20px 0;">
            <button id="initBtn" onclick="initDatabase()">开始初始化数据库</button>
            <button id="checkBtn" onclick="checkDatabase()">检查数据库状态</button>
            <button id="inspectBtn" onclick="runInspectData()">调用inspectData诊断</button>
            <button id="clearBtn" onclick="clearLog()">清空日志</button>
        </div>

        <div id="log"></div>
    </div>

    <!-- 使用官方 CDN 版本的 CloudBase Web SDK，避免本地空脚本问题 -->
    <script src="https://static.cloudbase.net/cloudbase-js-sdk/2.17.3/cloudbase.full.js"></script>
    <script>
        let app;
        let db;
        let logElement = document.getElementById('log');
        let progressFill = document.getElementById('progressFill');
        let progressText = document.getElementById('progressText');

        // 认证检查
        async function checkAuthentication() {
            try {
                const testApp = cloudbase.init({ env: 'cloud1-0gc8cbzg3efd6a99' });
                const auth = testApp.auth({ persistence: 'local' });
                const state = await auth.getLoginState();

                if (!state || !state.user) {
                    alert('此页面需要登录后才能访问，将跳转到登录页面');
                    window.location.href = './admin.html';
                    return false;
                }

                // 显示用户信息
                const userInfo = document.createElement('div');
                userInfo.style.cssText = 'text-align: center; margin-bottom: 20px; padding: 10px; background: #e8f5e8; border-radius: 6px; font-size: 14px;';
                userInfo.innerHTML = `已登录：${state.user?.username || state.user?.email || state.user?.phone_number || state.user?.uid} <button onclick="logout()" style="margin-left: 10px; padding: 4px 8px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;">退出登录</button>`;
                document.querySelector('.container').insertBefore(userInfo, document.querySelector('h1').nextSibling);

                return true;
            } catch (error) {
                console.error('认证检查失败:', error);
                alert('认证检查失败，将跳转到登录页面');
                window.location.href = './admin.html';
                return false;
            }
        }

        async function logout() {
            try {
                const testApp = cloudbase.init({ env: 'cloud1-0gc8cbzg3efd6a99' });
                const auth = testApp.auth({ persistence: 'local' });
                await auth.signOut();
                window.location.href = './admin.html';
            } catch (error) {
                console.error('退出登录失败:', error);
                window.location.href = './admin.html';
            }
        }

        // 页面加载时检查认证
        window.addEventListener('load', async () => {
            const isAuthenticated = await checkAuthentication();
            if (!isAuthenticated) {
                return; // 如果未认证，页面会重定向，不继续执行
            }
        });

        // 日志函数
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${message}\n`;
            logElement.textContent += logMessage;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(message);
        }

        // 更新进度
        function updateProgress(percent, text) {
            progressFill.style.width = percent + '%';
            progressText.textContent = text;
        }

        // 清空日志
        function clearLog() {
            logElement.textContent = '';
        }

        // 等待SDK加载完成
        function waitForSDK() {
            return new Promise((resolve, reject) => {
                log('正在检查 CloudBase SDK 加载状态...');
                
                if (typeof cloudbase !== 'undefined') {
                    log('CloudBase SDK 已加载');
                    resolve();
                } else {
                    log('CloudBase SDK 未加载，开始等待...');
                    let attempts = 0;
                    const checkSDK = setInterval(() => {
                        attempts++;
                        log(`等待 SDK 加载... 尝试 ${attempts}/50`);
                        
                        if (typeof cloudbase !== 'undefined') {
                            clearInterval(checkSDK);
                            log('CloudBase SDK 加载成功');
                            resolve();
                        } else if (attempts > 50) { // 5秒超时
                            clearInterval(checkSDK);
                            log('CloudBase SDK 加载超时，请检查网络连接或刷新页面重试');
                            reject(new Error('CloudBase SDK 加载超时 - 可能的原因：网络问题、CDN阻塞或脚本加载失败'));
                        }
                    }, 100);
                }
            });
        }

        // 调用 inspectData 云函数进行诊断
        async function runInspectData() {
            try {
                updateProgress(5, '准备调用 inspectData...');
                const ok = await initCloudBase();
                if (!ok) { throw new Error('CloudBase 初始化失败'); }

                log('调用云函数 inspectData ...');
                const res = await app.callFunction({ name: 'inspectData', data: { action: 'diagnose' } });
                updateProgress(50, 'inspectData 调用成功，解析结果...');
                const out = (res && res.result) ? res.result : res;
                log('inspectData 返回: ' + JSON.stringify(out, null, 2));

                // 简要汇总
                if (out && out.checks && out.checks.products) {
                    const p = out.checks.products;
                    log(`产品集合: 存在=${p.exists}, 数量=${p.count}, 缺编号=${p.missingCode}, 缺品牌码=${p.missingBrandCode}`);
                }
                updateProgress(100, 'inspectData 诊断完成');
            } catch (err) {
                log('inspectData 调用失败: ' + err.message, 'error');
                updateProgress(0, 'inspectData 失败');
            }
        }

        // 初始化CloudBase
        async function initCloudBase() {
            try {
                log('开始等待 CloudBase SDK...');
                await waitForSDK();
                log('SDK 等待完成，开始初始化应用...');
                
                // 尝试不同的初始化方式
                app = cloudbase.init({
                    env: 'cloud1-0gc8cbzg3efd6a99',
                    region: 'ap-shanghai'
                });
                
                // 线上已关闭匿名登录，跳过身份验证
                log('线上已关闭匿名登录，跳过身份验证，直接尝试数据库操作');
                log('CloudBase 应用初始化完成，app对象: ' + (app ? '已创建' : '未创建'));
                
                // 检查app对象的方法
                log('app对象可用方法: ' + Object.getOwnPropertyNames(app).join(', '));
                
                // 尝试获取数据库实例
                if (typeof app.database === 'function') {
                    log('app.database 方法存在，开始创建数据库对象...');
                    
                    // 方法1: 直接调用 app.database()
                    db = app.database();
                    log('方法1 - app.database(): ' + (db ? '已创建' : '未创建'));
                    
                    // 如果方法1失败，尝试方法2: 先进行匿名身份验证
                    if (!db) {
                        try {
                            log('方法1失败，尝试方法2: 先进行匿名身份验证...');
                            await app.auth().signInAnonymously();
                            log('匿名身份验证成功');
                            db = app.database();
                            log('方法2 - 身份验证后 app.database(): ' + (db ? '已创建' : '未创建'));
                        } catch (authError) {
                            log('匿名身份验证失败: ' + authError.message);
                        }
                    }
                    
                    // 如果方法2也失败，尝试方法3: 使用特定配置
                    if (!db) {
                        try {
                            log('方法2失败，尝试方法3: 使用特定配置...');
                            db = app.database({
                                throwOnNotFound: false
                            });
                            log('方法3 - 特定配置 app.database(): ' + (db ? '已创建' : '未创建'));
                        } catch (configError) {
                            log('特定配置失败: ' + configError.message);
                        }
                    }
                    
                    if (db) {
                        log('db对象类型: ' + typeof db);
                        log('db对象可用方法: ' + Object.getOwnPropertyNames(db).join(', '));
                    }
                } else {
                    log('app.database 方法不存在', 'error');
                }
                
                // 如果所有app.database方法都失败，尝试直接使用cloudbase.database()
                if (!db) {
                    log('所有app.database方法失败，尝试直接使用 cloudbase.database()...');
                    try {
                        db = cloudbase.database({
                            env: 'cloud1-0gc8cbzg3efd6a99'
                        });
                        log('cloudbase.database() 直接创建: ' + (db ? '已创建' : '未创建'));
                        
                        if (db) {
                            log('cloudbase.database() 创建的db对象类型: ' + typeof db);
                            log('cloudbase.database() 创建的db对象可用方法: ' + Object.getOwnPropertyNames(db).join(', '));
                        }
                    } catch (directError) {
                        log('cloudbase.database() 直接创建失败: ' + directError.message);
                    }
                }
                
                // 验证db对象的方法
                if (db && typeof db.collection === 'function') {
                    log('数据库对象验证成功，collection方法可用');
                } else {
                    throw new Error('数据库对象验证失败，collection方法不可用。db: ' + db + ', collection: ' + (db ? typeof db.collection : 'N/A'));
                }
                
                log('CloudBase 初始化成功', 'success');
                return true;
            } catch (error) {
                log('CloudBase 初始化失败: ' + error.message, 'error');
                log('错误详情: ' + error.stack, 'error');
                return false;
            }
        }

        // 检查数据库状态
        async function checkDatabase() {
            if (!(await initCloudBase())) return;

            try {
                log('正在检查数据库状态...');
                updateProgress(10, '检查数据库连接...');

                // 验证数据库连接
                if (!db) {
                    throw new Error('数据库连接未建立，db对象为空');
                }
                log('数据库连接验证成功');

                // 检查products集合
                const productsResult = await db.collection('products').get();
                const productsCount = productsResult.data ? productsResult.data.length : 0;
                log(`products集合: ${productsCount} 条记录`);

                // 检查config集合
                const configResult = await db.collection('config').get();
                const configCount = configResult.data ? configResult.data.length : 0;
                log(`config集合: ${configCount} 条记录`);

                updateProgress(100, '检查完成');
                log('数据库状态检查完成', 'success');

            } catch (error) {
                log('检查数据库状态失败: ' + error.message, 'error');
                updateProgress(0, '检查失败');
            }
        }

        // 初始化数据库
        async function initDatabase() {
            if (!(await initCloudBase())) return;

            const initBtn = document.getElementById('initBtn');
            initBtn.disabled = true;
            initBtn.textContent = '初始化中...';

            try {
                log('开始初始化数据库...');
                updateProgress(5, '开始初始化...');

                // 验证数据库连接
                if (!db) {
                    throw new Error('数据库连接未建立，db对象为空');
                }
                log('数据库连接验证成功');

                // 1. 加载产品数据
                log('正在加载产品数据...');
                updateProgress(10, '加载产品数据...');
                
                const productsResponse = await fetch('./data/products.json');
                const productsData = await productsResponse.json();
                log(`加载了 ${productsData.categories.length} 个产品分类`);

                // 2. 加载配置数据
                log('正在加载配置数据...');
                updateProgress(20, '加载配置数据...');
                
                const configResponse = await fetch('./data/category_config.json');
                const configData = await configResponse.json();
                log('配置数据加载完成');

                // 3. 检查products集合是否已有数据
                updateProgress(30, '检查现有数据...');
                log('正在查询products集合...');
                
                let existingProducts;
                try {
                    // 使用count方法获取准确记录数
                    log('开始查询 products 集合记录数...');
                    const directQuery = await db.collection('products').count();
                    log('直接查询返回结果:', JSON.stringify({
                        total: directQuery.total || 0,
                        queryType: 'count',
                        resultKeys: Object.keys(directQuery || {})
                    }));
                    
                    existingProducts = { total: directQuery.total || 0 };
                    log(`通过直接查询获得 products 集合记录数: ${existingProducts.total}`);
                } catch (queryError) {
                    if (queryError.message.includes('ACCESS_TOKEN_DISABLED')) {
                        log('遇到权限问题，尝试重新进行身份验证...');
                        try {
                            // 重新尝试匿名身份验证
                            await app.auth().signInAnonymously();
                            log('重新身份验证成功，再次尝试查询...');
                            const retryQuery = await db.collection('products').count();
                            existingProducts = { total: retryQuery.total || 0 };
                            log(`重试查询 - products集合现有 ${existingProducts.total} 条记录`);
                        } catch (retryError) {
                            log('重新身份验证失败，尝试使用云函数方式...');
                            // 如果身份验证仍然失败，我们假设数据库为空，继续初始化
                            existingProducts = { total: 0 };
                            log('假设数据库为空，继续初始化流程');
                        }
                    } else {
                        throw queryError;
                    }
                }

                if (existingProducts.total === 0) {
                    // 4. 确保products集合存在 - 通过插入测试数据自动创建
                    log('🔧 确保products集合存在...');
                    try {
                        // 尝试插入一条测试数据来自动创建集合
                        const testResult = await db.collection('products').add({
                            _test: true,
                            name: 'test_collection_creation',
                            createdAt: new Date()
                        });
                        
                        if (testResult.id) {
                            log('✅ products集合通过测试数据创建成功');
                            // 删除测试数据
                            await db.collection('products').doc(testResult.id).remove();
                            log('🗑️ 测试数据已清理');
                        }
                    } catch (createError) {
                        log(`⚠️ 通过测试数据创建products集合失败: ${createError.message}`, 'warning');
                        log('尝试使用createCollection方法...');
                        try {
                            await db.createCollection('products');
                            log('✅ products集合通过createCollection创建成功');
                        } catch (createError2) {
                            log(`❌ createCollection也失败: ${createError2.message}`, 'error');
                        }
                    }
                    
                    // 5. 插入产品数据
                    log('开始插入产品数据...');
                    updateProgress(40, '插入产品数据...');
                    
                    let insertedCount = 0;
                    const totalProducts = productsData.categories.reduce((sum, cat) => sum + cat.items.length, 0);
                    let useCloudFunction = false;
                    
                    for (const category of productsData.categories) {
                        for (const item of category.items) {
                            try {
                                if (!useCloudFunction) {
                                    // 尝试直接数据库操作
                                    const addResult = await db.collection('products').add({
                                        ...item,
                                        category: category.name,
                                        createdAt: new Date(),
                                        updatedAt: new Date()
                                    });
                                    
                                    // 验证插入结果
                                    if (addResult && addResult.id) {
                                        insertedCount++;
                                        if (insertedCount <= 3) {
                                            log(`✅ 成功插入产品: ${item.name}, ID: ${addResult.id}`);
                                        }
                                    } else {
                                        log(`❌ 插入失败，无返回ID: ${item.name}`, 'error');
                                        log(`插入结果: ${JSON.stringify(addResult)}`, 'error');
                                    }
                                    
                                    // 更新进度
                                    const progress = 40 + (insertedCount / totalProducts) * 40;
                                    updateProgress(progress, `插入产品数据 ${insertedCount}/${totalProducts}`);
                                    
                                    if (insertedCount % 50 === 0) {
                                        log(`已插入 ${insertedCount}/${totalProducts} 条产品记录`);
                                    }
                                } else {
                                    // 使用云函数方式
                                    log('使用云函数方式插入数据...');
                                    // 这里可以调用云函数来插入数据
                                    insertedCount++;
                                    updateProgress(40 + (insertedCount / totalProducts) * 40, `通过云函数插入产品 ${insertedCount}/${totalProducts}`);
                                }
                            } catch (error) {
                                if (error.message.includes('ACCESS_TOKEN_DISABLED') && !useCloudFunction) {
                                    log('数据库直接操作权限不足，切换到云函数方式...', 'warning');
                                    useCloudFunction = true;
                                    // 重新尝试当前项目
                                    try {
                                        log('尝试调用云函数进行数据初始化...');
                                        // 调用云函数
                                        const result = await app.callFunction({
                                            name: 'initDatabase',
                                            data: {
                                                action: 'initProducts',
                                                products: productsData,
                                                config: configData
                                            }
                                        });
                                        
                                        if (result.result.success) {
                                            log('云函数初始化成功', 'success');
                                            insertedCount = totalProducts;
                                            updateProgress(70, '云函数初始化完成');
                                            break; // 跳出循环，因为云函数已经处理了所有数据
                                        } else {
                                            throw new Error(result.result.error || '云函数执行失败');
                                        }
                                    } catch (cloudFunctionError) {
                                        log(`云函数调用失败: ${cloudFunctionError.message}`, 'error');
                                        log('将跳过数据插入，但继续其他步骤...', 'warning');
                                        break;
                                    }
                                } else {
                                    log(`插入产品失败: ${item.name} - ${error.message}`, 'error');
                                }
                            }
                        }
                        if (useCloudFunction) break; // 如果使用云函数，跳出外层循环
                    }
                    
                    if (insertedCount > 0) {
                        log(`products集合初始化完成，共插入 ${insertedCount} 条记录`, 'success');
                        
                        // 立即验证插入结果
                        try {
                            log('🔍 立即验证插入结果...');
                            await new Promise(resolve => setTimeout(resolve, 1000)); // 等待1秒
                            const verifyQuery = await db.collection('products').count();
                            const actualCount = verifyQuery.total || 0;
                            log(`🔍 立即验证结果: 实际查询到 ${actualCount} 条记录`);
                            
                            if (actualCount === 0) {
                                log('⚠️ 警告: 插入后立即查询仍为0条记录，可能存在权限或同步问题', 'warning');
                                log(`验证查询详情: ${JSON.stringify({
                                    hasData: !!verifyQuery.data,
                                    dataType: typeof verifyQuery.data,
                                    resultKeys: Object.keys(verifyQuery || {})
                                })}`);
                            } else {
                                log(`✅ 验证成功: 确实插入了 ${actualCount} 条记录`);
                            }
                        } catch (verifyError) {
                            log(`❌ 立即验证失败: ${verifyError.message}`, 'error');
                        }
                    } else {
                        log('产品数据插入失败，但继续其他步骤...', 'warning');
                    }
                } else {
                    log('products集合已存在数据，跳过初始化');
                    updateProgress(80, '跳过产品数据插入...');
                }

                // 5. 检查config集合
                updateProgress(85, '检查配置数据...');
                let existingConfig;
                try {
                    log('开始查询 config 集合记录数...');
                    const directQuery = await db.collection('config').count();
                    log('config 直接查询返回结果:', JSON.stringify({
                        total: directQuery.total || 0,
                        queryType: 'count',
                        resultKeys: Object.keys(directQuery || {})
                    }));
                    
                    existingConfig = { total: directQuery.total || 0 };
                    log(`config集合现有 ${existingConfig.total} 条记录`);
                } catch (configQueryError) {
                    log('查询config集合时遇到错误: ' + configQueryError.message, 'warning');
                    existingConfig = { total: 0 }; // 假设为空，继续初始化
                }

                if (existingConfig.total === 0) {
                    // 6. 确保config集合存在 - 通过插入测试数据自动创建
                    log('🔧 确保config集合存在...');
                    try {
                        // 尝试插入一条测试数据来自动创建集合
                        const testResult = await db.collection('config').add({
                            _test: true,
                            type: 'test_collection_creation',
                            createdAt: new Date()
                        });
                        
                        if (testResult.id) {
                            log('✅ config集合通过测试数据创建成功');
                            // 删除测试数据
                            await db.collection('config').doc(testResult.id).remove();
                            log('🗑️ 测试数据已清理');
                        }
                    } catch (createError) {
                        log(`⚠️ 通过测试数据创建config集合失败: ${createError.message}`, 'warning');
                        log('尝试使用createCollection方法...');
                        try {
                            await db.createCollection('config');
                            log('✅ config集合通过createCollection创建成功');
                        } catch (createError2) {
                            log(`❌ createCollection也失败: ${createError2.message}`, 'error');
                        }
                    }
                    
                    // 7. 插入配置数据
                    log('开始插入配置数据...');
                    updateProgress(90, '插入配置数据...');
                    
                    await db.collection('config').add({
                        type: 'category_config',
                        data: configData,
                        createdAt: new Date(),
                        updatedAt: new Date()
                    });
                    log('config集合初始化完成', 'success');
                } else {
                    log('config集合已存在数据，跳过初始化');
                }

                // 7. 验证结果
                updateProgress(95, '验证结果...');
                let finalProductsCount, finalConfigCount;
                try {
                    log('开始最终验证 - 查询 products 集合...');
                    const productsQuery = await db.collection('products').count();
                    finalProductsCount = { total: productsQuery.total || 0 };
                    log('最终验证 - products 查询返回:', JSON.stringify({
                        total: finalProductsCount.total,
                        queryType: 'count',
                        resultKeys: Object.keys(productsQuery || {})
                    }));
                    
                    log('开始最终验证 - 查询 config 集合...');
                    const configQuery = await db.collection('config').count();
                    finalConfigCount = { total: configQuery.total || 0 };
                    log('最终验证 - config 查询返回:', JSON.stringify({
                        total: finalConfigCount.total,
                        queryType: 'count',
                        resultKeys: Object.keys(configQuery || {})
                    }));
                } catch (countError) {
                    log('验证结果时遇到错误: ' + countError.message, 'warning');
                    finalProductsCount = { total: '无法获取' };
                    finalConfigCount = { total: '无法获取' };
                }

                updateProgress(100, '初始化完成');
                log('=== 数据库初始化完成 ===', 'success');
                log(`products集合: ${finalProductsCount.total} 条记录`, 'success');
                log(`config集合: ${finalConfigCount.total} 条记录`, 'success');

            } catch (error) {
                log('数据库初始化失败: ' + error.message, 'error');
                updateProgress(0, '初始化失败');
            } finally {
                initBtn.disabled = false;
                initBtn.textContent = '开始初始化数据库';
            }
        }

        // 页面加载完成后的初始化
        window.onload = function() {
            log('页面加载完成，准备初始化CloudBase...');
            updateProgress(0, '准备初始化...');
        }

        // 页面加载完成后自动检测SDK
        window.addEventListener('load', function() {
            setTimeout(() => {
                log('页面加载完成，开始检测 CloudBase SDK...');
                if (typeof cloudbase !== 'undefined') {
                    log('✅ CloudBase SDK 加载成功，可以开始使用', 'success');
                } else {
                    log('❌ CloudBase SDK 加载失败，请检查以下可能的原因：', 'error');
                    log('1. 网络连接问题', 'error');
                    log('2. 浏览器阻止了脚本加载', 'error');
                    log('3. CDN 服务不可用', 'error');
                    log('建议：刷新页面重试或检查浏览器控制台错误信息', 'error');
                }
            }, 1000);
        });

    </script>
</body>
</html>