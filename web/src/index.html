<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">
  <title>移动端产品目录</title>
  <!-- CloudBase Web SDK -->
  <script src="https://static.cloudbase.net/cloudbase-js-sdk/2.17.3/cloudbase.full.js"></script>
  <!-- CloudBase 配置 -->
  <script src="./cloudbase.config.js"></script>
  <style>
    :root{--bg:#f7f7f8;--card:#fff;--accent:#ff6b6b;--muted:#888;--modal-close-size:56px;--modal-close-bg:var(--accent);--modal-close-color:#fff;--modal-close-bottom:24px}
    html,body{height:100%;margin:0;font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial; background:var(--bg); color:#222}
    .app{display:flex;flex-direction:column;height:100vh;max-height:100vh;overflow:hidden}
    
    /* 顶部搜索栏 */
    .top-search-bar{position:sticky;top:0;z-index:100;background:#fff;border-bottom:1px solid #eee;padding:8px 12px;box-shadow:0 2px 8px rgba(0,0,0,0.06)}
    .search-input{width:100%;padding:10px 12px;border-radius:12px;border:1px solid #ddd;font-size:16px;box-sizing:border-box}
    .search-input:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px rgba(255,107,107,0.1)}
    
    /* 品牌筛选区域 */
    .brand-filter-section{position:sticky;top:57px;z-index:99;background:#fff;border-bottom:1px solid #eee;padding:8px 0}
    .brand-filter-container{display:flex;align-items:center;gap:8px;padding:0 12px}
    .brand-scroll{flex:1;overflow-x:auto;scrollbar-width:none;-ms-overflow-style:none}
    .brand-scroll::-webkit-scrollbar{display:none}
    .brand-tabs{display:flex;gap:8px;padding:4px 0;min-width:max-content}
    .brand-tab{display:flex;align-items:center;gap:6px;padding:8px 12px;border-radius:20px;background:#f5f5f5;color:#666;font-size:14px;white-space:nowrap;cursor:pointer;transition:all 0.2s ease;border:1px solid transparent}
    .brand-tab.active{background:var(--accent);color:#fff;font-weight:600}
    .brand-tab:hover:not(.active){background:#e8e8e8;border-color:#ddd}
    .brand-logo{width:20px;height:20px;border-radius:50%;background:linear-gradient(45deg,#ddd,#bbb);display:flex;align-items:center;justify-content:center;font-size:10px;color:#fff;font-weight:bold}
    .expand-btn{padding:8px;border-radius:50%;background:#f5f5f5;border:1px solid #ddd;cursor:pointer;transition:all 0.3s ease;min-width:36px;height:36px;display:flex;align-items:center;justify-content:center;font-size:16px;font-weight:bold}
    .expand-btn:hover{background:#e8e8e8;transform:scale(1.05);box-shadow:0 2px 8px rgba(0,0,0,0.1)}
    .expand-btn.active{background:var(--accent);color:#fff;border-color:var(--accent);transform:scale(1.1);box-shadow:0 4px 12px rgba(255,107,107,0.3)}
    
    /* 主内容区域 */
    .main-content{flex:1;display:flex;overflow:hidden}
    .sidebar{width:24%;min-width:104px;max-width:200px;background:linear-gradient(#fff,#fafafa);border-right:1px solid #eee;overflow:auto;position:sticky;top:0;height:100%}
    .sidebar .search{position: sticky; top: 0; z-index: 2; padding:10px; background: linear-gradient(#fff,#fafafa); border-bottom: 1px solid #eee;}
    .category-list{list-style:none;padding:0;margin:0}
    .category-item{padding:12px 10px;border-bottom:1px solid #f0f0f0;cursor:pointer;display:flex;align-items:center}
    .category-item.active{background:linear-gradient(90deg, rgba(255,107,107,0.06), transparent);font-weight:600;color:var(--accent)}
    .category-item .label{flex:1 1 auto;min-width:0;white-space:normal;word-break:break-word}
    .category-item .badge{margin-left:auto;background:#eee;padding:4px 8px;border-radius:12px;font-size:12px;color:var(--muted)}
    .content{flex:1;overflow:auto;padding:8px}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:8px;padding:8px}
    .card{background:var(--card);border-radius:12px;padding:8px;box-shadow:0 4px 12px rgba(0,0,0,0.08);display:flex;flex-direction:column;transition: transform .2s cubic-bezier(.2,.8,.2,1), box-shadow .25s ease}
    .card:hover, .card:active{ box-shadow: 0 8px 24px rgba(0,0,0,0.12); transform: translateY(-1px) scale(1.01); }
    .card .img{height:110px;border-radius:8px;background:linear-gradient(180deg,#eee,#ddd);display:flex;align-items:center;justify-content:center;font-size:12px;color:#999}
    .card .name{margin-top:8px;font-size:14px;line-height:1.2;height:2.6em;overflow:hidden}
    .card .desc{font-size:12px;color:var(--muted);height:1.6em;overflow:hidden;margin-top:6px}
    .card .price-row{display:flex;align-items:center;justify-content:space-between;margin-top:8px}
    .price{font-weight:700;color:var(--accent)}
    .add-btn{background:var(--accent);color:#fff;border:none;padding:6px 10px;border-radius:8px;font-weight:600}
    @media(max-width:720px){.sidebar{width:30%;min-width:90px}.grid{grid-template-columns:repeat(2,1fr)}}
    @media(max-width:540px){.grid{grid-template-columns:1fr}}
    @media(max-width:420px){.main-content{flex-direction:row}.sidebar{order:1;width:36%;min-width:100px;max-width:160px;border-right:1px solid #eee;border-top:none}.content{order:2}.grid{grid-template-columns:1fr}.category-item{padding:10px 10px}.category-item .label{font-size:13px;line-height:1.25;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}.category-item .badge{font-size:11px;padding:2px 6px}}
    .empty{padding:30px;text-align:center;color:var(--muted)}
      /* 分类 Banner 样式 - 变窄并置顶 */
      .category-banner { position: sticky; top: 0; z-index: 10; width: 100%; height: 50px; border-radius: 0; overflow: hidden; background: linear-gradient(135deg, #6ea2ff 0%, #46d9a6 100%); margin: 0; }
      .category-banner .title-overlay { position: absolute; left: 16px; top: 50%; transform: translateY(-50%); color: #fff; font-size: 16px; font-weight: 700; text-shadow: 0 2px 6px rgba(0,0,0,0.35); }
      @media(min-width: 768px){ .category-banner { height: 60px; } .category-banner .title-overlay { font-size: 18px; } }
      @media(max-width: 420px){ .category-banner { height: 45px; } .category-banner .title-overlay { font-size: 14px; } }
      /* 隐藏旧的纯文本标题，改用覆盖在 Banner 上的标题 */
      #categoryTitle { display: none; }
    
      /* 详情按钮充满整卡片宽度 */
      .price-row { display: flex; flex-direction: column; gap: 8px; align-items: stretch; }
      .add-btn { display: block; width: 100%; box-sizing: border-box; }

      /* 平滑滚动反馈 */
      .sidebar, .content { scroll-behavior: smooth; }
      /* 侧栏返回顶部区域与按钮 */
      .sidebar-actions { position: sticky; bottom: 8px; padding: 8px; background: linear-gradient(#fff,#fafafa); border-top: 1px solid #eee; }
      .sidebar-actions .backtop-btn { width: 100%; padding: 10px 12px; border-radius: 999px; border: none; background: var(--accent); color: #fff; font-weight: 700; box-shadow: 0 3px 10px rgba(0,0,0,0.12); cursor: pointer; }
  </style>
</head>
<body>
  <div class="app">
    <!-- 顶部搜索栏 -->
    <div class="top-search-bar">
      <input id="globalSearch" class="search-input" placeholder="搜索产品名称、品牌、规格..." />
    </div>
    
    <!-- 品牌筛选区域 -->
    <div class="brand-filter-section">
      <div class="brand-filter-container">
        <div class="brand-scroll">
          <div class="brand-tabs" id="brandTabs">
            <div class="brand-tab active" data-brand="all">
              <span>全部</span>
            </div>
          </div>
        </div>
        <button class="expand-btn" id="expandBrands" title="展开全部品牌">
          <span>⋯</span>
        </button>
      </div>
    </div>
    
    <!-- 主内容区域 -->
    <div class="main-content">
      <aside class="sidebar">
        <div class="search">
          <input id="categorySearch" placeholder="搜索分类" style="width:100%;padding:8px;border-radius:8px;border:1px solid #eee;box-sizing:border-box">
        </div>
        <ul class="category-list" id="categoryList"></ul>
        <!-- 返回顶部容器（JS 会填充按钮） -->
        <div id="sidebarActions" class="sidebar-actions" style="display:none"></div>
      </aside>

      <main class="content">
        <div id="productGrid" class="grid"></div>
        <div id="emptyState" class="empty" style="display:none">没有找到商品。</div>
      </main>
    </div>
  </div>

  <script>
    // 仅使用外部 JSON 数据
    // 可切换为 CloudBase 数据库加载
    // 本地兜底
    const FETCH_URL = './data/products.json'; // 本地兜底
    const BRAND_DICTIONARY_URL = './data/brand_dictionary.json';
    const CATEGORY_DICTIONARY_URL = './data/category_dictionary.json';
    // CloudBase 环境配置
    const config = window.CLOUDBASE_CONFIG || {};
    const CLOUDBASE_ENV = window.CLOUDBASE_ENV || localStorage.getItem('CLOUDBASE_ENV') || config.envId || '';
    const USE_CLOUDBASE = !!CLOUDBASE_ENV;
     const CONFIG_URL = './data/category_config.json';
     let CATEGORY_BANNER_SLUGS = {};
     let CATEGORY_SHORT_NAMES = {};
     let CATEGORY_CONFIG = [];
     let BRAND_DICTIONARY = {};
     let CATEGORY_DICTIONARY = {};

    let DATA = {categories: []}; 
    let activeCategoryIndex = 0;
    let activeBrandCode = 'all'; // 新增：当前选中的品牌
    let allBrands = []; // 新增：所有品牌列表
    let isExpandedBrands = false; // 新增：是否展开全部品牌
    let currentActiveCategoryName = null; // 当前选中的分类名称（用于Banner）

    // 按产品数量对分类降序排序（与侧栏显示保持一致）
    function sortCategoriesByProductCountDescending(categories) {
      return [...categories].sort((a, b) => {
        const aCount = Array.isArray(a.items) ? a.items.length : 0;
        const bCount = Array.isArray(b.items) ? b.items.length : 0;
        return bCount - aCount;
      });
    }

    // 详情弹层
    const modal = document.createElement('div');
    Object.assign(modal.style, {position:'fixed',inset:'0',background:'rgba(0,0,0,0.35)',display:'none',alignItems:'center',justifyContent:'center',zIndex:'9999'});
    modal.innerHTML = `<div id="detailCard" style="background:#fff;border-radius:12px;max-width:520px;width:92%;padding:16px;box-shadow:0 6px 24px rgba(0,0,0,0.12)">
      <div style="display:flex;align-items:center;justify-content:center">
      <div style="font-weight:700">商品详情</div>
      </div>
      <div id="detailBody" style="margin-top:12px;font-size:14px;color:#333"></div>
    </div>`;
    document.body.appendChild(modal);
    // 底部居中圆形关闭按钮（可通过 CSS 变量调整尺寸与颜色）
    const closeBtn = document.createElement('button');
    closeBtn.id = 'modalCloseRound';
    closeBtn.setAttribute('aria-label','关闭详情');
    closeBtn.textContent = '×';
    Object.assign(closeBtn.style, {
      position:'absolute', left:'50%', bottom:'var(--modal-close-bottom)', transform:'translateX(-50%)',
      width:'var(--modal-close-size)', height:'var(--modal-close-size)', borderRadius:'50%',
      background:'var(--modal-close-bg)', color:'var(--modal-close-color)', border:'none',
      display:'flex', alignItems:'center', justifyContent:'center',
      fontSize:'28px', lineHeight:'1', boxShadow:'0 6px 18px rgba(0,0,0,0.18)', cursor:'pointer'
    });
    closeBtn.addEventListener('click', ()=>{ modal.style.display='none'; });
    modal.appendChild(closeBtn);

    modal.addEventListener('click', (e)=>{ if(e.target===modal) modal.style.display='none'; });
    document.getElementById('modalClose')?.addEventListener('click', ()=> modal.style.display='none');

    function showDetail(item){
      const body = modal.querySelector('#detailBody');
      const specLine = item.spec || extractSpec(item.description);
      const unitLine = item.unit || extractUnit(item.description);
      
      // 获取品牌和品类名称
      const brandName = getBrandName(item.brandCode || '099');
      const categoryName = getCategoryName(item.categoryCode || '099');
      
      body.innerHTML = `
        <div style="font-size:16px;font-weight:700">${item.name||''}</div>
        <div style="margin-top:8px;color:#666">商品编号：${item.productCode||item.id||''}</div>
        <div style="margin-top:6px;color:#666">品牌/厂商：${brandName}</div>
        <div style="margin-top:6px;color:#666">商品分类：${categoryName}</div>
        <div style="margin-top:10px;height:160px;border-radius:10px;background:center/contain no-repeat url('${item.image? `./data/photos/${item.image}` : `./data/photos/placeh_001.png`}')"></div>
        <div style="margin-top:6px;white-space:pre-line">规格：${specLine||''}</div>
        <div style="margin-top:4px">单位：${unitLine||''}</div>
        ${item.price? `<div style="margin-top:6px;color:#d64">价格：¥${item.price}</div>`: ''}
        ${item.description? `<div style="margin-top:10px;color:#888">备注：${item.description}</div>`: ''}
      `;
      modal.style.display='flex';
    }

    // 从旧的 description 提取规格/单位的兼容方法
    function extractSpec(desc){
      if(!desc) return '';
      const m = desc.match(/规格:([^/]+)/);
      return m? m[1].trim(): '';
    }
    function extractUnit(desc){
      if(!desc) return '';
      const m = desc.match(/单位:([^/]+)/);
      return m? m[1].trim(): '';
    }

    // 获取品牌名称
    function getBrandName(brandCode) {
      if (!brandCode || !BRAND_DICTIONARY.brandDictionary) return '未知品牌';
      const brand = BRAND_DICTIONARY.brandDictionary.brands.find(b => b.code === brandCode);
      return brand ? brand.shortName || brand.name : '未知品牌';
    }

    // 获取品类名称
    function getCategoryName(categoryCode) {
      if (!categoryCode || !CATEGORY_DICTIONARY.categoryDictionary) return '未知分类';
      const category = CATEGORY_DICTIONARY.categoryDictionary.categories.find(c => c.code === categoryCode);
      return category ? category.shortName || category.name : '未知分类';
    }

    // 新增：提取所有品牌并生成品牌列表
    function extractBrands() {
      const brandCodes = new Set();
      DATA.categories.forEach(category => {
        category.items.forEach(item => {
          if (item.brandCode) {
            brandCodes.add(item.brandCode);
          }
        });
      });
      
      allBrands = Array.from(brandCodes).map(code => {
        const brand = BRAND_DICTIONARY.brandDictionary?.brands.find(b => b.code === code);
        return {
          code,
          name: brand ? brand.shortName || brand.name : '未知品牌',
          productCount: 0 // 将在后面计算
        };
      });
      
      // 计算每个品牌的产品数量
      allBrands.forEach(brand => {
        brand.productCount = DATA.categories.reduce((count, category) => {
          return count + category.items.filter(item => item.brandCode === brand.code).length;
        }, 0);
      });
      
      // 按产品数量降序排列
      allBrands.sort((a, b) => b.productCount - a.productCount);
    }

    // 新增：渲染品牌筛选标签
    function renderBrandTabs() {
      const brandTabs = document.getElementById('brandTabs');
      brandTabs.innerHTML = `
        <div class="brand-tab ${activeBrandCode === 'all' ? 'active' : ''}" data-brand="all">
          <span>全部</span>
        </div>
      `;
      
      const visibleBrands = isExpandedBrands ? allBrands : allBrands.slice(0, 8);
      
      visibleBrands.forEach(brand => {
        const tab = document.createElement('div');
        tab.className = `brand-tab ${activeBrandCode === brand.code ? 'active' : ''}`;
        tab.setAttribute('data-brand', brand.code);
        
        // 生成品牌logo（使用品牌名称首字母）
        const logoText = brand.name.charAt(0).toUpperCase();
        
        tab.innerHTML = `
          <div class="brand-logo">${logoText}</div>
          <span>${brand.name} (${brand.productCount})</span>
        `;
        
        brandTabs.appendChild(tab);
      });
      
      // 更新展开按钮状态
      const expandBtn = document.getElementById('expandBrands');
      if (expandBtn) {
        expandBtn.classList.toggle('active', isExpandedBrands);
        const span = expandBtn.querySelector('span');
        if (span) {
          span.textContent = isExpandedBrands ? '⌃' : '⋯';
        }
        expandBtn.title = isExpandedBrands ? '收起品牌' : '展开全部品牌';
      }
    }

    // 新增：设置活跃品牌
    function setActiveBrand(brandCode) {
      activeBrandCode = brandCode;
      renderBrandTabs();
      applyFilters();
    }

    // 修改：应用所有筛选条件（分类 + 品牌 + 搜索）
    function applyFilters() {
      const globalSearch = document.getElementById('globalSearch').value.trim().toLowerCase();
      const categorySearch = document.getElementById('categorySearch').value.trim().toLowerCase();
      
      // 首先应用分类搜索
      let filteredCategories = DATA.categories;
      if (categorySearch) {
        filteredCategories = DATA.categories.filter(c => {
          const name = (c.name || '').toLowerCase();
          const shortName = ((CATEGORY_SHORT_NAMES && CATEGORY_SHORT_NAMES[c.name]) || '').toLowerCase();
          return name.includes(categorySearch) || shortName.includes(categorySearch);
        });
      }
      
      // 新增：与侧边栏一致，按产品数量降序排列分类
      const sortedFilteredCategories = sortCategoriesByProductCountDescending(filteredCategories);
      
      // 获取当前选中分类的商品
      let items = [];
      if (activeCategoryIndex === -1) {
        // 全部商品
        items = sortedFilteredCategories.flatMap(c => c.items);
        currentActiveCategoryName = null;
      } else if (sortedFilteredCategories[activeCategoryIndex]) {
        // 特定分类
        items = sortedFilteredCategories[activeCategoryIndex].items;
        currentActiveCategoryName = sortedFilteredCategories[activeCategoryIndex].name || null;
      }
      
      // 应用品牌筛选
      if (activeBrandCode !== 'all') {
        items = items.filter(item => item.brandCode === activeBrandCode);
      }
      
      // 应用全局搜索
      if (globalSearch) {
        items = items.filter(item => {
          const searchFields = [
            item.name || '',
            item.description || '',
            item.brand || '',
            item.spec || '',
            item.unit || '',
            getBrandName(item.brandCode || '099')
          ].join(' ').toLowerCase();
          return searchFields.includes(globalSearch);
        });
      }
      
      renderFilteredProducts(items);
    }

    // 新增：渲染筛选后的产品
    function renderFilteredProducts(items) {
      const grid = document.getElementById('productGrid');
      grid.innerHTML = '';
      
      // 移除旧的banner
      const oldBanner = document.getElementById('categoryBanner');
      if (oldBanner) oldBanner.remove();
      
      // 创建新的banner
      let bannerTitle = '全部商品';
      if (activeCategoryIndex !== -1 && currentActiveCategoryName) {
        bannerTitle = currentActiveCategoryName;
      }
      if (activeBrandCode !== 'all') {
        const brand = allBrands.find(b => b.code === activeBrandCode);
        bannerTitle += ` - ${brand ? brand.name : '未知品牌'}`;
      }
      
      const banner = document.createElement('div');
      banner.id = 'categoryBanner';
      banner.className = 'category-banner';
      const overlay = document.createElement('div');
      overlay.className = 'title-overlay';
      overlay.textContent = bannerTitle;
      banner.appendChild(overlay);
      
      // Banner已通过CSS设置为置顶，无需动态调整位置
      grid.parentNode.insertBefore(banner, grid);
      
      // 加载banner背景
      const categoryName = activeCategoryIndex !== -1 && currentActiveCategoryName
        ? currentActiveCategoryName
        : '全部商品';
      loadBannerBackground(banner, categoryName);
      
      // 标题已显示在Banner上，无需单独更新
      
      // 渲染产品
      if (items.length === 0) {
        document.getElementById('emptyState').style.display = 'block';
        return;
      }
      
      document.getElementById('emptyState').style.display = 'none';
      items.forEach(item => {
        const card = document.createElement('div');
        card.className = 'card';
        
        const img = document.createElement('div');
        img.className = 'img';
        const imgUrl = item.image ? `./data/photos/${item.image}` : `./data/photos/placeh_001.png`;
        img.style.background = `center/contain no-repeat url('${imgUrl}')`;
        
        const name = document.createElement('div');
        name.className = 'name';
        name.textContent = item.name || 'Unnamed';
        
        const productCode = document.createElement('div');
        productCode.className = 'desc';
        productCode.textContent = `编号：${item.productCode || item.id || ''}`;
        
        const brand = document.createElement('div');
        brand.className = 'desc';
        const brandName = getBrandName(item.brandCode || '099');
        brand.textContent = brandName ? `品牌：${brandName}` : '';
        
        const specLine = item.spec || extractSpec(item.description);
        const unitLine = item.unit || extractUnit(item.description);
        
        const spec = document.createElement('div');
        spec.className = 'desc';
        spec.textContent = specLine ? `规格：${specLine}` : '';
        
        const unit = document.createElement('div');
        unit.className = 'desc';
        unit.textContent = unitLine ? `单位：${unitLine}` : '';
        
        const priceRow = document.createElement('div');
        priceRow.className = 'price-row';
        
        const price = document.createElement('div');
        price.className = 'price';
        price.textContent = item.price ? '¥' + item.price : '';
        
        const detailBtn = document.createElement('button');
        detailBtn.className = 'add-btn';
        detailBtn.textContent = '查看详情';
        detailBtn.addEventListener('click', () => showDetail(item));
        
        priceRow.appendChild(price);
        priceRow.appendChild(detailBtn);
        
        card.appendChild(img);
        card.appendChild(name);
        card.appendChild(productCode);
        card.appendChild(brand);
        card.appendChild(spec);
        card.appendChild(unit);
        card.appendChild(priceRow);
        
        grid.appendChild(card);
      });
    }

    // 渲染分类列表
    function renderCategories(categories){
      const ul = document.getElementById('categoryList'); 
      ul.innerHTML='';
      
      // 顶部插入"全部产品"入口
      const totalCount = categories.reduce((sum,c)=> sum + (Array.isArray(c.items)? c.items.length : 0), 0);
      const liAll = document.createElement('li'); 
      liAll.className='category-item'; 
      liAll.id='li-all';
      liAll.innerHTML = `<div class="label">全部产品</div><div class="badge">${totalCount}</div>`;
      liAll.addEventListener('click', ()=> setActiveAll());
      if(activeCategoryIndex===-1) liAll.classList.add('active');
      ul.appendChild(liAll);
      
      // 其余分类（按产品数量降序）
      const sortedCategories = sortCategoriesByProductCountDescending(categories);
      sortedCategories.forEach((c, idx)=>{
        const li = document.createElement('li'); 
        li.className='category-item';
        const displayName = (CATEGORY_SHORT_NAMES && CATEGORY_SHORT_NAMES[c.name]) ? CATEGORY_SHORT_NAMES[c.name] : c.name;
        li.innerHTML = `<div class="label">${displayName}</div><div class="badge">${Array.isArray(c.items) ? c.items.length : 0}</div>`;
        li.addEventListener('click', ()=>{ setActiveCategory(idx) });
        if(idx===activeCategoryIndex) li.classList.add('active');
        ul.appendChild(li);
      });
    }

    function setActiveCategory(idx){
      activeCategoryIndex = idx;
      const lis = document.querySelectorAll('.category-item'); 
      lis.forEach((li,i)=>{
        const isAll = li.id==='li-all';
        li.classList.toggle('active', !isAll && (i-1===idx));
      });
      applyFilters(); // 使用新的筛选逻辑
    }
    
    function setActiveAll(){
      activeCategoryIndex = -1;
      const lis = document.querySelectorAll('.category-item'); 
      lis.forEach(li=> li.classList.remove('active'));
      document.getElementById('li-all')?.classList.add('active');
      applyFilters(); // 使用新的筛选逻辑
    }

    // 只加载 .png：使用英文文件名，未命中或加载失败则保持渐变背景
    function loadBannerBackground(bannerEl, name){
      bannerEl.style.background = 'linear-gradient(135deg, #6ea2ff 0%, #46d9a6 100%)';
      const slug = CATEGORY_BANNER_SLUGS[name] || 'others';
      const pngUrl = `./data/banners/${slug}.png`;
      const img = new Image();
      img.onload = ()=>{
        bannerEl.style.background = `linear-gradient(180deg, rgba(0,0,0,0.25), rgba(0,0,0,0.15)), url('${pngUrl}') center/cover no-repeat`;
      };
      img.onerror = ()=>{/* 若不存在 PNG，保持渐变作为兜底 */};
      img.src = pngUrl;
    }

    function setupBackToTop(){
      const content = document.querySelector('.content');
      const sidebarActions = document.getElementById('sidebarActions');
      if(!content || !sidebarActions) return;
      
      const btn = document.createElement('button');
      btn.className = 'backtop-btn';
      btn.textContent = '回到顶部';
      btn.addEventListener('click', ()=> content.scrollTo({top:0, behavior:'smooth'}));
      sidebarActions.appendChild(btn);
      
      content.addEventListener('scroll', ()=>{
        const shouldShow = content.scrollTop > 300;
        sidebarActions.style.display = shouldShow ? 'block' : 'none';
      });
    }

    // 事件监听器设置
    function setupEventListeners() {
      // 全局搜索
      const globalSearch = document.getElementById('globalSearch');
      globalSearch.addEventListener('input', applyFilters);
      
      // 分类搜索
      const categorySearch = document.getElementById('categorySearch');
      categorySearch.addEventListener('input', applyFilters);
      
      // 品牌标签点击
      document.getElementById('brandTabs').addEventListener('click', (e) => {
        const tab = e.target.closest('.brand-tab');
        if (tab) {
          const brandCode = tab.getAttribute('data-brand');
          setActiveBrand(brandCode);
        }
      });
      
      // 展开品牌按钮
      document.getElementById('expandBrands').addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        isExpandedBrands = !isExpandedBrands;
        console.log('展开状态切换:', isExpandedBrands);
        renderBrandTabs();
      });
    }

    // 初始化应用
    async function initApp() {
      try {
        // 并行加载所有数据
        const [productsData, configData, brandData, categoryData] = await Promise.all([
          // 优先从 CloudBase 读取，失败则回退到本地 JSON
          USE_CLOUDBASE ? loadFromCloudBase() : fetch(FETCH_URL).then(r => r.json()),
          fetch(CONFIG_URL).then(r => r.json()).catch(() => ({banner_slugs: {}, short_names: {}})),
          fetch(BRAND_DICTIONARY_URL).then(r => r.json()).catch(() => ({brandDictionary: {brands: []}})),
          fetch(CATEGORY_DICTIONARY_URL).then(r => r.json()).catch(() => ({categoryDictionary: {categories: []}}))
        ]);

        // 设置全局数据
        DATA = productsData;
        CATEGORY_BANNER_SLUGS = configData.banner_slugs || {};
        CATEGORY_SHORT_NAMES = configData.short_names || {};
        BRAND_DICTIONARY = brandData;
        CATEGORY_DICTIONARY = categoryData;

        // 提取品牌并渲染界面
        extractBrands();
        renderCategories(DATA.categories);
        renderBrandTabs();
        setupEventListeners();
        setupBackToTop();
        
        // 初始渲染
        applyFilters();
        
      } catch (error) {
        console.error('初始化失败:', error);
        document.getElementById('emptyState').style.display = 'block';
        document.getElementById('emptyState').textContent = '加载失败，请刷新页面重试。';
      }
    }

    // CloudBase 数据加载
    async function loadFromCloudBase() {
      try {
        const app = cloudbase.init({ env: CLOUDBASE_ENV });
        await app.auth().anonymousAuthProvider().signIn();
        const db = app.database();
        const result = await db.collection('catalog').doc('default').get();
        
        if (result.data && result.data.length > 0) {
          return result.data[0];
        } else {
          throw new Error('CloudBase 数据为空');
        }
      } catch (error) {
        console.warn('CloudBase 加载失败，回退到本地数据:', error);
        return fetch(FETCH_URL).then(r => r.json());
      }
    }

    // 启动应用
    initApp();
  </script>
</body>
</html>
