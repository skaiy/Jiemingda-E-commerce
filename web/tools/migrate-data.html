<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>数据迁移工具 - CloudBase</title>
    <!-- CloudBase Web SDK -->
    <script src="https://static.cloudbase.net/cloudbase-js-sdk/2.17.3/cloudbase.full.js"></script>
    <!-- CloudBase 配置 -->
    <script src="./cloudbase.config.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #eee;
            border-radius: 8px;
        }
        .section h3 {
            margin-top: 0;
            color: #555;
        }
        button {
            background: #ff6b6b;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        button:hover {
            background: #ff5252;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .config-info {
            background: #e9ecef;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .config-info code {
            background: #f8f9fa;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>CloudBase 数据迁移工具</h1>
        
        <div class="config-info">
            <h4>当前配置</h4>
            <p><strong>环境ID:</strong> <code id="envId">加载中...</code></p>
            <p><strong>产品集合:</strong> <code id="productsCollection">加载中...</code></p>
            <p><strong>配置集合:</strong> <code id="configCollection">加载中...</code></p>
        </div>

        <div class="section">
            <h3>1. 初始化 CloudBase</h3>
            <p>首先需要初始化 CloudBase 连接并进行身份验证。</p>
            <button id="initBtn" onclick="initCloudBase()">初始化 CloudBase</button>
            <div id="initStatus"></div>
        </div>

        <div class="section">
            <h3>2. 上传产品数据</h3>
            <p>将本地 products.json 数据上传到云数据库。</p>
            <button id="uploadProductsBtn" onclick="uploadProducts()" disabled>上传产品数据</button>
            <div id="uploadProductsStatus"></div>
        </div>

        <div class="section">
            <h3>3. 上传配置数据</h3>
            <p>将本地 category_config.json 配置上传到云数据库。</p>
            <button id="uploadConfigBtn" onclick="uploadConfig()" disabled>上传配置数据</button>
            <div id="uploadConfigStatus"></div>
        </div>

        <div class="section">
            <h3>4. 验证数据</h3>
            <p>验证上传的数据是否正确。</p>
            <button id="verifyBtn" onclick="verifyData()" disabled>验证数据</button>
            <div id="verifyStatus"></div>
        </div>

        <div class="section">
            <h3>操作日志</h3>
            <div id="log" class="log">等待操作...</div>
            <button onclick="clearLog()">清空日志</button>
        </div>
    </div>

    <script>
        let app = null;
        let db = null;
        const config = window.CLOUDBASE_CONFIG || {};
        
        // 显示配置信息
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('envId').textContent = config.envId || '未配置';
            document.getElementById('productsCollection').textContent = config.database?.productsCollection || 'products';
            document.getElementById('configCollection').textContent = config.database?.configCollection || 'config';
        });

        function log(message, type = 'info') {
            const logEl = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logEl.textContent += `[${timestamp}] ${message}\n`;
            logEl.scrollTop = logEl.scrollHeight;
            console.log(message);
        }

        function showStatus(elementId, message, type = 'info') {
            const el = document.getElementById(elementId);
            el.innerHTML = `<div class="status ${type}">${message}</div>`;
        }

        function clearLog() {
            document.getElementById('log').textContent = '日志已清空...\n';
        }

        async function initCloudBase() {
            try {
                log('开始初始化 CloudBase...');
                
                if (!config.envId) {
                    throw new Error('未找到环境ID配置');
                }

                app = cloudbase.init({ env: config.envId });
                log(`环境ID: ${config.envId}`);

                // 匿名登录
                const auth = app.auth();
                await auth.signInAnonymously();
                log('匿名登录成功');

                // 获取数据库实例
                db = app.database();
                log('数据库实例获取成功');

                showStatus('initStatus', 'CloudBase 初始化成功！', 'success');
                
                // 启用其他按钮
                document.getElementById('uploadProductsBtn').disabled = false;
                document.getElementById('uploadConfigBtn').disabled = false;
                document.getElementById('verifyBtn').disabled = false;
                
            } catch (error) {
                log(`初始化失败: ${error.message}`, 'error');
                showStatus('initStatus', `初始化失败: ${error.message}`, 'error');
            }
        }

        async function uploadProducts() {
            try {
                log('开始上传产品数据...');
                
                // 加载本地产品数据
                const response = await fetch('./data/products.json');
                if (!response.ok) {
                    throw new Error('无法加载本地产品数据');
                }
                const productsData = await response.json();
                log(`加载本地产品数据成功，包含 ${productsData.categories?.length || 0} 个分类`);

                // 准备上传的数据
                const uploadData = {
                    _id: config.database?.catalogDocId || 'catalog-data',
                    ...productsData,
                    updatedAt: new Date(),
                    version: '1.0.0',
                    source: 'migration-tool'
                };

                // 上传到集合
                const collectionName = config.database?.productsCollection || 'products';
                await db.collection(collectionName).doc(uploadData._id).set(uploadData);
                
                log('产品数据上传成功');
                showStatus('uploadProductsStatus', '产品数据上传成功！', 'success');
                
            } catch (error) {
                log(`产品数据上传失败: ${error.message}`, 'error');
                showStatus('uploadProductsStatus', `上传失败: ${error.message}`, 'error');
            }
        }

        async function uploadConfig() {
            try {
                log('开始上传配置数据...');
                
                // 加载本地配置数据
                const response = await fetch('./data/category_config.json');
                if (!response.ok) {
                    throw new Error('无法加载本地配置数据');
                }
                const configData = await response.json();
                log('加载本地配置数据成功');

                // 准备上传的数据
                const uploadData = {
                    _id: config.database?.configDocId || 'category-config',
                    ...configData,
                    updatedAt: new Date(),
                    version: '1.0.0',
                    source: 'migration-tool'
                };

                // 上传到集合
                const collectionName = config.database?.configCollection || 'config';
                await db.collection(collectionName).doc(uploadData._id).set(uploadData);
                
                log('配置数据上传成功');
                showStatus('uploadConfigStatus', '配置数据上传成功！', 'success');
                
            } catch (error) {
                log(`配置数据上传失败: ${error.message}`, 'error');
                showStatus('uploadConfigStatus', `上传失败: ${error.message}`, 'error');
            }
        }

        async function verifyData() {
            try {
                log('开始验证数据...');
                
                // 验证产品数据
                const productsCollection = config.database?.productsCollection || 'products';
                const catalogDocId = config.database?.catalogDocId || 'catalog-data';
                const productsDoc = await db.collection(productsCollection).doc(catalogDocId).get();
                
                if (productsDoc.data) {
                    const categoriesCount = productsDoc.data.categories?.length || 0;
                    const totalProducts = productsDoc.data.categories?.reduce((sum, cat) => sum + (cat.items?.length || 0), 0) || 0;
                    log(`产品数据验证成功: ${categoriesCount} 个分类，${totalProducts} 个商品`);
                } else {
                    throw new Error('产品数据不存在');
                }

                // 验证配置数据
                const configCollection = config.database?.configCollection || 'config';
                const configDocId = config.database?.configDocId || 'category-config';
                const configDoc = await db.collection(configCollection).doc(configDocId).get();
                
                if (configDoc.data) {
                    let bannerCount, shortNameCount;
                    
                    // 支持新的categories数组结构
                    if (configDoc.data.categories && Array.isArray(configDoc.data.categories)) {
                        bannerCount = configDoc.data.categories.length;
                        shortNameCount = configDoc.data.categories.length;
                        log(`配置数据验证成功: ${bannerCount} 个分类配置`);
                    } else {
                        // 兼容旧格式
                        bannerCount = Object.keys(configDoc.data.banner_slugs || {}).length;
                        shortNameCount = Object.keys(configDoc.data.short_names || {}).length;
                        log(`配置数据验证成功: ${bannerCount} 个横幅配置，${shortNameCount} 个短名称配置`);
                    }
                } else {
                    throw new Error('配置数据不存在');
                }

                showStatus('verifyStatus', '数据验证成功！所有数据已正确上传到云数据库。', 'success');
                log('数据验证完成，迁移成功！');
                
            } catch (error) {
                log(`数据验证失败: ${error.message}`, 'error');
                showStatus('verifyStatus', `验证失败: ${error.message}`, 'error');
            }
        }
    </script>
</body>
</html>